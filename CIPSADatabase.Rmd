---
title: "CIPSA: Compilation of Invasive Plant Species Abundance in the USA"
author: "Lais Petri"
date: "12/20/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
    df_print: paged
editor_options: 
  chunk_output_type: console
---

This code was adapted from Helen's code when assembling the database for the NCEAS sub-groups to use. 

```{r packages and working directory, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
theme_set(theme_classic())
# setwd('/home/shares/neon-inv/data_paper')
```

# Desired columns for FULL Database
Columns to carry forward in combined dataset

```{r}
DesiredColumns <- c("Dataset", "Site", 
                    "Plot", "OriginalPlot", "Long", "Lat", "Original.Long", "Original.Lat",
                    "Year", "SpCode", "AcceptedSpeciesName", "OriginalSpeciesName", 
                    "NativeStatus", "PctCov", "FuzzedCoord", "SampledArea", 
                    "Duration", "Growth.Habit" 
                    )

```

# Individual datasets
## NEON ##
Imports the file
```{r}
NEON <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/NEONdata_flatted20210810.csv")
glimpse(NEON) 
```

Data wrangling and column selection
```{r}
NEON <- NEON %>%
  mutate(FuzzedCoord = "N",
         # those are sites in which diversity and vegetation structure data are from different years
         year = ifelse(siteID == "ABBY" | siteID == "SJER" | siteID == "WREF", 2017, year),
         OriginalPlot = as.character(plotID),
         Original.Long = decimalLongitude,
         Original.Lat = decimalLatitude) %>%
  rename(Dataset = dataset,
         Site = siteID,
         Plot = plotID,
         Year = year,
         AcceptedSpeciesName = bestname,
         SpCode = Accepted.Symbol,
         Long = decimalLongitude,
         Lat = decimalLatitude,
         NativeStatus = Native.Status,
         PctCov = plotCover,
         OriginalSpeciesName = scientificName,
         SampledArea = SampledArea) %>%
  select(one_of(DesiredColumns), 
         #next line of code carries whether cover of a particular species in a plot was based on basal areas and/or canopy cover (sum)
         # if 0 in both, it came from the 1m2 plots
         # NEONvst_status = if a plot should have veg structure data, but it was not collected yet
         contains("NEON", ignore.case = FALSE))

setdiff(DesiredColumns, names(NEON))
setdiff(names(NEON), DesiredColumns)
glimpse(NEON)
```

## FIA ##
Imports the file
```{r}
FIA <- read_csv("/home/shares/neon-inv/data_paper/data_by_dataset/archived/FIA Veg data 12-21-21.csv") #ALL data including repeated samples (3207 plots)
glimpse(FIA)
FIA <- FIA %>% 
  mutate(Zone = case_when(LAT > 50 ~ "AK",
                          LAT < 50 & LAT > 19 & LON > -130 ~ "L48",
                          LON < -150 & LAT < 25 ~ "HI",
                          LAT < 20 & LON < -65 & LON > -70 ~ "PR",
                          TRUE ~ "MissingCoords"),
         NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, NA))) %>% 
  select(-X1)
```

Fixes taxonomy - species codes with missing native status
```{r}
#distinct species codes with no NativeStatus by Zone
FIA2 <- FIA %>% 
  filter(is.na(NativeStatus)) %>% 
  select(VEG_SPCD, Zone, NativeStatus) %>% 
  distinct()
glimpse(FIA2)
```

* full species list from USDA that Ian extracted the info from their website
```{r}
# organizing Ian's taxonomy

tax<-read.csv('/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/usc.csv', as.is=T)
tax$inv_PR<-NA
tax$inv_PR[grep(pattern="PR.I.", x=tax$Native.Status)]<-"I"
tax$inv_PR[grep(pattern="PR.N.", x=tax$Native.Status)]<-"N"
tax$inv_PR[grep(pattern="PR.NI.", x=tax$Native.Status)]<-"NI"

tax$inv_HI<-NA
tax$inv_HI[grep(pattern="HI.I.", x=tax$Native.Status)]<-"I"
tax$inv_HI[grep(pattern="HI.N.", x=tax$Native.Status)]<-"N"
tax$inv_HI[grep(pattern="HI.NI.", x=tax$Native.Status)]<-"NI"

tax$inv_L48<-NA
tax$inv_L48[grep(pattern="L48.I.", x=tax$Native.Status)]<-"I"
tax$inv_L48[grep(pattern="L48.N.", x=tax$Native.Status)]<-"N"
tax$inv_L48[grep(pattern="L48.NI.", x=tax$Native.Status)]<-"NI"

tax$inv_AK<-NA
tax$inv_AK[grep(pattern="AK.I.", x=tax$Native.Status)]<-"I"
tax$inv_AK[grep(pattern="AK.N.", x=tax$Native.Status)]<-"N"
tax$inv_AK[grep(pattern="AK.NI.", x=tax$Native.Status)]<-"NI"

tax <- tax %>% 
  separate(Scientific.Name, c("genus", "epithet"), remove = F) %>% 
  mutate(Accepted.Symbol2 = Accepted.Symbol)
```

* getting the missing info from it
```{r}
# only unique accepted symbols

tax_accep <- tax %>% 
  mutate_all(na_if,"") %>% 
  filter(is.na(Synonym.Symbol))

FIA2 <- FIA2 %>% 
  left_join(tax_accep, by = c("VEG_SPCD" = "Accepted.Symbol")) %>% 
  mutate(NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, 
                                      ifelse(Zone == "PR", inv_PR, NA))))
# sub-setting the fixed ones
FIA2_fixed <- FIA2 %>% 
  filter(!is.na(Scientific.Name)) %>% 
  rename(bestname = Scientific.Name) %>% 
  select(VEG_SPCD, Zone, NativeStatus, bestname, genus, epithet, Duration, Growth.Habit, Accepted.Symbol2)

# fixing the ones with Synonyms
FIA3 <- FIA2 %>% 
  filter(is.na(Scientific.Name)) %>% 
  select(VEG_SPCD, Zone, NativeStatus) %>% 
  left_join(select(tax, c("Symbol", "Accepted.Symbol")), by = c("VEG_SPCD" = "Symbol")) %>% 
  left_join(tax_accep, by = c("Accepted.Symbol" = "Accepted.Symbol")) %>% 
  mutate(NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, 
                                      ifelse(Zone == "PR", inv_PR, NA)))) %>% 
  rename(bestname = Scientific.Name) %>% 
  select(VEG_SPCD, Zone, NativeStatus, bestname, genus, epithet, Duration, Growth.Habit, Accepted.Symbol2)

# getting the entire list of missing codes again (722 species codes)
FIA_missingcodes <- rbind(FIA2_fixed, FIA3)
  
```

* imports the file we manually changed species native status
```{r}
# importing the taxonomy we manually changed
status <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/multStatusSpL48.csv")
head(status)

status <- status %>%
  select(SpCode, L48status = `FINAL DECISION (L48)`) %>%
  filter(!is.na(SpCode))
anyDuplicated(status$SpCode)
```

* fixes the missing native status and make sure the ones we changed manually are also fixed
```{r}
# fixing the missing native status codes

FIA_final <- FIA %>% 
  left_join(FIA_missingcodes, by = c("VEG_SPCD", "Zone")) %>% 
  mutate(NativeStatus = ifelse(is.na(NativeStatus.x), NativeStatus.y, NativeStatus.x),
         bestname = ifelse(is.na(NativeStatus.x), bestname.y, bestname.x),
         genus = ifelse(is.na(NativeStatus.x), genus.y, genus.x),
         epithet = ifelse(is.na(NativeStatus.x), epithet.y, epithet.x),
         Duration = ifelse(is.na(NativeStatus.x), Duration.y, Duration.x),
         Growth.Habit = ifelse(is.na(NativeStatus.x), Growth.Habit.y, Growth.Habit.x),
         VEG_SPCD = ifelse(is.na(NativeStatus.x), Accepted.Symbol2, VEG_SPCD)) %>% 
  select(-NativeStatus.x, -NativeStatus.y, -bestname.x, -bestname.y, -genus.x, -genus.y, 
         -epithet.x, -epithet.y, -Duration.x, -Duration.y, -Growth.Habit.x, -Growth.Habit.y,
         -inv_L48, -inv_AK, -Accepted.Symbol2) %>%
  left_join(status, by = c("VEG_SPCD"="SpCode")) %>%
  mutate(NativeStatus = ifelse(Zone == "L48" & !is.na(L48status), L48status, NativeStatus)) %>%
  select(-L48status)

# write.csv(FIA_final, "data_by_dataset/FIA Veg data 01-05-22.csv", row.names = F)

```


Merges the new plotID to the FIA data
```{r}
# finding the number of plots that were resampled
Resample <- aggregate(INVYR ~ PLOT+STATECD+LAT+LON, data=unique(FIA_final[c("PLOT","INVYR", "STATECD", "LAT", "LON")]), FUN=length)
Resample <- Resample [order(Resample$INVYR, decreasing = TRUE), ]
## creates a file with unique plotIDs for FIA data
Resample <- Resample %>% 
  mutate(NewPlot = paste0("FIA_", 1:nrow(Resample))) %>%
  select(-INVYR)

#merging the new plotID to the FIA database
FIA_final <- FIA_final %>% 
  left_join(Resample, by = c("PLOT", "STATECD", "LAT", "LON"))
```

Data wrangling and column selection
```{r}
FIA <- FIA_final %>%
  mutate(FuzzedCoord = "Y",
         OriginalPlot = as.character(PLT_CN),
         Original.Lat = LAT,
         Original.Long = LON) %>%
  rename(Site = PLOT,
         Plot = NewPlot,
         SpCode = VEG_SPCD, 
         PctCov = PctCover,
         Long = LON,
         Lat = LAT,
         Year = INVYR,
         SampledArea = PlotArea,
         AcceptedSpeciesName = bestname,
         OriginalSpeciesName = SciName) %>%
  mutate(Dataset = "FIA",
         Site = as.character(Site),
         Plot = as.character(Plot)) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(FIA))
setdiff(names(FIA), DesiredColumns)
glimpse(FIA)
```

## AIM ##
Imports the file
```{r warning=FALSE}
AIM <- read_csv("/home/shares/neon-inv/data_paper/data_by_dataset/AIM_AllSpTax_LP_20Aug2021.csv") 
glimpse(AIM)
```

Making sure plotID is unique to plots with the same coordinate across years
```{r}
renamedPlotIDAIM <- AIM %>% select(PLOTKEY,NAD83.X,NAD83.Y, VisitYear) %>% group_by(NAD83.X,NAD83.Y) %>% distinct() %>%
  add_tally() %>% select(-VisitYear) %>% filter(n >1) %>% distinct() %>% mutate(NewPlotID = paste0("AIM_", cur_group_id()))
```

Data wrangling and column selection
```{r}
AIM <- AIM  %>%
  left_join(renamedPlotIDAIM, by = c("PLOTKEY", "NAD83.X", "NAD83.Y")) %>%
  # convert from proportion to percent cover:
  mutate(PctCov = 100*prop.cover,
         FuzzedCoord = "N",
         Site = NA,
         SampledArea = ifelse(DataSet == "BLM_LMF", 2000, 10000),
         Dataset = "AIM",
         OriginalPlot = as.character(PLOTKEY),
         Plot = ifelse(is.na(NewPlotID), PLOTKEY, NewPlotID),
         Original.Lat = NAD83.Y,
         Original.Long = NAD83.X) %>%
  rename(Long = NAD83.X,
         Lat = NAD83.Y,
         Year = VisitYear, 
         SpCode = code,
         NativeStatus = inv_L48,
         AcceptedSpeciesName = bestname,
         OriginalSpeciesName = OriginalName) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(AIM))
setdiff(names(AIM), DesiredColumns)
glimpse(AIM)
```

## NPS ##
Imports the file
```{r}
NPS <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/NPS_DataPaper_27July2021.csv", 
                na = c('', 'NA'))
glimpse(NPS)
```

Data wrangling and column selection
```{r}
NPS <- NPS %>%
  mutate(OriginalPlot = as.character(Plot),
         Year = ifelse(UniqueID =="ASIS_2", 1995, Year),
         Original.Lat = Lat,
         Original.Long = Long) %>% 
  select(-Plot) %>%
  rename(NativeStatus = Exotic,
         SpCode = Species,
         PctCov = Pct_Cov,
         SampledArea =  Area_sampled,
         Plot = UniqueID,
         FuzzedCoord = RealCoords,
         AcceptedSpeciesName = bestname,
         OriginalSpeciesName = OriginalName,
         Growth.Habit = GrowthForm) %>%
  select(one_of(DesiredColumns)) %>%
  mutate(SampledArea = as.double(SampledArea))

setdiff(DesiredColumns, names(NPS))
setdiff(names(NPS), DesiredColumns)
glimpse(NPS)
```

## CVS & WVNHP ##
Imports the file
```{r}
VEGBANK <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/All_VegBank_KPEACH_EB_LP_reduced.csv", 
                    na = c('', 'NA')) # this data includes repeated samples
glimpse(VEGBANK)
```

Updated information on plot area for WVNHP
```{r}
WVplotArea <- read_excel("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_WVNHP/WVplotArea.xlsx") %>% 
  rename(UniqueID = `Plot Code`, 
         PlotArea = `Plot Area`) %>% 
  distinct()
```

Plots to be removed from CVS as they are present in VNHP dataset
```{r}
PlotsRemoveVegBank <- c("094-01-0032", "094-01-0053", "094-01-0056")
```

Data wrangling and column selection
```{r}
VEGBANK <- VEGBANK %>% 
  left_join(select(WVplotArea, UniqueID, PlotArea), by="UniqueID") %>% 
  #extracting the first letters from the plotID to use as site info for WVNHP
  mutate(Site = ifelse(Dataset == "NCVS_WV", gsub("\\..*", "", UniqueID), NA),
         SampledArea = ifelse(Dataset == "NCVS_WV", PlotArea, Taxon.Observation.Area),
         SampledArea = ifelse(Dataset == "NCVS_WV" & SampledArea == 0, NA, SampledArea),
         OriginalPlot = ifelse(grepl("VEGBANK", Dataset), VegBankUniqueID, as.character(UniqueID))) %>%
  #line below removes the 3 plots that have the same information in VNHP dataset
  filter(!VegBankUniqueID %in% PlotsRemoveVegBank) %>% 
  rename(Plot = UniqueID,
         Original.Lat = Lat,
         Original.Long = Long,
         AcceptedSpeciesName = bestname,
         OriginalSpeciesName = OriginalName,
         NativeStatus = ExoticStatus,
         Growth.Habit = GrowthForm) %>%
  mutate(Lat = ifelse(Dataset=="NCVS_WV", round(Original.Lat, 1), Public.Latitude),
         Long = ifelse(Dataset=="NCVS_WV", round(Original.Long, 1), Public.Longitude),
         Dataset = ifelse(grepl("VEGBANK", Dataset), "CVS", "WVNHP"),
         FuzzedCoord = "Y",
         Year = ifelse(Year==2064, 1964,
                       ifelse(Year==2063, 1963, Year))) %>% 
  dplyr::select(one_of(DesiredColumns))
setdiff(DesiredColumns, names(VEGBANK))
setdiff(names(VEGBANK), DesiredColumns)
glimpse(VEGBANK)
```


## VANHP ##
Imports the file
```{r}
VNHP <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/VANHP_datapaper_06_16_21_EB.csv", 
                    na = c('', 'NA')) 
glimpse(VNHP)
```

Data wrangling and column selection
```{r}
VNHP <- VNHP %>%
  mutate(FuzzedCoord = "Y", 
         Site = "NA",
         Original.Long = Long,
         Original.Lat = Lat,
         Long = round(Long, 1),
         Lat = round(Lat, 1),
         OriginalPlot = as.character(Plot),
         Dataset = "VNHP") %>%
  rename(OriginalSpeciesName = VASpeciesName,
         AcceptedSpeciesName = bestname,
         SampledArea = Plot.Size, 
         NativeStatus = ExoticStatus) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(VNHP))
setdiff(names(VNHP), DesiredColumns)
glimpse(VNHP)
```

## NWCA ##
Imports the file
```{r}
NWCA <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/NWCA2011-2016_12232021.csv", 
                  na = c('', 'NA')) 
glimpse(NWCA)
```

Data wrangling and column selection
```{r}
NWCA <- NWCA %>%
  mutate(FuzzedCoord = "N",
         Dataset = "NWCA",
         OriginalPlot = as.character(PLOT),
         Original.Lat = Lat,
         Original.Long = Long) %>%
  rename(Site = SITE_ID,
         Plot = UniquePlotID,
         OriginalSpeciesName = OriginalName,
         AcceptedSpeciesName = bestname,
         SampledArea = PlotArea_m2,
         NativeStatus = inv_L48,
         SpCode = Accepted.Symbol,
         PctCov = COVER) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(NWCA))
setdiff(names(NWCA), DesiredColumns)
glimpse(NWCA)
```

## IL_CTAP ##
Imports the file
```{r}
IL_CTAP <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/IL_CTAP_DataPaper01072022.csv", 
                 na = c('', 'NA')) 
glimpse(IL_CTAP)
```

Data wrangling and column selection
```{r}
IL_CTAP <- IL_CTAP %>%
  mutate(FuzzedCoord = "Y",
         Original.Lat = Lat,
         Original.Long = Long,
         Lat = round(Lat, 2),
         Long = round(Long, 2),
         OriginalPlot = as.character(Transect)) %>%
  rename(Site = SiteID,
         AcceptedSpeciesName = bestname,
         NativeStatus = inv_L48,
         SpCode = Accepted.Symbol,
         Year = PYear) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(IL_CTAP))
setdiff(names(IL_CTAP), DesiredColumns)
glimpse(IL_CTAP)
```


# Join
```{r}
DataBase <- bind_rows(AIM, NPS, FIA, NEON, VEGBANK, VNHP, NWCA, IL_CTAP)
glimpse(DataBase)

DataBase %>% select(Plot) %>% distinct() %>% nrow()
```

# Update native status to be consistent

## Creating a "Zone" Column
```{r}
DataBase <- DataBase %>%
  mutate(Zone = case_when(Lat > 50 ~ "AK",
                          Lat < 50 & Lat > 19 & Long > -130 ~ "L48",
                          Long < -150 & Lat < 25 ~ "HI",
                          Lat < 20 & Long < -65 & Long > -70 ~ "PR",
                          TRUE ~ "MissingCoords")) 

DataBase %>%
  select(Dataset, Site, Plot, Zone) %>%
  distinct() %>%
  count(Zone) #number of plots per zone 

DataBase %>%
  filter(Zone == "MissingCoords",
         !is.na(Long),
         !is.na(Lat)) %>%
  nrow() # yes, all missing coords 
table(DataBase$Zone) #missing coordinates = 185102 records

DataBase %>%
  filter(Zone == "PR") %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset)
```

## Fix taxonomy errors and inconsistencies

* get all the unique species codes by zone
```{r}
#distinct species codes with no NativeStatus by Zone
DataBaseCodes <- DataBase %>% 
  select(SpCode, Zone) %>% 
  distinct() %>% 
  filter(#spp codes that Kristen created to the unmatched species from CVS
         !str_detect(SpCode, "NOMATCH"))
glimpse(DataBaseCodes)

```

* getting native status and needed columns
*important:* SpCode will be changed to Accepted.Symbol from USDA for all datasets. This is because some datasets (for instance, AIM) kept its original SpCode, but others updated to the Accepted. Symbol from Ian's taxonomy table. As I cannot retrieve this info, I'm making it consistent 
*important2:* I'll use the Scientific.Name species column from USDA. In case there are synonyms, I will use the species from the Accepted.Symbol of that species.
```{r}
# only unique accepted symbols

tax <- tax %>% mutate(Accepted.Symbol2 = Accepted.Symbol)

tax_accep <- tax %>% 
  mutate_all(na_if,"") %>% 
  filter(is.na(Synonym.Symbol)) %>% 
  select(-Symbol, -Synonym.Symbol, -Native.Status, -genus, -epithet, -Family) 
  
DataBaseCodes <- DataBaseCodes %>% 
  left_join(tax_accep, by = c("SpCode" = "Accepted.Symbol")) %>% 
  mutate(NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, 
                                      ifelse(Zone == "PR", inv_PR, 
                                      ifelse(Zone == "HI", inv_HI, 
                                      ifelse(Zone == "MissingCoords", inv_L48, NA))))))

# sub-setting the fixed ones (19608)
DataBaseCodes_fixed <- DataBaseCodes %>% 
  filter(!is.na(Scientific.Name)) %>% 
  rename(AcceptedSpeciesName = Scientific.Name) %>% 
  select(SpCode, Zone, NativeStatus, AcceptedSpeciesName, Duration, Growth.Habit, Accepted.Symbol2)


# fixing the ones with Synonyms (2141)
DataBaseCodes2 <- DataBaseCodes %>% 
  filter(is.na(Scientific.Name)) %>% 
  select(SpCode, Zone) %>% 
  left_join(select(tax, c("Symbol", "Accepted.Symbol")), by = c("SpCode" = "Symbol")) %>% 
  distinct() %>% 
  left_join(tax_accep, by = c("Accepted.Symbol" = "Accepted.Symbol")) %>% 
  mutate(NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, 
                                      ifelse(Zone == "PR", inv_PR, 
                                      ifelse(Zone == "HI", inv_HI, 
                                      ifelse(Zone == "MissingCoords", inv_L48, NA)))))) %>% 
  rename(AcceptedSpeciesName = Scientific.Name) %>% 
  select(SpCode, Zone, NativeStatus, AcceptedSpeciesName, Duration, Growth.Habit, Accepted.Symbol2)


# getting the entire list of missing codes again (21749 species codes)
nrow(DataBaseCodes_fixed) + nrow(DataBaseCodes2)
DataBaseALLCodes <- rbind(DataBaseCodes_fixed, DataBaseCodes2)

```


```{r}
# file with manually changed native status
status <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/multStatusSpL48.csv")
head(status)

status <- status %>%
  select(SpCode, L48status = `FINAL DECISION (L48)`) %>%
  filter(!is.na(SpCode))
anyDuplicated(status$SpCode)

DataBase <- DataBase %>%
  left_join(DataBaseALLCodes, by = c("SpCode", "Zone")) %>% 
  #removes SpCode that came with the datasets 
  select(-SpCode, -NativeStatus.x, -AcceptedSpeciesName.x, -Duration.x, -Growth.Habit.x) %>% 
  rename(SpCode = Accepted.Symbol2,
         NativeStatus = NativeStatus.y,
         AcceptedSpeciesName = AcceptedSpeciesName.y,
         Duration = Duration.y,
         Growth.Habit = Growth.Habit.y) %>% 
  left_join(status) %>%
  mutate(NativeStatus = ifelse(Zone == "L48" & !is.na(L48status), L48status, 
                        ifelse(Zone == "MissingCoords" & !is.na(L48status), L48status, NativeStatus))) %>%
  select(-L48status)
```

Checking whether there are sSpecies with multiple exotic status: NONE!
```{r}
DataBase %>%
  group_by(Zone, SpCode, AcceptedSpeciesName) %>%
  summarize(nStatus = n_distinct(NativeStatus)) %>%
  filter(nStatus > 1)
```

```{r eval=FALSE, include=FALSE}
# old code to fix taxonomic errors, but I fixed above only using USDA tax table from Ian
# DataBase <- DataBase %>%
#   mutate(AcceptedSpeciesName = recode(AcceptedSpeciesName, 
#                            "Pyrrocoma uniflora var. uniflora" = "Pyrrocoma uniflora",
#                            "Antennaria rosea ssp. confinis" = "Antennaria rosea",
#                            "Notholithocarpus densiflorus" = "Lithocarpus densiflorus"))

# DataBase <- DataBase %>%
#   mutate(NativeStatus = ifelse(SpCode == "RHYNC3" & Zone == "L48",
#                                "NI",
#                                NativeStatus),
#          NativeStatus = ifelse(SpCode == "FIMBR" & Zone == "L48",
#                                "NI",
#                                NativeStatus),
#          # based on USDA plants:
#          NativeStatus = ifelse(SpCode == "ACMI2" & Zone == "AK",
#                                "N",
#                                NativeStatus))
# 
# 
# 
# ###  FIX species with multiple exotic status  ####
# # By zone
# DataBase.fill <- DataBase %>%
#   group_by(SpCode, AcceptedSpeciesName, Zone) %>%
#   fill(NativeStatus, .direction = "downup") 
# 
# # Creates a summarized table in which identifies whether a species code has 
# # more than a particular "bestname", "NativeStatus" attributed to it.
# # I see inconsistencies when adding the VEGBANK data. 
# countFilled <- DataBase.fill %>%
#   group_by(SpCode) %>%
#   # non-numeric variables:
#   summarise(across(one_of("AcceptedSpeciesName", "NativeStatus"), 
#                    ~ n_distinct(.x[!is.na(.x)]))) %>%
#   filter(AcceptedSpeciesName>1) # filter species codes with more than one matching bestname
# head(countFilled)
# 
# IanTaxonomy <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/taxonomy_temp10_revised.csv")
# 
# IanTaxonomy <- IanTaxonomy %>%
#   select(Accepted.Symbol, bestname) %>%
#   filter(Accepted.Symbol %in% countFilled$SpCode) %>%
#   distinct() %>%
#   group_by(Accepted.Symbol) %>%
#   add_tally() %>%
#   rename(SpCode = Accepted.Symbol)
# 
# #it seems that even Ian's taxonomy has multiple species bestname for a particular code. 
# #So here, I filtered the species codes that had a single match for bestname (and I couldn't figure out why
# #they were different across datasets) and redefined their bestname. The remaining species codes, that
# #have more than one bestname, I am going to manually modify based on the USDA accepted name on 08/20/2021 and 10/28/2021
# DataBase.fill <- DataBase.fill %>%
#   left_join(IanTaxonomy %>% filter(n == 1)) %>%
#   mutate(AcceptedSpeciesName = ifelse(!is.na(bestname), bestname, AcceptedSpeciesName)) %>%
#   select(-bestname, -n)
# glimpse(DataBase.fill)
# 
# #checking again
# #now it's better, only 49 species codes have multiple bestname
# countFilled <- DataBase.fill %>%
#   group_by(SpCode) %>%
#   # non-numeric variables:
#   summarise(across(one_of("AcceptedSpeciesName", "NativeStatus"), 
#                    ~ n_distinct(.x[!is.na(.x)]))) %>%
#   filter(AcceptedSpeciesName>1) # filter species codes with more than one matching bestname
# head(countFilled)
#  
# ## species codes with different bestname associated to them
# ## Not really using this dataframe for anything in the code, just to help me check the inconsistencies
# UnmatchData <- DataBase.fill %>% 
#   ungroup() %>%
#   filter(SpCode %in% countFilled$SpCode) %>%
#   select(Dataset, SpCode, AcceptedSpeciesName, NativeStatus) %>%
#   distinct()
# 
# #manually modify based on the USDA accepted name on 08/20/2021 and 10/28/2021
# DataBase.fill <- DataBase.fill %>%
#   mutate(SpCode = ifelse(SpCode == "7-Feb", "FEBR7", SpCode),
#     AcceptedSpeciesName = ifelse(SpCode == "ACFL", "Acer floridanum",
#                     ifelse(SpCode == "ANGLP", "Andropogon glomeratus var. pumilus",
#                     ifelse(SpCode == "ANGYS", "Andropogon gyrans var. stenophyllus",
#                     ifelse(SpCode == "ANMI3", "Antennaria microphylla",
#                     ifelse(SpCode == "ARLAB", "Arabis laevigata var. burkii",
#                     ifelse(SpCode == "ARLUI2", "Artemisia ludoviciana ssp. incompta",
#                     ifelse(SpCode == "ASTUR", "Asclepias tuberosa ssp. rolfsii",
#                     ifelse(SpCode == "BOON", "Botrychium oneidense",
#                     ifelse(SpCode == "BRAR5", "Bromus arvensis",
#                     ifelse(SpCode == "CACAD2", "Carex canescens ssp. disjuncta",
#                     ifelse(SpCode == "CEPU10", "Celtis pumila",
#                     ifelse(SpCode == "CLHA", "Cleome hassleriana",
#                     ifelse(SpCode == "CRMIE", "Croton michauxii var. ellipticus",
#                     ifelse(SpCode == "DRGO3", "Dryopteris goldieana",
#                            ifelse(SpCode == "ELMI2", "Eleocharis microcarpa",
#                            ifelse(SpCode == "ELPAP", "Eleocharis palustris var. palustris",
#                            ifelse(SpCode == "ERHIH2", "Erechtites hieraciifolius var. hieraciifolius",
#                            ifelse(SpCode == "EUATA2", "Euonymus atropurpureus var. atropurpureus",
#                            ifelse(SpCode == "EUMAM4", "Eutrochium maculatum var. maculatum",
#                            ifelse(SpCode == "EURE18", "Eubotrys recurvus",
#                            ifelse(SpCode == "FEBR7", "Festuca brevipila",
#                            ifelse(SpCode == "HASU3", "Hasteola suaveolens",
#                            ifelse(SpCode == "HEAMH2", "Heuchera americana var. hispida",
#                            ifelse(SpCode == "KYGR", "Kyllinga gracillima",
#                            ifelse(SpCode == "LEFR5", "Lespedeza frutescens",
#                            ifelse(SpCode == "LIPUM2", "Liatris punctata var. mucronata",
#                            ifelse(SpCode == "MEOF", "Melilotus officinalis",
#                            ifelse(SpCode == "MOFIB", "Monarda fistulosa var. brevis",
#                                   ifelse(SpCode == "NEAR5", "Nekemias arborea",
#                                   ifelse(SpCode == "OEFRT", "Oenothera fruticosa ssp. tetragona",
#                                   ifelse(SpCode == "OSAM", "Osmanthus americanus",
#                                   ifelse(SpCode == "PAPSP2", "Packera pseudaurea var. pseudaurea",
#                                   ifelse(SpCode == "PARI4", "Panicum rigidulum",
#                                   ifelse(SpCode == "PARIE2", "Panicum rigidulum var. elongatum",
#                                   ifelse(SpCode == "PHLA13", "Phlox latifolia",
#                                   ifelse(SpCode == "PIASA", "Pityopsis aspera var. adenolepis",
#                                   ifelse(SpCode == "PIGRT", "Pityopsis graminifolia var. tenuifolia",
#                                   ifelse(SpCode == "PIMI", "Piptatheropsis micrantha",
#                                   ifelse(SpCode == "PLAQ2", "Platanthera aquilonis",
#                                   ifelse(SpCode == "POAR21", "Poa arnowiae",
#                                   ifelse(SpCode == "RHMAV", "Rhexia mariana var. ventricosa",
#                                          ifelse(SpCode == "RUSAM", "Rumex salicifolius var. mexicanus",
#                                          ifelse(SpCode == "RUTRR", "Rudbeckia triloba var. rupestris",
#                                          ifelse(SpCode == "SACA19", "Saxifraga careyana",
#                                          ifelse(SpCode == "SOPUP", "Solidago puberula var. pulverulenta",
#                                          ifelse(SpCode == "VEHY", "Veratrum hybridum",
#                                          ifelse(SpCode == "VIBE5", "Viola ×bernardii",
#                                          ifelse(SpCode == "VIES3", "Viola ×esculenta",
#                                          ifelse(SpCode == "ZILE", "Zigadenus leimanthoides",
#                                          AcceptedSpeciesName))))))))))))))))))))))))))))))))))))))))))))))))))
# 
# ## it seems to have a limit on how many ifelse we can have in a mutate, that's why I broke it down here.
# DataBase.fill <- DataBase.fill %>%
#   mutate(AcceptedSpeciesName = ifelse(SpCode == "DIACA", "Dichanthelium acuminatum", AcceptedSpeciesName))
# 
# # checking if the code worked:
# countFilled <- DataBase.fill %>%
#   group_by(SpCode) %>%
#   # non-numeric variables:
#   summarise(across(one_of("AcceptedSpeciesName", "NativeStatus"), 
#                    ~ n_distinct(.x[!is.na(.x)])),
#             # round the numeric ones:
#             #across(SLA:StemSpecificDensity, ~ n_distinct(round(.x[!is.na(.x)], 4)))
#   ) %>%
#   filter(AcceptedSpeciesName>1) # filter species codes with more than one matching bestname
# head(countFilled)
# nrow(countFilled) # the issues were fixed!
# 
# ##fixing an error on code FEBR7 that came as 7-Feb before
# DataBase.fill <- DataBase.fill %>%
#   mutate(NativeStatus = ifelse(SpCode == "FEBR7" & is.na(NativeStatus), "I", NativeStatus))
# 
# ##  Update few species/genera following suggestion from Jeff Corbin:
# DataBase.fill %>%
#   filter(SpCode %in% c("CASTI", "POLYG4", "RUMEX", "PLANT", "ELMA7")) %>%
#   select(SpCode, AcceptedSpeciesName, NativeStatus, Zone) %>%
#   distinct() %>%
#   arrange(SpCode)
# 
# DataBase.fill <- DataBase.fill %>%
#   mutate(NativeStatus = ifelse(SpCode == "CASTI",
#                                "I",
#                                NativeStatus),
#          NativeStatus = ifelse(SpCode == "ELMA7", "N", NativeStatus),
#          NativeStatus = ifelse(SpCode == "PLANT", "NI", NativeStatus),
#          NativeStatus = ifelse(SpCode == "POLYG4" & Zone != "AK",
#                                "NI", NativeStatus),
#          NativeStatus = ifelse(SpCode == "RUMEX" & Zone != "AK", 
#                                "NI", NativeStatus))
# 
# 
# ## Modifying the Native Status for Puerto Rico species to NA
# 
# DataBase.fill <- DataBase.fill %>%
#   mutate(NativeStatus = ifelse(Zone == "PR",
#                                NA,
#                                NativeStatus))
# ```
# 
# ### Finding species with real missing status
# ```{r eval=FALSE, include=FALSE}
# 
# tax <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/taxonomy_temp10_revised.csv")
# tax <- tax %>%
#   select(Accepted.Symbol, Scientific.Name, bestname, inv_L48, inv_AK, inv_HI, FIA_Code) 
# glimpse(tax)
# taxcodes <- tax %>% select(Accepted.Symbol) %>% distinct()
# taxcodes <- taxcodes$Accepted.Symbol
# 
# "%ni%" <- Negate("%in%")
# 
# MissingStatusAll <- DataBase.fill %>% 
#   select(Dataset, SpCode, NativeStatus, AcceptedSpeciesName, OriginalSpeciesName, Zone) %>% 
#   filter(is.na(NativeStatus)) %>% 
#   distinct() %>% 
#   glimpse()
# 
# MissingStatusPR <- MissingStatusAll %>% 
#   filter(Zone == "PR") %>% 
#   glimpse()
# 
# MissingStatusl48HIAKknown <- MissingStatusAll %>% 
#   filter(Zone != "PR") %>% 
#   glimpse()
# 
# MissingStatusl48HIAK <- MissingStatusl48HIAKknown %>% 
#   filter(!SpCode %in% taxcodes,
#          Zone != "MissingCoords",
#          #spp codes that Kristen created to the unmatched species from CVS
#          !str_detect(SpCode, "NOMATCH")) %>% 
#   # select(-Dataset) %>% 
#   distinct() %>% 
#   glimpse()
# 
# sppcodes <- read_csv("/home/shares/neon-inv/output_files/USDA_Plants_ScientificNames.csv")
# head(sppcodes) 
# sppcodes <- sppcodes %>% filter(is.na(Synonym.Symbol)) %>% select(-Synonym.Symbol) %>% glimpse()
# 
# #checking whether the USDA list only has unique symbol for "Accepted.Symbol"
# sppcodes %>% 
#   select(Accepted.Symbol) %>% 
#   group_by(Accepted.Symbol) %>% 
#   add_tally() %>% 
#   arrange(desc(n))
# 
# sppcodes2 <- read_csv("/home/shares/neon-inv/output_files/USDA_Plants_ScientificNames.csv")
# head(sppcodes2) 
# sppcodes2 <- sppcodes2 %>% filter(!is.na(Synonym.Symbol)) %>% select(-Accepted.Symbol) %>% glimpse()
# 
# #checking whether the USDA list only has unique symbol for "Accepted.Symbol"
# sppcodes2 %>% 
#   select(Synonym.Symbol) %>% 
#   group_by(Synonym.Symbol) %>% 
#   add_tally() %>% 
#   arrange(desc(n))
# 
# #joins PR and all other missing status species
# RealMissing <- rbind(MissingStatusl48HIAK, MissingStatusPR)
# glimpse(RealMissing)
# 
# RealMissing <- RealMissing %>%  left_join(sppcodes, by = c("SpCode" = "Accepted.Symbol")) %>% 
#   mutate(AcceptedSpeciesName = ifelse(is.na(AcceptedSpeciesName), Scientific.Name, AcceptedSpeciesName)) %>% 
#   select(-Scientific.Name) %>% left_join(sppcodes2, by = c("SpCode" = "Synonym.Symbol")) %>%
#   mutate(AcceptedSpeciesName = ifelse(is.na(AcceptedSpeciesName), Scientific.Name, AcceptedSpeciesName)) %>%
#   select(-Scientific.Name) %>% 
#   filter(!is.na(AcceptedSpeciesName)) %>% 
#   select(-Dataset, -OriginalSpeciesName, -NativeStatus) %>% 
#   distinct() %>% 
#   group_by(SpCode) %>% 
#   add_tally() %>% 
#   arrange(desc(n)) %>% 
#   spread(Zone, n) %>% 
#   write.csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/MissingNativeStatus.csv", row.names = F)
# 
# UniqueSpCodesRealMissing <- unique(RealMissing$SpCode)

```


# Checking missing data for Year column
```{r}
####checking missing data for Year column####
DataBase %>% 
  filter(is.na(Year)) %>% 
  nrow() # missing Year = 65368 records 

table(DataBase$Year) # checks the range of years

DataBase%>%
  filter(Year == 1195) %>%
  select(Dataset, Plot) %>%
  distinct() # ASIS_2 --> FIXED!

DataBase%>%
  filter(Year == 2063) %>%
  select(Dataset, Plot) %>%
  distinct() # ROBI.XX = 10 plots --> FIXED!

DataBase%>%
  filter(Year == 2064) %>%
  select(Dataset, Plot) %>%
  distinct() # ROBI.XX = 24 plots --> FIXED!
```

#  Check that all datasets are percent cover, not proportion
```{r}

DataBase %>%
  group_by(Dataset) %>%
  summarize(min = min(PctCov, na.rm = TRUE),
            mean = mean(PctCov, na.rm = TRUE),
            max = max(PctCov, na.rm = TRUE)) 

# why are there any rows with NA cover
DataBase %>%
  ungroup() %>%
  filter(is.na(PctCov)) %>%
  select(Site, Plot) %>%
  distinct()

DataBase %>% 
  filter(Plot == "FIA_1976", #OriginalPlot number == 24023611010478
         !is.na(PctCov)) # all NA for this plot
#all others belong to NWCA dataset. The plots have only one or a few species that there was no cover recorded, 
#although the species were recorded. for example
DataBase %>%
  filter(Plot == "NWCA_1",
         !is.na(PctCov)) # there are other species with cover recorded

# I am keeping NWCA plots with some missing cover (LAIS)

# drop this FIA plot with all NAs for cover
DataBase <- DataBase %>%
  filter(OriginalPlot != "24023611010478")

DataBase %>%
  filter(is.na(PctCov)) %>%
  nrow()

## sampled area has some weird values (-40 (Fixed), and 0 (from NPS, substituting info for NA))
DataBase %>% 
  ungroup() %>% 
  select(Dataset, SampledArea, Plot) %>% 
  distinct() %>% 
  filter(SampledArea <= 0) %>% 
  group_by(Dataset, SampledArea) %>% 
  count(Plot) %>%
  nrow()
## 38 plots from NPS with zeros.

# substitutes SampledArea of zero per NA (38plots from NPS)
DataBase <- DataBase %>% 
  mutate(SampledArea = ifelse(SampledArea == 0, NA, SampledArea))
```

# Creating the FULL Database
```{r}
FULLDatabase <- DataBase %>%
  select(one_of(DesiredColumns))
glimpse(FULLDatabase)
```

## Exporting the FULL Database
```{r eval=FALSE, include=FALSE}
write_rds(FULLDatabase, "/home/shares/neon-inv/data_paper/final_data/FULLDatabase_01072022.rds")
write_csv(FULLDatabase, "/home/shares/neon-inv/data_paper/final_data/FULLDatabase_01072022.csv")
```

# Creating CIPSA Database
## Desired columns for CIPSA Database
Columns to carry forward in combined CIPSA dataset
```{r}
DesiredColumns2 <- c("Dataset", "Site", 
                    "Plot", "OriginalPlot", "Long", "Lat",
                    "Year", "SpCode", "AcceptedSpeciesName", "OriginalSpeciesName", 
                    "NativeStatus", "Duration", "Growth.Habit",
                    "PctCov", "FuzzedCoord", "SampledArea", "Zone" 
                    )

```


### Selecting columns and dealing with plots with rare species
```{r}
# removes species names and codes but keep them in the plot

AIMALLrarespp <- read_excel("code_by_dataset/extra_csv_AIM/FINAL_National_SSS_List_November_21_2019.xlsx", sheet = "Update_2019_FINAL")
glimpse(AIMALLrarespp) 

# Select necessary columns for the filtering
AIMALLrarespp <- AIMALLrarespp %>% 
  select(Taxon, 
         ScientificName = `Scientific Name`, 
         ScientificNameSynonym = `Scientific Name Synonym`, 
         ListingStatus = `Listing Status`) 

AIMALLraresppSyn <- AIMALLrarespp %>% 
  select(ScientificNameSynonym) %>% 
  drop_na()

# How many rare species in AIM?
AIMrarespp <- DataBase %>%
  filter(Dataset == "AIM") %>%
  select(SpCode, AcceptedSpeciesName, OriginalSpeciesName) %>%
  filter(AcceptedSpeciesName %in% AIMALLrarespp$ScientificName) %>% 
  distinct()
glimpse(AIMrarespp)

AIMrarespp2 <- DataBase %>%
  filter(Dataset == "AIM") %>%
  select(SpCode, AcceptedSpeciesName, OriginalSpeciesName) %>%
  filter(AcceptedSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym) %>% 
  distinct()
glimpse(AIMrarespp2)

AIMrarespp3 <- DataBase %>%
  filter(Dataset == "AIM") %>%
  select(SpCode, AcceptedSpeciesName, OriginalSpeciesName) %>%
  filter(OriginalSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym) %>% 
  distinct()
glimpse(AIMrarespp3)

AIMrarespp4 <- DataBase %>%
  filter(Dataset == "AIM") %>%
  select(SpCode, AcceptedSpeciesName, OriginalSpeciesName) %>%
  filter(OriginalSpeciesName %in% AIMALLrarespp$ScientificName) %>% 
  distinct()
glimpse(AIMrarespp4)

finalsAIMrareSpp <- AIMrarespp %>% 
  rbind(AIMrarespp2, AIMrarespp3, AIMrarespp4) %>% 
  distinct() %>% 
  filter(!is.na(SpCode))
glimpse(finalsAIMrareSpp)
## total of 217 endangered/rare species in the AIM database

# so I get the number of plots with at least one of those rare species
AIMplotsrarespp <- DataBase %>%
    filter(Dataset == "AIM") %>%
    group_by(Plot) %>%
    filter(any(SpCode %in% finalsAIMrareSpp$SpCode)) 
length(table(AIMplotsrarespp$Plot)) #6293

## WVNHP rare species list
WVNHPRareSpecies <- read_excel("code_by_dataset/extra_csv_WVNHP/WVNHPRareSpecies.xlsx")
glimpse(WVNHPRareSpecies)
WVNHPRareSpecies<-WVNHPRareSpecies$OriginalSpeciesName

## VANHP rare species list
VNHPRareSpecies <- read_excel("code_by_dataset/extra_csv_VNHP/VAspeciestoexclude.xlsx")
glimpse(VNHPRareSpecies)

#Filtering out rare species
CIPSADatabase <- DataBase %>% 
  #replaces the species original and accepted names, and species codes for NAs
  mutate(OriginalSpeciesName1 = replace(OriginalSpeciesName, Dataset=="AIM" & OriginalSpeciesName %in% AIMALLrarespp$ScientificName |
                                          Dataset=="AIM" & AcceptedSpeciesName %in% AIMALLrarespp$ScientificName, NA),
         SpCode = replace(SpCode, Dataset=="AIM" & OriginalSpeciesName %in% AIMALLrarespp$ScientificName |
                                          Dataset=="AIM" & AcceptedSpeciesName %in% AIMALLrarespp$ScientificName, NA),
         AcceptedSpeciesName1 = replace(AcceptedSpeciesName, Dataset=="AIM" & OriginalSpeciesName %in% AIMALLrarespp$ScientificName |
                                          Dataset=="AIM" & AcceptedSpeciesName %in% AIMALLrarespp$ScientificName, NA),
         OriginalSpeciesName1 = replace(OriginalSpeciesName1, Dataset=="AIM" & OriginalSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym |
                                          Dataset=="AIM" & AcceptedSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym, NA),
         SpCode = replace(SpCode, Dataset=="AIM" & OriginalSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym |
                                          Dataset=="AIM" & AcceptedSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym, NA),
         AcceptedSpeciesName1 = replace(AcceptedSpeciesName1, Dataset=="AIM" & OriginalSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym |
                                          Dataset=="AIM" & AcceptedSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym, NA)) %>% 
  mutate(OriginalSpeciesName1 = replace(OriginalSpeciesName1, Dataset=="WVNHP" & OriginalSpeciesName %in% WVNHPRareSpecies |  Dataset=="WVNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies, NA),
         SpCode = replace(SpCode, Dataset=="WVNHP" & OriginalSpeciesName %in% WVNHPRareSpecies |  Dataset=="WVNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies, NA),
         AcceptedSpeciesName1 = replace(AcceptedSpeciesName1, Dataset=="WVNHP" & OriginalSpeciesName %in% WVNHPRareSpecies |  Dataset=="WVNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies, NA)) %>%
  mutate(OriginalSpeciesName1 = replace(OriginalSpeciesName1, Dataset=="VNHP" & OriginalSpeciesName %in% WVNHPRareSpecies |  
                                          Dataset=="VNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies, NA),
         SpCode = replace(SpCode, Dataset=="VNHP" & OriginalSpeciesName %in% WVNHPRareSpecies |  
                            Dataset=="VNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies, NA),
         AcceptedSpeciesName1 = replace(AcceptedSpeciesName1, Dataset=="VNHP" & OriginalSpeciesName %in% WVNHPRareSpecies | 
                                          Dataset=="VNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies, NA),
          OriginalSpeciesName1 = replace(OriginalSpeciesName1, Dataset=="VNHP" & OriginalSpeciesName %in% VNHPRareSpecies$SPECIES |  
                                          Dataset=="VNHP" & AcceptedSpeciesName %in% VNHPRareSpecies$SPECIES, NA),
         SpCode = replace(SpCode, Dataset=="VNHP" & OriginalSpeciesName %in% VNHPRareSpecies$SPECIES |  
                            Dataset=="VNHP" & AcceptedSpeciesName %in% VNHPRareSpecies$SPECIES, NA),
         AcceptedSpeciesName1 = replace(AcceptedSpeciesName1, Dataset=="VNHP" & OriginalSpeciesName %in% VNHPRareSpecies$SPECIES | 
                                          Dataset=="VNHP" & AcceptedSpeciesName %in% VNHPRareSpecies$SPECIES, NA)) %>%
  
  select(-OriginalSpeciesName, -AcceptedSpeciesName) %>%
  rename(OriginalSpeciesName = OriginalSpeciesName1,
  AcceptedSpeciesName = AcceptedSpeciesName1) %>%
  dplyr::select(one_of(DesiredColumns2))

# checking if it worked
## AIM
CIPSADatabase %>% 
  filter(Dataset=="AIM" & AcceptedSpeciesName %in% AIMALLrarespp$ScientificName) %>% 
  count(AcceptedSpeciesName)

CIPSADatabase %>% 
  filter(Dataset=="AIM" & AcceptedSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym) %>% 
count(AcceptedSpeciesName)

CIPSADatabase %>% 
  filter(Dataset=="AIM" & OriginalSpeciesName %in% AIMALLraresppSyn$ScientificNameSynonym) %>% 
  count(OriginalSpeciesName) 

CIPSADatabase %>% 
  filter(Dataset=="AIM" & OriginalSpeciesName %in% AIMALLrarespp$ScientificName) %>% 
  count(OriginalSpeciesName)

## WVNHP
CIPSADatabase %>% 
  filter(Dataset=="WVNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies)
CIPSADatabase %>% 
  filter(Dataset=="WVNHP" & OriginalSpeciesName %in% WVNHPRareSpecies)

## VNHP
CIPSADatabase %>% 
  filter(Dataset=="VNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies) %>% 
count(AcceptedSpeciesName)
CIPSADatabase %>% 
  filter(Dataset=="VNHP" & OriginalSpeciesName %in% WVNHPRareSpecies) %>% 
  count(OriginalSpeciesName) 
CIPSADatabase %>% 
  filter(Dataset=="VNHP" & AcceptedSpeciesName %in% VNHPRareSpecies$SPECIES) %>% 
count(AcceptedSpeciesName)
CIPSADatabase %>% 
  filter(Dataset=="VNHP" & OriginalSpeciesName %in% VNHPRareSpecies$SPECIES) %>% 
  count(OriginalSpeciesName) 

# All worked!!!
```

Creating a final list of Rare Species handled in the DataBase
```{r}
# creating a final list of species removed per dataset
## fixing VNHP
VNHPRareSpecies2 <- VNHPRareSpecies %>% 
  select(SPECIES) %>% 
  left_join(select(tax, Accepted.Symbol, Scientific.Name), by=c("SPECIES"="Scientific.Name")) %>% 
  mutate(OriginalSpeciesName = SPECIES,
         Dataset = "VNHP") %>% 
  rename(AcceptedSpeciesName = SPECIES,
         SpCode = Accepted.Symbol) %>% 
  mutate(AcceptedSpeciesName = ifelse(OriginalSpeciesName == "Boechera serotina", "Arabis serotina", AcceptedSpeciesName),
         SpCode = ifelse(OriginalSpeciesName == "Boechera serotina", "ARSE9", SpCode),
         AcceptedSpeciesName = ifelse(OriginalSpeciesName == "Phemeranthus piedmontanus", NA, AcceptedSpeciesName))
## fixing WVNHP
WVNHPRareSpecies2 <- FULLDatabase %>% 
  filter(Dataset=="WVNHP" & AcceptedSpeciesName %in% WVNHPRareSpecies, 
  Dataset=="WVNHP" & OriginalSpeciesName %in% WVNHPRareSpecies) %>% 
  select(Dataset, SpCode, AcceptedSpeciesName, OriginalSpeciesName) %>% 
  distinct()
  
# FINAL
ListRareSpecies <- finalsAIMrareSpp %>% 
  mutate(Dataset = "AIM") %>% 
  rbind(VNHPRareSpecies2, WVNHPRareSpecies2) %>% 
  select(Dataset, everything()) 

# write.csv(ListRareSpecies, "final_data/ListRareSpecies_01072022.csv", row.names = F)
```


```{r eval=FALSE, include=FALSE}
#Old code, leaving here in case we need
# CIPSADatabase <- DataBase.fill %>% 
  # group_by(OriginalPlot) %>%
  # filter(is.na(OriginalSpeciesName)| # code to keep the plot with NA in the original species name column
  #          !any(OriginalSpeciesName == "Arabis serotina Steele" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Ptilimnium nodosumRose Mathias" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Scirpus ancistrochaetus Schuyler" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Trifolium stoloniferum Muhl. ex Eat." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Isotria medeoloidesPursh Raf." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Spiraea virginiana Britt." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Cypripedium parviflorum Salisb. var. pubescensWilld. Knight" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Cypripedium parviflorum Salisb." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Cypripedium reginae Walt." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Panax quinquefolius" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Hydrastis canadensis" & Dataset == "WVNHP")) %>%
  # ungroup() 


glimpse(CIPSADatabase)
```

### Exporting the CIPSA Database
```{r eval=FALSE, include=FALSE}
write_rds(CIPSADatabase, "/home/shares/neon-inv/data_paper/final_data/CIPSADatabase_01072022.rds")
write_csv(CIPSADatabase, "/home/shares/neon-inv/data_paper/final_data/CIPSADatabase_01072022.csv")
```

#### Exporting the CIPSA Database but AIM data only
```{r eval=FALSE, include=FALSE}

CIPSADatabase_AIM <- CIPSADatabase %>% filter(Dataset == "AIM")

write_rds(CIPSADatabase_AIM, "/home/shares/neon-inv/data_paper/final_data/CIPSADatabase_AIM_01062022.rds")
write_csv(CIPSADatabase_AIM, "/home/shares/neon-inv/data_paper/final_data/CIPSADatabase_AIM_01062022.csv")
```

# **Summaries**
## Number of records
```{r}
# number of records #
dim(CIPSADatabase) 

CIPSADatabase %>%
  ungroup() %>%
  filter(Zone!="MissingCoords", # no coordinates
         !is.na(Year)) %>% # no year
  nrow() 

#number of records per database
CIPSADatabase %>%
  ungroup() %>%
  count(Dataset) %>%
  mutate(status = "All",
         pct = round((n/sum(n))*100,2))
```

## Plot summaries
```{r}
# number of plots #
CIPSADatabase %>%
  ungroup() %>%
  select(Plot) %>%
  distinct() %>%
  nrow() 

# number of invaded plots #
CIPSADatabase %>%
  ungroup() %>%
  filter(NativeStatus=="I") %>%
  select(Plot) %>%
  distinct() %>%
  nrow() 

# number of plots  per Dataset#
CIPSADatabase %>%
  ungroup() %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  mutate(status = "All",
         pct = round((n/sum(n))*100,2))

```

```{r echo=FALSE}
x<-CIPSADatabase %>%
  ungroup() %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  mutate(status = "All",
         pct = round((n/sum(n))*100,2))
ggplot(x, aes(x=Dataset, y=n, fill=Dataset)) +
  geom_bar(stat="identity", width=1) +
 # coord_polar("y", start=0)+ 
  scale_fill_viridis_d(option="B") +
  theme_minimal() +
  ylab("number of plots per dataset") + 
  theme(axis.title.x = element_blank()) + 
  theme(legend.position = "none")
```

```{r}
# number of invaded plots per dataset#
CIPSADatabase %>%
  ungroup() %>%
  filter(NativeStatus=="I") %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  rename(invaded = n)
```

```{r echo=FALSE}
# number of invaded plots per dataset#
y<-CIPSADatabase %>%
  ungroup() %>%
  filter(NativeStatus=="I") %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  rename(invaded = n)
xx<-x %>%
  left_join(y) %>%
  mutate(uninvaded = n-invaded) %>%
  select(-n, -status) %>%
  gather("status", "n", 3:4)

ggplot(data=xx, aes(x=Dataset, y=n, fill=status)) +
  geom_bar(stat="identity")+
  geom_col() +
  # geom_text(aes(label=n),vjust=-0.3, size=3.5) +
  theme_bw()+
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(breaks=seq(0,27000,5000)) +
  scale_fill_viridis_d(option="B") + theme_minimal() +
  ylab("Number of plots") + theme(axis.title.x = element_blank(),
                                  legend.position = c(0.87, 0.87),
                                  legend.title = element_blank(),
                                  legend.background = element_rect(fill = "white", color = "black",
                                                                   size=0.25),
                                  legend.key.size = unit(0.4, "cm"),
                                  legend.text = element_text(size = 10),
                                  panel.grid = element_blank(),
                                  text=element_text(size=15, color="black"),
                                  legend.spacing.y = unit(0, 'pt'))
ggsave("GraphInvadedPlotsperDataset12202021.png", dpi=300)
```

```{r}
# number of plots outside L48 #
CIPSADatabase %>%
  ungroup() %>%
  filter(Zone!="L48",
         Zone!="MissingCoords") %>% 
  select(Plot) %>%
  distinct() %>%
  nrow() #530 plots (~0.70% of the total)

CIPSADatabase %>%
  ungroup() %>%
  filter(Zone!="L48",
         Zone!="MissingCoords") %>% # 
  select(Dataset,Plot) %>%
  distinct() %>%
  count(Dataset)
```

## Species and Native status summaries
```{r}
#number of species##
CIPSADatabase %>%
  ungroup() %>%
    select(SpCode) %>%
  distinct() %>%
  nrow()

#number of species per exotic status##
CIPSADatabase %>%
  ungroup() %>%
  select(SpCode, NativeStatus) %>%
  distinct() %>%
  count(NativeStatus) 

#species with NA exotic status per Dataset#
CIPSADatabase %>%
  ungroup() %>%
  select(Dataset, SpCode, NativeStatus) %>%
  filter(is.na(NativeStatus)) %>% # no year
  distinct() %>%
  count(Dataset, NativeStatus) %>%
  arrange(n) 
# number of distinct species with NA per dataset (so, the same species can show up in more than one dataset)

CIPSADatabase %>%
  ungroup() %>%
  select(Dataset, SpCode, NativeStatus) %>%
  distinct() %>%
  count(Dataset, NativeStatus) %>%
  group_by(Dataset) %>%
  mutate(pct = round((n/sum(n))*100,2),
         NativeStatus = ifelse(is.na(NativeStatus), "NA", NativeStatus))
#for VegBank, species with associated NAs for exotic status are around 88% of all species id for VegBank
```


```{r echo=FALSE}
##percent of species exotic status per dataset##
DatasetNA <- CIPSADatabase %>%
  ungroup() %>%
  select(Dataset, SpCode, NativeStatus) %>%
  distinct() %>%
  count(Dataset, NativeStatus) %>%
  group_by(Dataset) %>%
  mutate(pct = round((n/sum(n))*100,2),
         NativeStatus = ifelse(is.na(NativeStatus), "NA", NativeStatus))
#for VegBank, species with associated NAs for exotic status are around 88% of all species id for VegBank

ggplot(data=DatasetNA, aes(x=Dataset, y=pct, fill=NativeStatus)) +
       geom_bar(stat="identity")+
       geom_col() +
       scale_fill_viridis_d(option="B") + theme_minimal() +
  ylab("% of species nativeness status per dataset") + theme(axis.title.x = element_blank(),
                                                         legend.position="bottom")
```


```{r}
## Cover of invasive species per dataset
rangecover<- CIPSADatabase %>%
  group_by(Dataset, NativeStatus) %>%
  summarize(min = min(PctCov, na.rm = TRUE),
            mean = mean(PctCov, na.rm = TRUE),
            max = max(PctCov, na.rm = TRUE))

## Years of data collection ##
table(CIPSADatabase$Year)

y<- CIPSADatabase %>%
  ungroup() %>%
  select(Dataset, Plot, Year) %>%
  distinct() 
dim(y)

## number of resampled plots
x<- CIPSADatabase %>%
  ungroup() %>%
  select(Dataset, Plot, Year) %>%
  distinct() %>%
  group_by(Dataset,Plot) %>% 
  count(Plot, sort = T) %>% 
  filter(n>1) 
dim(x)

```

# **Differences among Datasets**

Defining colors
```{r}
library(viridis)
#finding the color codes to add to the database
viridis_pal(option = "plasma")(9)

AIMc<-"#0D0887FF"
CVSc<-"#4C02A1FF"
FIAc<-"#7E03A8FF"
IL_CTAPc<-"#A92395FF"
NEONc<-"#CC4678FF"
NPSc<-"#E56B5DFF"
NWCAc<-"#F89441FF"
VNHPc<-"#FDC328FF"
WNHPc<-"#F0F921FF"
```

Importing ecoregions level1 (https://www.epa.gov/eco-research/ecoregions-north-america) 
```{r}
library(sf)
# import the vector into R as an sf object
ecoreg1 <- st_read("/home/shares/neon-inv/data_paper/env_code_data/gis_layers/ecoregionlevel1/NA_CEC_Eco_Level1.shp") %>% rename(Ecoregion = NA_L1NAME)
glimpse(ecoreg1)
```


Joining the ecoregion spatial information
```{r}
CIPSADatabaseEco <- CIPSADatabase %>% 
  filter(Zone != "MissingCoords") %>% 
  # getting all data as a sf object
  st_as_sf(coords = c("Long", "Lat"), remove = FALSE, crs = 4326, agr = "constant") %>%
  #sets the same projections
  st_transform(crs = st_crs(ecoreg1)) %>%
  #adds the corresponding ecorregions to each entry
  st_join(ecoreg1) %>%
  #drops the coordinates
  st_drop_geometry()
```

## Graphs - Non-native cover
```{r}
status <- "I"

# All Ecoregions at once
CIPSADatabaseEco %>% filter(NativeStatus == status,
                     !is.na(Ecoregion)) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram() + 
  scale_fill_manual(values=c(AIMc, CVSc, FIAc, IL_CTAPc, NEONc, NPSc, NWCAc, VNHPc, WNHPc)) +
  facet_grid(Ecoregion~Dataset, scales="free_y") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") +
  ggsave('figures/AllEcoregionsNN.png', dpi = 300)

table(CIPSADatabaseEco$Ecoregion)

# EASTERN TEMPERATE FORESTS
graph1<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "EASTERN TEMPERATE FORESTS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(CVSc, FIAc, IL_CTAPc, NEONc, NPSc, NWCAc, VNHPc, WNHPc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Eastern Temperate Forests") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none") +
  ggsave('figures/ecoregionsNN/EasTemFor.png', width = 8, height = 4, dpi = 300)

# GREAT PLAINS
graph2<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "GREAT PLAINS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Great Plains") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank()) +
  ggsave('figures/ecoregionsNN/GrePla.png', width = 8, height = 4, dpi = 300)

# MARINE WEST COAST FOREST
graph3<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "MARINE WEST COAST FOREST"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(FIAc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Marine West Coast Forest") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank()) +
  ggsave('figures/ecoregionsNN/MarWesCoaFor.png', width = 8, height = 4, dpi = 300)

# MEDITERRANEAN CALIFORNIA
graph4<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "MEDITERRANEAN CALIFORNIA"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Mediterranean California") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none") +
  ggsave('figures/ecoregionsNN/MedCal.png', width = 8, height = 4, dpi = 300)

# NORTH AMERICAN DESERTS
graph5<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTH AMERICAN DESERTS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("North American Deserts") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank()) +
  ggsave('figures/ecoregionsNN/NorAmeDes.png', width = 8, height = 4, dpi = 300)

# NORTHERN FORESTS
graph6<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTHERN FORESTS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Northern Forests") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank()) +
  ggsave('figures/ecoregionsNN/NorFor.png', width = 8, height = 4, dpi = 300)


# NORTHWESTERN FORESTED MOUNTAINS
graph7<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTHWESTERN FORESTED MOUNTAINS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Northwestern Forested Mountains") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none") +
  ggsave('figures/ecoregionsNN/NorForMou.png', width = 8, height = 4, dpi = 300)

# SOUTHERN SEMIARID HIGHLANDS
graph8<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "SOUTHERN SEMIARID HIGHLANDS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Southern Semiarid Highlands") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  ggsave('figures/ecoregionsNN/SouSemHig.png', width = 8, height = 4, dpi = 300)

# TAIGA --> only has NEON as dataset and no invasives - it doesn't work

# TEMPERATE SIERRAS
graph9<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "TEMPERATE SIERRAS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Temperate Sierras") + 
  labs(y="Frequency", x = "Non-Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  ggsave('figures/ecoregionsNN/TemSie.png', width = 8, height = 4, dpi = 300)

# TROPICAL WET FORESTS --> only NWCA, no point of showing

# TUNDRA --> only has NEON as dataset and no invasives - it doesn't work


##arranging the graphs
library(cowplot)
all<-plot_grid(graph1, graph2, graph3, graph4, graph5, graph6, graph7, graph8, graph9, 
          # labels = c("A", "B", "C", "D", "F"),
          ncol = 3, nrow = 3,  labels = "AUTO")

png('figures/ecoregionsNN/graphcomginedNN12232021.png', width = 1920,height = 1080)
print(all)
dev.off()

```

## Grphs - Native cover
```{r}
status <- "N"

# All Ecoregions at once
CIPSADatabaseEco %>% filter(NativeStatus == status,
                     !is.na(Ecoregion)) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram() + 
  scale_fill_manual(values=c(AIMc, CVSc, FIAc, IL_CTAPc, NEONc, NPSc, NWCAc, VNHPc, WNHPc)) +
  facet_grid(Ecoregion~Dataset, scales="free_y") + 
  labs(y="Frequency", x = "Native Species Cover (%)") +
  ggsave('figures/AllEcoregionsN.png', dpi = 300)

table(CIPSADatabaseEco$Ecoregion)

# EASTERN TEMPERATE FORESTS
graph1<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "EASTERN TEMPERATE FORESTS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(CVSc, FIAc, IL_CTAPc, NEONc, NPSc, NWCAc, VNHPc, WNHPc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Eastern Temperate Forests") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none") +
  ggsave('figures/ecoregionsN/EasTemFor.png', width = 8, height = 4, dpi = 300)

# GREAT PLAINS
graph2<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "GREAT PLAINS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Great Plains") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank()) +
  ggsave('figures/ecoregionsN/GrePla.png', width = 8, height = 4, dpi = 300)

# MARINE WEST COAST FOREST
graph3<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "MARINE WEST COAST FOREST"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(FIAc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Marine West Coast Forest") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank()) +
  ggsave('figures/ecoregionsN/MarWesCoaFor.png', width = 8, height = 4, dpi = 300)

# MEDITERRANEAN CALIFORNIA
graph4<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "MEDITERRANEAN CALIFORNIA"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Mediterranean California") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none") +
  ggsave('figures/ecoregionsN/MedCal.png', width = 8, height = 4, dpi = 300)

# NORTH AMERICAN DESERTS
graph5<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTH AMERICAN DESERTS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("North American Deserts") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank()) +
  ggsave('figures/ecoregionsN/NorAmeDes.png', width = 8, height = 4, dpi = 300)

# NORTHERN FORESTS
graph6<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTHERN FORESTS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Northern Forests") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank()) +
  ggsave('figures/ecoregionsN/NorFor.png', width = 8, height = 4, dpi = 300)


# NORTHWESTERN FORESTED MOUNTAINS
graph7<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTHWESTERN FORESTED MOUNTAINS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Northwestern Forested Mountains") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none") +
  ggsave('figures/ecoregionsN/NorForMou.png', width = 8, height = 4, dpi = 300)

# SOUTHERN SEMIARID HIGHLANDS
graph8<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "SOUTHERN SEMIARID HIGHLANDS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Southern Semiarid Highlands") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  ggsave('figures/ecoregionsN/SouSemHig.png', width = 8, height = 4, dpi = 300)

# TAIGA --> only has NEON as dataset and no invasives - it doesn't work

# TEMPERATE SIERRAS
graph9<-CIPSADatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "TEMPERATE SIERRAS"
                     ) %>%  
  ggplot(aes(PctCov, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Temperate Sierras") + 
  labs(y="Frequency", x = "Native Species Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  ggsave('figures/ecoregionsN/TemSie.png', width = 8, height = 4, dpi = 300)

# TROPICAL WET FORESTS --> only NWCA, no point of showing

# TUNDRA --> only has NEON as dataset and no invasives - it doesn't work


##arranging the graphs
library(cowplot)
all<-plot_grid(graph1, graph2, graph3, graph4, graph5, graph6, graph7, graph8, graph9, 
          ncol = 3, nrow = 3,  labels = "AUTO")

png('figures/ecoregionsN/graphcomginedN12232021.png', width = 1920,height = 1080)
print(all)
dev.off()

```
