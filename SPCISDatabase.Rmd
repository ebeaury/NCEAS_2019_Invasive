---
title: "SPCIS: Standardized Plant Community with Introduced Status"
author: "Lais Petri"
date: "12/20/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
    df_print: paged
editor_options: 
  chunk_output_type: console
---

This code was adapted from Helen's code when assembling the database for the NCEAS sub-groups to use.

```{r packages and working directory, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse) 
library(lubridate) # when library tidyverse, lubridate is not turning on
library(readxl)
library(inlmisc) #another color blind pallete to get qualitative colors
# detach("package:plyr", unload=TRUE)
theme_set(theme_classic())
# setwd('/home/shares/neon-inv/data_paper')
```

# Desired columns for FULL Database

Columns to carry forward in combined dataset

```{r}
DesiredColumns <- c("Dataset", "Site", "Original.Site",
                    "Plot", "Original.Plot", "Long", "Lat", "Zone",
                    "Original.Long", "Original.Lat", "FuzzedCoord", # not going to SPCIS
                    "Year", "Month", "SpCode", "AcceptedTaxonName", "Original.TaxonName", 
                    "NativeStatus", "PctCov", "PctCov_100",  
                    "Duration", "Growth.Habit", "RecordedStrata", "PlotArea.m2", "SamplingMethod", "Resampled"
                    )

```

# Full species list from USDA that Ian extracted the info from their website

```{r}
# organizing Ian's taxonomy

tax<-read.csv('/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/usc.csv', as.is=T)
#substitute (I,N) per (NI)
tax$Native.Status <- gsub("\\(I,N\\)", "(NI)", tax$Native.Status, ignore.case = FALSE)

tax$inv_PR<-NA
tax$inv_PR[grep(pattern="PR.I.", x=tax$Native.Status)]<-"I"
tax$inv_PR[grep(pattern="PR.N.", x=tax$Native.Status)]<-"N"
tax$inv_PR[grep(pattern="PR.NI.", x=tax$Native.Status)]<-"NI"

tax$inv_HI<-NA
tax$inv_HI[grep(pattern="HI.I.", x=tax$Native.Status)]<-"I"
tax$inv_HI[grep(pattern="HI.N.", x=tax$Native.Status)]<-"N"
tax$inv_HI[grep(pattern="HI.NI.", x=tax$Native.Status)]<-"NI"

tax$inv_L48<-NA
tax$inv_L48[grep(pattern="L48.I.", x=tax$Native.Status)]<-"I"
tax$inv_L48[grep(pattern="L48.N.", x=tax$Native.Status)]<-"N"
tax$inv_L48[grep(pattern="L48.NI.", x=tax$Native.Status)]<-"NI"
tax$inv_L48[grep(pattern="NA.N.", x=tax$Native.Status)]<-"N" # nonvascular plants have the native status defined for North America

tax$inv_AK<-NA
tax$inv_AK[grep(pattern="AK.I.", x=tax$Native.Status)]<-"I"
tax$inv_AK[grep(pattern="AK.N.", x=tax$Native.Status)]<-"N"
tax$inv_AK[grep(pattern="AK.NI.", x=tax$Native.Status)]<-"NI"
tax$inv_AK[grep(pattern="NA.N.", x=tax$Native.Status)]<-"N" # nonvascular plants have the native status defined for North America

tax <- tax %>% 
  separate(Scientific.Name, c("genus", "epithet"), remove = F) %>% 
  mutate(Accepted.Symbol2 = Accepted.Symbol)
```

# Individual datasets

## NEON

Imports the file

```{r}
NEON <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/NEONDataPaperALLCols09122022.csv")
glimpse(NEON) 
```

Retrieving month of data collection
```{r}
NEONmonth <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_NEON/NEONmonth.csv")
glimpse(NEONmonth)
NEONmonth <- NEONmonth %>% group_by(plotID, year) %>% 
  slice(which.max(Month))   # some plots' survey were not completed in a single month, so I am keeping the latest

NEON <- NEON %>% left_join(NEONmonth)
glimpse(NEON)
```


Fixing errors in taxonomy
```{r}
NEONspp <- NEON %>% 
  ## \\s = white space between the word and sp. or spp.
  ## \\. = dot of sp. or spp.
  ## $ = tells its only the ones at the end of the string
  filter(str_detect(scientificName, "\\ssp\\.$") | str_detect(scientificName, "\\sspp\\.$")) %>% 
  filter(str_detect(scientificName, "ceae sp\\.$", negate = T)) %>% 
  filter(str_detect(scientificName, "ceae spp\\.$", negate = T)) %>% 
  select(scientificName) %>% 
  distinct() %>% 
  separate(scientificName, "genus" , remove = F) %>% 
  left_join(tax, by = c("genus" = "Scientific.Name")) %>% 
  filter(Synonym.Symbol != "GAURA" | is.na(Synonym.Symbol)) %>% 
  select(scientificName, Accepted.Symbol, genus, inv_L48, inv_AK, inv_HI, inv_PR) %>%
  mutate_all(na_if,"") %>% 
  rename(Accepted.SymbolNEW = Accepted.Symbol)

NEON <- NEON %>% 
  mutate(Native.Status = ifelse(scientificName == "Unknown plant" | scientificName == "Unknown hardwood plant", NA, Native.Status),
         AccSpeciesName = ifelse(scientificName == "Unknown plant" | scientificName == "Unknown hardwood plant", NA, AccSpeciesName),
        Accepted.Symbol = ifelse(scientificName == "Unknown plant" | scientificName == "Unknown hardwood plant", NA, Accepted.Symbol),
        # Accepted.Symbol = ifelse(str_detect(scientificName, "ceae sp\\."), NA, Accepted.Symbol),
        # Native.Status = ifelse(str_detect(scientificName, "ceae sp\\."), NA, Native.Status),
        # AccSpeciesName = ifelse(str_detect(scientificName, "ceae sp\\."), NA, AccSpeciesName),
        # Accepted.Symbol = ifelse(str_detect(scientificName, "ceae spp\\."), NA, Accepted.Symbol),
        # Native.Status = ifelse(str_detect(scientificName, "ceae spp\\."), NA, Native.Status),
        # AccSpeciesName = ifelse(str_detect(scientificName, "ceae spp\\."), NA, AccSpeciesName)
        ) %>% 
  left_join(NEONspp, by = "scientificName") %>% 
    mutate(Zone = case_when(decimalLatitude > 50 ~ "AK",
                          decimalLatitude < 50 & decimalLatitude > 19 & decimalLongitude > -130 ~ "L48",
                          decimalLongitude < -150 & decimalLatitude < 25 ~ "HI",
                          decimalLatitude < 20 & decimalLongitude < -65 & decimalLongitude > -70 ~ "PR",
                          TRUE ~ "MissingCoords"),
         Native.Status = ifelse(!is.na(Accepted.Symbol) & Zone == "L48", inv_L48,
                          ifelse(!is.na(Accepted.Symbol)& Zone == "AK", inv_AK, 
                            ifelse(!is.na(Accepted.Symbol)& Zone == "PR", inv_PR, 
                              ifelse(!is.na(Accepted.Symbol)& Zone == "HI", inv_HI, Native.Status)))),
         Accepted.Symbol = ifelse(!is.na(Accepted.SymbolNEW), Accepted.SymbolNEW, Accepted.Symbol),
         AccSpeciesName = ifelse(!is.na(genus), genus, AccSpeciesName))  

```

Data wrangling and column selection

```{r}
NEON <- NEON %>%
  mutate(FuzzedCoord = "N",
         # # those are sites in which diversity and vegetation structure data are from different years
         # year = ifelse(siteID == "ABBY" | siteID == "SJER" | siteID == "WREF", 2017, year),
         Original.Plot = as.character(plotID),
         Original.Long = decimalLongitude,
         Original.Lat = decimalLatitude,
         SpCode = ifelse(!is.na(Accepted.Symbol), taxonID2, Accepted.Symbol) ,
         # it's 1 because the %cover is on the mÂ² basis.
         # SampledArea = 1,
         # RecordedStrata = ifelse(vst_status == "div_vst", "Y", "N"),
         # PlotArea.m2 = ifelse(is.na(PlotArea.m2) & siteID == "BLAN", 800,
         #                      ifelse(is.na(PlotArea.m2) & siteID != "BLAN", 400, PlotArea.m2))
         ) %>%
  rename(Dataset = dataset,
         Site = siteID,
         Plot = plotID,
         Year = year,
         AcceptedTaxonName = AccSpeciesName,
         Long = decimalLongitude,
         Lat = decimalLatitude,
         NativeStatus = Native.Status,
         # PctCov = plotCover,
         Original.TaxonName = scientificName) %>%
  select(one_of(DesiredColumns), 
         contains("NEON", ignore.case = FALSE))

setdiff(DesiredColumns, names(NEON))
setdiff(names(NEON), DesiredColumns)
glimpse(NEON)
```

## FIA

Imports the file

```{r}
FIA <- read_csv("/home/shares/neon-inv/data_paper/data_by_dataset/archived/FIA Veg data 12-21-21.csv") #ALL data including repeated samples (3207 plots)
glimpse(FIA)
```

# creates a zone column

```{r}
FIA <- FIA %>% 
  mutate(Zone = case_when(LAT > 50 ~ "AK",
                          LAT < 50 & LAT > 19 & LON > -130 ~ "L48",
                          LON < -150 & LAT < 25 ~ "HI",
                          LAT < 20 & LON < -65 & LON > -70 ~ "PR",
                          TRUE ~ "MissingCoords"),
         NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, NA))) %>% 
  select(-...1)
```

Fixes taxonomy - species codes with missing native status

```{r}
#distinct species codes with no NativeStatus by Zone
FIA2 <- FIA %>% 
  filter(is.na(NativeStatus)) %>% 
  select(VEG_SPCD, Zone, NativeStatus) %>% 
  distinct()
glimpse(FIA2)
```

-   getting the missing info from it

```{r}
# only unique accepted symbols

tax_accep <- tax %>% 
  mutate_all(na_if,"") %>% 
  filter(is.na(Synonym.Symbol))

FIA2 <- FIA2 %>% 
  left_join(tax_accep, by = c("VEG_SPCD" = "Accepted.Symbol")) %>% 
  mutate(NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, 
                                      ifelse(Zone == "PR", inv_PR, NA))))
# sub-setting the fixed ones
FIA2_fixed <- FIA2 %>% 
  filter(!is.na(Scientific.Name)) %>% 
  rename(bestname = Scientific.Name) %>% 
  select(VEG_SPCD, Zone, NativeStatus, bestname, genus, epithet, Duration, Growth.Habit, Accepted.Symbol2)

# fixing the ones with Synonyms
FIA3 <- FIA2 %>% 
  filter(is.na(Scientific.Name)) %>% 
  select(VEG_SPCD, Zone, NativeStatus) %>% 
  left_join(select(tax, c("Symbol", "Accepted.Symbol")), by = c("VEG_SPCD" = "Symbol")) %>% 
  left_join(tax_accep, by = c("Accepted.Symbol" = "Accepted.Symbol")) %>% 
  mutate(NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, 
                                      ifelse(Zone == "PR", inv_PR, NA)))) %>% 
  rename(bestname = Scientific.Name) %>% 
  select(VEG_SPCD, Zone, NativeStatus, bestname, genus, epithet, Duration, Growth.Habit, Accepted.Symbol2)

# getting the entire list of missing codes again (722 species codes)
FIA_missingcodes <- rbind(FIA2_fixed, FIA3)
  
```

-   imports the file we manually changed species native status

```{r}
# importing the taxonomy we manually changed
status <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/multStatusSpL48LP.csv")
head(status)

status <- status %>%
  select(SpCode, L48status = `FINAL DECISION (L48)`) %>%
  filter(!is.na(SpCode))
anyDuplicated(status$SpCode)
```

-   fixes the missing native status and make sure the ones we changed manually are also fixed

```{r}
# fixing the missing native status codes

FIA_final <- FIA %>% 
  left_join(FIA_missingcodes, by = c("VEG_SPCD", "Zone")) %>% 
  mutate(NativeStatus = ifelse(is.na(NativeStatus.x), NativeStatus.y, NativeStatus.x),
         bestname = ifelse(is.na(NativeStatus.x), bestname.y, bestname.x),
         genus = ifelse(is.na(NativeStatus.x), genus.y, genus.x),
         epithet = ifelse(is.na(NativeStatus.x), epithet.y, epithet.x),
         Duration = ifelse(is.na(NativeStatus.x), Duration.y, Duration.x),
         Growth.Habit = ifelse(is.na(NativeStatus.x), Growth.Habit.y, Growth.Habit.x),
         VEG_SPCD = ifelse(is.na(NativeStatus.x) & is.na(VEG_SPCD), Accepted.Symbol2, VEG_SPCD)) %>% 
  select(-NativeStatus.x, -NativeStatus.y, -bestname.x, -bestname.y, -genus.x, -genus.y, 
         -epithet.x, -epithet.y, -Duration.x, -Duration.y, -Growth.Habit.x, -Growth.Habit.y,
         -inv_L48, -inv_AK, -Accepted.Symbol2) %>%
  left_join(status, by = c("VEG_SPCD"="SpCode")) %>%
  mutate(NativeStatus = ifelse(Zone == "L48" & !is.na(L48status), L48status, NativeStatus)) %>%
  select(-L48status)

# write.csv(FIA_final, "data_by_dataset/FIA Veg data 01-18-22.csv", row.names = F)

```

Merges the new plotID to the FIA data

```{r}
# finding the number of plots that were resampled
Resample <- aggregate(INVYR ~ PLOT+STATECD+LAT+LON, data=unique(FIA_final[c("PLOT","INVYR", "STATECD", "LAT", "LON")]), FUN=length)
Resample <- Resample [order(Resample$INVYR, decreasing = TRUE), ]
## creates a file with unique plotIDs for FIA data
Resample <- Resample %>% 
  mutate(NewPlot = paste0("FIA_", 1:nrow(Resample))) %>%
  select(-INVYR)

#merging the new plotID to the FIA database
FIA_final <- FIA_final %>% 
  left_join(Resample, by = c("PLOT", "STATECD", "LAT", "LON"))
```

-   imports all data from FIA (Jeff C sent me on 09122022) so I can retrieve information on "Month" of data collection
```{r}
FIAmonth <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_FIA/PLOT.csv")
glimpse(FIAmonth)

FIAmonth <- FIAmonth %>% 
  select(PLOT, CN, MEASMON) %>% distinct() %>% rename(PLT_CN = CN)

FIA_final <- FIA_final %>% 
  left_join(FIAmonth)

```

Data wrangling and column selection

```{r}
FIA <- FIA_final %>%
  mutate(FuzzedCoord = "Y",
         Original.Plot = as.character(PLT_CN),
         Original.Lat = LAT,
         Original.Long = LON,
         Site = "N") %>%
  rename(Plot = NewPlot,
         SpCode = VEG_SPCD, 
         PctCov = PctCover,
         Long = LON,
         Lat = LAT,
         Year = INVYR,
         Month = MEASMON,
         PlotArea.m2 = PlotArea,
         AcceptedTaxonName = bestname,
         Original.TaxonName = SciName) %>%
  mutate(Dataset = "FIA",
         # Site = as.character(Site),
         Plot = as.character(Plot)) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(FIA))
setdiff(names(FIA), DesiredColumns)
glimpse(FIA)
```

## AIM

Imports the file

```{r warning=FALSE}
AIM <- read_csv("/home/shares/neon-inv/data_paper/data_by_dataset/AIM_AllSpTax_LP_20Aug2021.csv") 
glimpse(AIM)
```

Making sure plotID is unique to plots with the same coordinate across years

```{r}
# table that I have created before on the plots that match coordinates & earlier visits for resampled plots
# I used this one just to manually check my work below
# excludeAIM_11Sept2020 <- read_csv("code_by_dataset/extra_csv_AIM/excludeAIM_11Sept2020.csv")
# glimpse(excludeAIM_11Sept2020)


#find the PLOTKEY in which coordinates are the same and were sampled in the same year
excludePlotIDAIM <- AIM %>% select(PLOTKEY,NAD83.X,NAD83.Y, VisitYear) %>% 
  # code below number of plots with the same coordinate 
  group_by(NAD83.X,NAD83.Y) %>% distinct() %>%
  add_tally() %>% #select(-VisitYear) %>% 
  filter(n >1) %>% distinct() %>% mutate(NewPlotID = paste0("AIM_", cur_group_id())) %>% 
  # removes the data of data collection from the end of the plot key
  mutate(PLOTKEY2 = str_sub(PLOTKEY, end=-11)) %>% 
  # code below number of plots within the same plot key (without the end date in PLOTKEY)
  group_by(PLOTKEY2) %>% 
  add_tally() %>% 
  mutate(discrepancy = ifelse(n == nn, 0, 1)) %>% 
  # code below means that plot keys are different within the same coordinates
  # LP: ok to keep just the ones that don't have the same year of data collection
  filter(discrepancy == 1) %>% 
  # if nnn >1 plot keys are different but they have the same coordinate and have the same year of data collection
  # LP: I think they should be removed, unsure which one to keep
  group_by(NewPlotID, VisitYear) %>% 
  add_tally() %>% 
  filter(nnn == 2)
  # drop earlier visits for resampled plots:
  #filter(!PLOTKEY %in% excludeAIM_11Sept2020$PLOTKEY)

# this code is not working properly
renamedPlotIDAIM <- AIM %>% 
  select(PLOTKEY,NAD83.X,NAD83.Y, VisitYear) %>% 
  filter(!PLOTKEY %in% excludePlotIDAIM$PLOTKEY) %>% 
  group_by(NAD83.X,NAD83.Y) %>% distinct() %>%
  add_tally() %>% 
  select(-VisitYear) %>% 
  filter(n >1) %>% 
  distinct() %>% 
  mutate(NewPlotID = paste0("AIM_", cur_group_id()))

# plots that were resampled within the same year
# keeping the ones that were sampled later in the year (usually Sept)
excludePlotIDAIMSameYear <- c("14031706564266912014-03-01","14041413200089512014-03-01","14031807170092172014-03-01","14031710225831662014-03-01","14031710094842362014-03-01")

```

Site information for TerrADat
```{r}
AIMSiteInfo <- read_xlsx("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_AIM/TerrADat_wSite_20May22.xlsx")
glimpse(AIMSiteInfo)

#there is more than 1 site per plotkey. 
AIMSiteInfo %>% select(PrimaryKey, SiteID) %>%  distinct() %>% group_by(PrimaryKey) %>% add_tally() %>% filter(n>1) %>% arrange(PrimaryKey)

#solution: summarizing to get the first one
AIMSiteInfo <- AIMSiteInfo %>% select(PrimaryKey, SiteID) %>% rename(PLOTKEY=PrimaryKey, Site=SiteID) %>% distinct() %>% group_by(PLOTKEY) %>% dplyr::summarize(Site = dplyr::first(Site)) %>% ungroup %>% filter(!is.na(Site)) 
glimpse(AIMSiteInfo)

```


Data wrangling and column selection

```{r}
AIM <- AIM  %>%
  #site info provided by Patrick Alexander for TerrADat plots
  left_join(AIMSiteInfo, by = "PLOTKEY") %>% 
  filter(!PLOTKEY %in% excludePlotIDAIM$PLOTKEY) %>% 
  filter(!PLOTKEY %in% excludePlotIDAIMSameYear) %>% 
  left_join(renamedPlotIDAIM, by = c("PLOTKEY", "NAD83.X", "NAD83.Y")) %>%
  # convert from proportion to percent cover:
  mutate(PctCov = 100*prop.cover,
         FuzzedCoord = "N",
         PlotArea.m2 = ifelse(DataSet == "BLM_TerrADat", 2827, 10000),
         Dataset = "AIM",
         Original.Plot = as.character(PLOTKEY),
         Plot = ifelse(is.na(NewPlotID), PLOTKEY, NewPlotID),
         Original.Lat = NAD83.Y,
         Original.Long = NAD83.X,
         Site = ifelse(DataSet=="BLM_LMF", "N", Site),
         Month = month(VisitDate)) %>%
  rename(Long = NAD83.X,
         Lat = NAD83.Y,
         Year = VisitYear, 
         SpCode = code,
         NativeStatus = inv_L48,
         AcceptedTaxonName = bestname,
         Original.TaxonName = OriginalName) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(AIM))
setdiff(names(AIM), DesiredColumns)
glimpse(AIM)
```

## NPS

Imports the file

```{r}
NPS <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/NPS_DataPaper_27July2021.csv", 
                na = c('', 'NA'))
glimpse(NPS)
```

Imports file with plots to be excluded (same plots are in VANHP)
```{r}
NPSexclude <- read.csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_NPS/NPS_excludePlots.csv", 
                na = c('', 'NA'))
glimpse(NPSexclude)
```

Retrieving month of data collection

```{r}
# getting unique plots from NPS to compare with the data Eve put together on the date of data collection
NPSplots <- NPS %>% select(UniqueID, Site, Plot, Year) %>% distinct() %>% mutate(Year = ifelse(UniqueID =="ASIS_2", 1995, Year))
glimpse(NPSplots)

# raw data from Eve
NPSdates <- read.csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_NPS/NPSsample_dates.csv", 
                na = c('', 'NA'))
NPSdates <- NPSdates %>% rename(Year = year, Month=month) %>% distinct()
glimpse(NPSdates)

NPSmonth <- NPSplots %>% left_join(NPSdates) 
NPSmonth %>% filter(is.na(Month)) %>% count(Site) # missing date of data collection for 36 sites (not the entire site)
NPSmonth %>% filter(is.na(Month)) %>% count() # 9026 missing information on month
NPSmonthmissing <- NPSmonth %>% filter(is.na(Month))

# sites with years in the raw data Eve sent me that do not make sense
WeirdNPSdates <- NPSdates %>% filter(Year<100)
WeirdNPSdates %>% select(Site) %>%  distinct()

#importing each of those sites and getting the info again
data_extra <- "/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_NPS/NPS_Environmental-data"

BAND <- read_csv(file.path(data_extra, "split_clean_bandplots.csv"))
BAND <- BAND %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

CRLA <- read_csv(file.path(data_extra, "split_clean_ plots_crlaplots.csv"))
CRLA <- CRLA %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

CUVA <- read_csv(file.path(data_extra, "split_clean_cuvaplots.csv"))
CUVA <- CUVA %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

GRCA <- read_csv(file.path(data_extra, "split_clean_grca_paraplots.csv"))
GRCA <- GRCA %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

HALE <- read_csv(file.path(data_extra, "split_clean_haleplots.csv"))
HALE <- HALE %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

ORCA <- read_csv(file.path(data_extra, "split_clean_orca_plots.csv"))
ORCA <- ORCA %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

PETR <- read_csv(file.path(data_extra, "PETRPlots.csv"))
PETR <- PETR %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

REDW <- read_csv(file.path(data_extra, "split_clean_ plots_redwplots.csv"))
REDW <- REDW %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

SAHI <- read_csv(file.path(data_extra, "split_clean_sahiplots.csv"))
SAHI <- SAHI %>% select(Park, Plot, `Survey Date`) %>% rename(Site=Park, Event_Date=`Survey Date`) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

SLBE <- read_csv(file.path(data_extra, "split_clean_slbe_plots.csv"))
SLBE <- SLBE %>% select(Park, Plot, `Survey Date`) %>% rename(Site=Park, Event_Date=`Survey Date`) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

STRI <- read_csv(file.path(data_extra, "split_clean_striplots.csv"))
STRI <- STRI %>% select(Park, Plot, Event_Date) %>% rename(Site=Park) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

VAFO <- read_csv(file.path(data_extra, "split_clean_vafo_plots.csv"))
VAFO <- VAFO %>% select(Park, Plot, `Survey Date`) %>% rename(Site=Park, Event_Date=`Survey Date`) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

ZION <- read_csv(file.path(data_extra, "split_clean_zion_plots.csv"))
ZION <- ZION %>% select(Park, Plot, `Survey Date`) %>% rename(Site=Park, Event_Date=`Survey Date`) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date))

ASIS <- read_csv(file.path(data_extra, "ASISPlots.csv"))
ASIS <- ASIS %>% select(`Plot Code`, `Survey Date`) %>% rename(Event_Date=`Survey Date`) %>% 
  separate(`Plot Code`, c("Site", "Plot")) %>% 
  mutate(Event_Date=as_date(Event_Date, format = "%m/%d/%y"), Month=month(Event_Date), Year=year(Event_Date), day=day(Event_Date), Year=ifelse(Year==2019, 2015, Year)) # not sure why it's changing to 2019

WeirdNPSdatesFixed <- BAND %>% rbind(CRLA) %>% rbind(CUVA) %>% rbind(GRCA) %>% rbind(HALE) %>% rbind(ORCA) %>% rbind(PETR) %>% rbind(REDW) %>% rbind(SAHI) %>% rbind(SLBE) %>% rbind(STRI) %>% rbind(VAFO) %>% rbind(ZION) %>% rbind(ASIS) %>% select(-Event_Date) %>% distinct()

NPSmonth <- NPSmonth %>% left_join(WeirdNPSdatesFixed, by=c("Site","Plot", "Year"))  %>% 
  mutate(day=ifelse(is.na(day.x), day.y, day.x), Month=ifelse(is.na(Month.x), Month.y, Month.x)) %>% 
  select(-day.x, -day.y, -Month.x, -Month.y) 

#checking again for missing data
NPSmonth %>% filter(is.na(Month)) %>% count(Site) # missing date of data collection for 25 sites (not the entire site)
NPSmonth %>% filter(is.na(Month)) %>% count() # 9026 missing information on month
NPSmonthmissing <- NPSmonth %>% filter(is.na(Month))
```

Data wrangling and column selection

```{r}
NPS <- NPS %>%
  #removes plots that are also found in VANHP (NPS plots in Virginia)
  filter(!UniqueID %in% NPSexclude$Plot) %>% 
  mutate(Original.Plot = as.character(Plot),
         Year = ifelse(UniqueID =="ASIS_2", 1995, Year),
         Original.Lat = Lat,
         Original.Long = Long,
         PlotArea.m2 = as.double(Area_sampled),
         FuzzedCoord = ifelse(RealCoords == "Y", "N", "Missing")) %>% 
  select(-Plot) %>%
  left_join(select(NPSmonth, c("UniqueID","Year","Month"))) %>% 
  rename(NativeStatus = Exotic,
         SpCode = Species,
         PctCov = Pct_Cov,
         Plot = UniqueID,
         AcceptedTaxonName = bestname,
         Original.TaxonName = OriginalName,
         Growth.Habit = GrowthForm) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(NPS))
setdiff(names(NPS), DesiredColumns)
glimpse(NPS)
```

## CVS & WVNHP

Imports the file

```{r}
VEGBANK <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/All_VegBank_KPEACH_EB_LP_reduced3.csv", 
                    na = c('', 'NA')) # this data includes repeated samples
glimpse(VEGBANK)
```

Updated information on plot area for WVNHP

```{r}
WVplotArea <- read_excel("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_WVNHP/WVplotArea.xlsx") %>% 
  rename(UniqueID = `Plot Code`, 
         PlotArea = `Plot Area`) %>% 
  distinct()
```

Correction on the coordinates of two plots

```{r}
WVPlotCoord <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_WVNHP/WVNHPPlotVerify (1) JV.csv") %>% 
  select(Original.Plot, Correct.Lat, Correct.Lon) %>% 
  filter(!is.na(Correct.Lon))
```

Plots to be removed from WVNHP because they have partial floristics (who sampled them at that time could have misidentified or missed species)

```{r}
PlotsRemoveWVNHP <- read_csv("/home/shares/neon-inv/raw_VegBank_data/WV_plot_data.csv") %>% 
  select(`Plot Code`, `Vascular data quality`) %>% 
  filter(`Vascular data quality` == "partial") %>% 
  distinct()
```

Plots to be removes from WVNHP because overlap with NWCA

```{r}
PlotsRemoveWVNHP2 <- read_csv("/home/shares/neon-inv/raw_VegBank_data/WV_plot_data.csv") %>% 
  select(`Plot Code`) %>% 
         #remove NWCA plots from WVNHP
  filter(grepl("^NWCA", `Plot Code`)) %>% distinct()
```


Imports data on resampled plots for WVNHP and creates a new plot ID for them

```{r}
PlotsResampleWVNHP <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_WVNHP/WVNHPPlotVerifyLP.csv") %>% 
  filter(resample == 1) %>% 
   mutate(Original.Long = as.character(Original.Long),
         Original.Lat = as.character(Original.Lat)) %>%
  group_by(Original.Long, Original.Lat) %>% 
  mutate(NewPlot = paste0("WVNHP_", cur_group_id())) %>% 
  ungroup() %>% 
  select(Original.Plot, NewPlot)
```

Finding observations that were sampled across strata for WVNHP

```{r}
WVNHPStrata <- read.csv("/home/shares/neon-inv/raw_VegBank_data/WV_species_data.csv") %>% 
  select(Plot.Code, Scientific.Name, Stratum) %>% 
  group_by(Plot.Code, Scientific.Name) %>% 
  add_tally() %>% 
  mutate(RecordedStrata = ifelse(n == 1, "N", "Y")) %>% 
  ungroup() %>% 
  select(-Stratum, -n) %>% 
  distinct()
```

Retrieving WVNHP plot shape
```{r}
# retrieving unique WVNHP plots
WVNHPPlots <- VEGBANK %>% filter(Dataset == "NCVS_WV") %>% distinct(UniqueID)

Plot_info_WV <- read_csv("/home/shares/neon-inv/raw_VegBank_data/WV_plot_data.csv")

Plot_shape_WV <- Plot_info_WV %>%  select(`Plot Code`, `Plot Shape`) %>% distinct() %>% filter(`Plot Code` %in% WVNHPPlots$UniqueID) %>% 
  mutate(`Plot Shape` = ifelse(grepl("circular", `Plot Shape`) | grepl("Circular", `Plot Shape`) , "Circular plot", 
                               ifelse(grepl("rectangular", `Plot Shape`) | grepl("Rectangular", `Plot Shape`) | 
                                        grepl("Rectanglular", `Plot Shape`) | grepl("rect.", `Plot Shape`), "Rectangular plot", 
                                      ifelse(grepl("nested", `Plot Shape`) | grepl("lumped", `Plot Shape`), "Nested plot", 
                                             ifelse(grepl("Square", `Plot Shape`) | grepl("square", `Plot Shape`), "Square plot", 
                                                    ifelse(`Plot Shape` == "Transect", "Transect", "Other shape plot")))))) %>% 
  rename(SamplingMethod = `Plot Shape`, 
         Original.Plot = `Plot Code`)
table(Plot_shape_WV$SamplingMethod)

```

Retrieving Month of data collection for WVNHP
```{r}
# retrieving unique WVNHP plots
MonthWVNHP <- Plot_info_WV %>%  select(`Plot Code`, `Survey Date`) %>% distinct() %>% 
  filter(`Plot Code` %in% WVNHPPlots$UniqueID) %>% 
  rename(Original.Plot = `Plot Code`,
         Month = `Survey Date`) %>% 
  mutate(Month = as.Date(Month, format = "%m/%d/%y"),
         Month = month(Month)) 
table(MonthWVNHP$Month, exclude = NULL)
```


Plots to be removed from CVS as they are present in VNHP dataset

```{r}
PlotsRemoveVegBank <- c("094-01-0032", "094-01-0053", "094-01-0056")
```

Finding resampled plots in CVS database

```{r}
# setting the directory with raw files
shared_data_dir <- "/home/shares/neon-inv"
data_raw <- file.path(shared_data_dir, "raw_VegBank_data")
list.files(data_raw)

# importing all the raw files from Bob Peet 
CVS_plot_data_VAraw <- read_excel(file.path(data_raw, "CVA-VAplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_VA <- CVS_plot_data_VAraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "VA") %>% 
  left_join(select(CVS_plot_data_VAraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))
  

CVS_plot_data_AKraw <- read_excel(file.path(data_raw, "CVS-AKplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_AK <- CVS_plot_data_AKraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "AK") %>% 
  left_join(select(CVS_plot_data_AKraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_ALraw <- read_excel(file.path(data_raw, "CVS-ALplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_AL <- CVS_plot_data_ALraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "AL") %>% 
  left_join(select(CVS_plot_data_ALraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_FLraw <- read_excel(file.path(data_raw, "CVS-FLplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL) ) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_FL <- CVS_plot_data_FLraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "FL") %>% 
  left_join(select(CVS_plot_data_FLraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_GAraw <- read_excel(file.path(data_raw, "CVS-GAplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_GA <- CVS_plot_data_GAraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "GA") %>% 
  left_join(select(CVS_plot_data_GAraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_MSraw <- read_excel(file.path(data_raw, "CVS-MSplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_MS <- CVS_plot_data_MSraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "MS") %>% 
  left_join(select(CVS_plot_data_MSraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_NCCoastalraw <- read_excel(file.path(data_raw, "CVS-NCCoastlplainPlots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_NCCoastal <- CVS_plot_data_NCCoastalraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "NC_Coastal") %>% 
  left_join(select(CVS_plot_data_NCCoastalraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_NCFringeraw <- read_excel(file.path(data_raw, "CVS-NCFringePlots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_NCFringe <- CVS_plot_data_NCFringeraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "NC_Fringe") %>% 
  left_join(select(CVS_plot_data_NCFringeraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_NCMtsraw <- read_excel(file.path(data_raw, "CVS-NCMts_no_notes.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_NCMts <- CVS_plot_data_NCMtsraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "NCMts") %>% 
  left_join(select(CVS_plot_data_NCMtsraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode),
         !is.na(Date_prev))


CVS_plot_data_NCPPraw <- read_excel(file.path(data_raw, "CVS-NCPiedmontPlots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_NCPP <- CVS_plot_data_NCPPraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "NCPP") %>% 
  left_join(select(CVS_plot_data_NCPPraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_Proj129raw <- read_excel(file.path(data_raw, "CVS-Project129_new.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_Proj129 <- CVS_plot_data_Proj129raw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "Proj129") %>% 
  left_join(select(CVS_plot_data_Proj129raw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_SCraw <- read_excel(file.path(data_raw, "CVS-SCplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_SC <- CVS_plot_data_SCraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "SC") %>% 
  left_join(select(CVS_plot_data_SCraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode)) %>% 
  # plot 013-0K-0011 is at the edge of SC and GA. In the oldest sampling (1990) it was recorded in the GA data, now is in SC
  left_join(select(CVS_plot_data_GAraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  mutate(Date_prev = if_else(is.na(Date_prev.y), Date_prev.x, Date_prev.y)) %>% 
  select(-Date_prev.y, -Date_prev.x)


CVS_plot_data_TNraw <- read_excel(file.path(data_raw, "CVS-TNplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_TN <- CVS_plot_data_TNraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "TN") %>% 
  left_join(select(CVS_plot_data_TNraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVS_plot_data_TXraw <- read_excel(file.path(data_raw, "CVS-TXplots.xlsx"), sheet = "plot data", guess_max = min(4000, n_max = NULL)) %>% 
  mutate(Date_prev = `Observation Start Date`,
         Code_Prev = `Author Observation Code`)

CVS_plot_data_TX <- CVS_plot_data_TXraw %>% 
  select('Author Observation Code', previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "TX") %>% 
  left_join(select(CVS_plot_data_TXraw, c(Code_Prev, Date_prev)), by = c("previousObsCode" = "Code_Prev")) %>% 
  filter(!is.na(previousObsCode))


CVSresampled <- rbind(CVS_plot_data_VA, CVS_plot_data_AK, CVS_plot_data_AL, CVS_plot_data_FL, 
                      CVS_plot_data_GA, CVS_plot_data_MS, CVS_plot_data_NCCoastal, CVS_plot_data_NCFringe,
                      CVS_plot_data_NCMts, CVS_plot_data_NCPP, CVS_plot_data_Proj129, CVS_plot_data_SC, 
                      CVS_plot_data_TN, CVS_plot_data_TX) 

# creates a list of plots to remove as they were sampled in the same year.
# keeps the plots that were sampled later in the growing season
CVSresampled <- CVSresampled %>% 
  distinct() %>% 
  mutate(SameYear = ifelse(lubridate::year(`Observation Start Date`) == lubridate::year(Date_prev), 1, 0),
         LaterMonth = ifelse(SameYear ==1 & month(`Observation Start Date`) > month(Date_prev), 1,
                             ifelse(SameYear ==0, NA, 0)),
         PlotsRemove  = ifelse(LaterMonth == 1, previousObsCode, `Author Observation Code`)) %>% 
  group_by(Source) %>% 
  mutate(NewPlotID = ifelse(SameYear==0, paste0("CVS_", Source, row_number()), NA)) %>% 
  ungroup()

previousObsCode <- CVSresampled %>% select(previousObsCode, `Author Observation Code`)

# plots resampled 3 and 4 times. For the ones resampled 4 times, I manually created a column with the correspondent plotIDs because I could not think of an easy way to code it.
CVSresampled3 <- CVSresampled %>%
  left_join(previousObsCode, by = c(`Author Observation Code` = "previousObsCode")) %>% 
  mutate(`Author Observation Code.y` = ifelse(previousObsCode == "013-0K-0001", "140-06-0001",
                           ifelse(previousObsCode == "013-0K-0002", "140-06-0002",
                           ifelse(previousObsCode == "013-0K-0011", "140-06-0011",
                           ifelse(previousObsCode == "013-0K-0016", "140-06-0016", 
                           ifelse(previousObsCode == "116-01-0104" | 
                                  previousObsCode == "116-01-0105" |
                                  previousObsCode == "116-03-0101" | 
                                  previousObsCode == "116-04-0103", NA, `Author Observation Code.y`))))),
         NewCode4 = ifelse(`Author Observation Code` == "116-01-0104", "116-D1-0104",
                    ifelse(`Author Observation Code` == "116-01-0105", "116-D1-0105",
                    ifelse(`Author Observation Code` == "116-03-0101", "116-D3-0101", 
                    ifelse(`Author Observation Code` == "116-04-0103", "116-D4-0103", NA)))),
         remove = ifelse(`Author Observation Code.y` == `Author Observation Code`, 1, NA)) %>% 
  filter(!is.na(`Author Observation Code.y`), 
         is.na(remove)) %>% 
  select(-remove)

# plots resampled twice and add the ones sampled 3 times
CVSresampled4 <- CVSresampled %>% 
  filter(!`Author Observation Code` %in% CVSresampled3$`Author Observation Code`) %>% 
  filter(!previousObsCode %in% CVSresampled3$previousObsCode) %>% 
  filter(!previousObsCode %in% CVSresampled3$`Author Observation Code`) %>% 
  filter(!previousObsCode %in% CVSresampled3$`Author Observation Code.y`) %>%
  filter(!`Author Observation Code` %in% CVSresampled3$`Author Observation Code.y`) %>%
    filter(!`Author Observation Code` %in% CVSresampled3$NewCode4) %>%
    filter(!previousObsCode %in% CVSresampled3$NewCode4) %>%
  mutate(`Author Observation Code.y` = NA,
         NewCode4 = NA) %>% 
  rbind(CVSresampled3) %>% 
  group_by(Source) %>% 
  mutate(NewPlotID = ifelse(SameYear==0, paste0("CVS_", Source, row_number()), NA)) %>% 
  ungroup()
  
#list of plots sampled twice in the same year. These ones were sampled earlier in the season.
CVSRemove <- CVSresampled %>% 
  select(PlotsRemove) %>% 
  filter(!is.na(PlotsRemove))
#list of plots resampled [in different years]
CVSresampled2 <- CVSresampled4 %>%
  select(`Author Observation Code`, previousObsCode, `Author Observation Code.y`, NewCode4, NewPlotID) %>% 
  gather(key = "PlotType", value = "Original.Plot", -NewPlotID) %>% 
  select(-PlotType) %>%
  filter(!is.na(NewPlotID),
         !is.na(Original.Plot)) 

glimpse(CVSRemove)
glimpse(CVSresampled2)

# 602 plots are present in both datasheets of NCFringe and NCCoastal
# and they contain the same species and associated information

NCCoastal <- CVS_plot_data_NCCoastalraw %>% 
  select('Author Observation Code', province, previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "VEGBANK_NC_Coastal",
         year= lubridate::year(`Observation Start Date`))

NCFringe <- CVS_plot_data_NCFringeraw %>% 
  select('Author Observation Code', province, previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "VEGBANK_NC_fringe",
         year= lubridate::year(`Observation Start Date`))

NCTotal <- NCCoastal %>% left_join(NCFringe, by = 'Author Observation Code') %>% 
  filter(!is.na(Source.y)) %>% 
  mutate(UniqueID = paste0("VEGBANK_NC_Coastal_", `Author Observation Code`))

# XXX plots are present in both datasheets of NCPP and Proj129
# and they contain the same species and associated information

NCPP <- CVS_plot_data_NCPPraw %>% 
  select('Author Observation Code', province, previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "VEGBANK_NCPP",
         year= lubridate::year(`Observation Start Date`))

Proj129 <- CVS_plot_data_Proj129raw %>% 
  select('Author Observation Code', province, previousObsCode, 'Observation Start Date') %>% 
  mutate(Source = "VEGBANK_Proj129",
         year= lubridate::year(`Observation Start Date`))

NCPPTotal <- NCPP %>% left_join(Proj129, by = 'Author Observation Code') %>% 
  filter(!is.na(Source.y)) %>% 
  mutate(UniqueID = paste0("VEGBANK_NCPP_", `Author Observation Code`))
  
```

Retrieving Site info for CVS
```{r}
SiteCVS <- CVS_plot_data_VAraw %>% 
  select('Author Observation Code', 'Author Location') %>% 
  rbind(select(CVS_plot_data_AKraw, c('Author Observation Code', 'Author Location'))) %>% 
  rbind(select(CVS_plot_data_ALraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_FLraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_GAraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_MSraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_NCCoastalraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_NCFringeraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_NCMtsraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_NCPPraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_Proj129raw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_SCraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_TNraw, c('Author Observation Code', 'Author Location'))) %>%
  rbind(select(CVS_plot_data_TXraw, c('Author Observation Code', 'Author Location'))) %>% 
  distinct() %>% 
  rename(Site='Author Location',
         VegBankUniqueID='Author Observation Code')
```

Retrieving Month of data collection for CVS and merges to WVNHP month data retieved above
```{r}
MonthCVS <- CVS_plot_data_VAraw %>% 
  select('Author Observation Code', 'Observation Start Date') %>% 
  rbind(select(CVS_plot_data_AKraw, c('Author Observation Code', 'Observation Start Date'))) %>% 
  rbind(select(CVS_plot_data_ALraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_FLraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_GAraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_MSraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_NCCoastalraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_NCFringeraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_NCMtsraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_NCPPraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_Proj129raw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_SCraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_TNraw, c('Author Observation Code', 'Observation Start Date'))) %>%
  rbind(select(CVS_plot_data_TXraw, c('Author Observation Code', 'Observation Start Date'))) %>% 
  distinct() %>% 
  rename(Month='Observation Start Date',
         Original.Plot='Author Observation Code') %>% 
  mutate(Month = as.Date(Month, format = "%m/%d/%y"),
         Month = month(Month)) %>% 
  filter(!is.na(Month))
table(MonthCVS$Month, exclude = NULL)

MonthCVS_WVNHP <- MonthCVS %>% rbind(MonthWVNHP)
```


Data wrangling and column selection

```{r}
VEGBANK <- VEGBANK %>% 
  left_join(SiteCVS, by="VegBankUniqueID") %>% 
  left_join(select(WVplotArea, UniqueID, PlotArea), by="UniqueID") %>% 
  #remove duplicates from NCCoastal, leaving the ones in the NCFringe dataset
  filter(!UniqueID %in% NCTotal$UniqueID) %>% 
  #remove duplicates from NCPP, leaving the ones in the Proj129 dataset
  filter(!UniqueID %in% NCPPTotal$UniqueID) %>%
  #extracting the first letters from the plotID to use as site info for WVNHP
  mutate(Site = ifelse(Dataset == "NCVS_WV", gsub("\\..*", "", UniqueID), Site),
         PlotArea.m2 = ifelse(Dataset == "NCVS_WV", PlotArea, Taxon.Observation.Area),
         PlotArea.m2 = ifelse(Dataset == "NCVS_WV" & PlotArea.m2 == 0, NA, PlotArea.m2),
         Original.Plot = ifelse(grepl("VEGBANK", Dataset), VegBankUniqueID, as.character(UniqueID))) %>%
  #line below removes the 3 plots that have the same information in VNHP dataset
  filter(!Original.Plot %in% CVSRemove$PlotsRemove) %>% 
  left_join(CVSresampled2, by = "Original.Plot") %>% 
  left_join(WVPlotCoord, by = "Original.Plot") %>% 
  mutate(Plot = ifelse(is.na(NewPlotID), Original.Plot, NewPlotID),
         Correct.Lat = as.numeric(Correct.Lat),
         Lat = ifelse(is.na(Correct.Lat), Lat, Correct.Lat),
         Lon = ifelse(is.na(Correct.Lon), Lat, Correct.Lon)) %>% 
  rename(#Plot = UniqueID,
         Original.Lat = Lat,
         Original.Long = Long,
         AcceptedTaxonName = bestname,
         Original.TaxonName = OriginalName,
         NativeStatus = ExoticStatus,
         Growth.Habit = GrowthForm) %>%
  mutate(Lat = ifelse(Dataset=="NCVS_WV", round(Original.Lat, 1), Public.Latitude),
         Long = ifelse(Dataset=="NCVS_WV", round(Original.Long, 1), Public.Longitude),
         Dataset = ifelse(grepl("VEGBANK", Dataset), "CVS", "WVNHP"),
         TempLat = as.character(Original.Lat),
         TempLong = as.character(Original.Long), 
         TempPublic.Latitude = as.character(Public.Latitude),
         TempPublic.Longitude = as.character(Public.Longitude),
         TempFuzzedCoord = ifelse(TempLong == Public.Longitude & TempLat == TempPublic.Latitude, "N", "Y"),
         FuzzedCoord = ifelse(Dataset=="WVNHP", "Y", 
                              ifelse(is.na(TempFuzzedCoord), "Missing", TempFuzzedCoord)),
         Year = ifelse(Year==2064, 1964,
                       ifelse(Year==2063, 1963, Year)),
         # change the beginning of the name of the plot from VEGBANK to CVS
         # Plot = str_replace(Plot, "^VEGBANK_", "CVS_")
         # LP: removing the two above lines completely. I will keep the original plot codes as much as possible
         ) %>% 
  filter(!Original.Plot %in% PlotsRemoveWVNHP$`Plot Code`) %>% #partial floristic
  filter(!Original.Plot %in% PlotsRemoveWVNHP2$`Plot Code`) %>% #overlap with NWCA
  left_join(MonthCVS_WVNHP, by="Original.Plot") %>% # adds month of data collection
  left_join(PlotsResampleWVNHP, by = "Original.Plot") %>% 
  mutate(Plot = ifelse(is.na(NewPlot), Original.Plot, NewPlot)) %>%
  left_join(WVNHPStrata, by = c("Original.Plot" = "Plot.Code", "Original.TaxonName" = "Scientific.Name")) %>%
  mutate(Original.TaxonName = ifelse(is.na(Original.TaxonName) & Original.Plot == "SHMO.9", "Aster",
                                     ifelse(is.na(Original.TaxonName) & Original.Plot == "GRAN.31", "Cladonia P. Browne", Original.TaxonName)),
         RecordedStrata = ifelse(is.na(RecordedStrata) & Original.Plot == "SHMO.9", "N",
                                     ifelse(is.na(RecordedStrata) & Original.Plot == "GRAN.31", "Y", RecordedStrata))) %>% 
  # adds
  left_join(Plot_shape_WV, by = "Original.Plot") %>% 
  #fixing trace cover for WVNHP (should be 0.01, but there are smaller values) %>% 
  mutate(PctCov = ifelse(Dataset=="WVNHP"&PctCov==0.0025|
                           Dataset=="WVNHP"&PctCov==0.005, 0.01, PctCov)) %>% 
  dplyr::select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(VEGBANK))
setdiff(names(VEGBANK), DesiredColumns)

glimpse(VEGBANK)
```


Quantifying plots without coordinates
```{r}
VEGBANK %>% filter(Dataset=="CVS") %>% select(Plot, Lat, Long) %>% distinct() %>% mutate(MissingCoord = ifelse(is.na(Lat)&is.na(Long), "missing", "not missing")) %>% count(MissingCoord)
```

Code below finds plots with same original coordinates but with distinct plotIDs (n\>1) and plots with same original coordinates but with distinct plotIDs and different year of sampling (unique_year\>1)

```{r eval=FALSE, include=FALSE}
##DON'T RUN
# WVNHP <- filter(VEGBANK, Dataset == "WVNHP")
# 
# WVNHPissues <- WVNHP %>% 
#   group_by(Year, Original.Long, Original.Lat) %>% 
#   distinct(Original.Plot) %>%
#   mutate(Original.Long = as.character(Original.Long),
#          Original.Lat = as.character(Original.Lat)) %>% 
#   group_by(Original.Long, Original.Lat) %>% 
#   add_tally() %>% 
#   mutate(unique_year = n_distinct(Year)) %>% 
#   filter(n>1) %>% 
#   arrange(Original.Long) %>% 
#   write_csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_WVNHP/WVNHPPlotVerify2.csv")
```

## VNHP

Imports the file

```{r}
VNHP <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/VANHP_datapaper_06_16_21_EB.csv", 
                    na = c('', 'NA')) 
glimpse(VNHP)
```

Finding resampled plots

```{r}
VNHPresample <- VNHP %>% 
  group_by(Year, Long, Lat) %>% 
  distinct(Plot) %>%
  mutate(Long = as.character(Long),
         Lat = as.character(Lat),
         Site = str_sub(Plot, 1, 4)) %>% 
  group_by(Long, Lat, Site) %>% 
  add_tally() %>% 
  mutate(unique_year = n_distinct(Year)) %>% 
  filter(n>1) %>% 
  arrange(Long)  %>% 
  filter(unique_year>1,
         !grepl("^GRAF", Plot)) %>% 
  group_by(Long, Lat) %>% 
  mutate(NewPlotID = paste0("VNHP_", cur_group_id())) %>% 
  ungroup() %>% 
  rename(Original.Plot = Plot) %>% 
  select(Original.Plot, NewPlotID)
  # write_csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_VNHP/VNHPPlotVerify.csv")

## where n >1 and unique_year >1 ==> resampled plots (with the exception of GRAF). Change their plot IDs to have a single id across years.

## 8th character for Resamples - final character = permanent (P), composite (C), duplicate (D) or resampled (R,S,T,...) plot
### Resample is when the original plot was permanently marked and the exact same area was sampled in the "resample"
### Duplicate is used when the location is thought to be the same area, based on a GPS point (and trees and veg and memory)  i.e.(the original sample was not permanently marked)
### I will consider both Resample and Duplicate as resamples
### Composite --> where we combine data from n adjacent and contiguous plots along a transect into one plot sample for entry into the database
```

Finding plot shape
```{r}
VAPLOTS_Shape <- read_excel("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_VNHP/VAPLOTS_classification_geocoors_plotsize.xls", 
    sheet = "METADATA_table")
glimpse(VAPLOTS_Shape)

VAPLOTS_Shape <- VAPLOTS_Shape %>% select(Plot, `Plot Size`, `Plot Dimensions`) %>% 
  distinct(Plot, .keep_all = T) %>% 
  mutate(SamplingMethod = ifelse(grepl("radius", `Plot Dimensions`), "Circular plot", ifelse(`Plot Dimensions` == "plotless", "Releve", "Rectangular plot")),
         SamplingMethod = ifelse(is.na(SamplingMethod), "Releve", SamplingMethod)) %>% select(Plot, SamplingMethod)
  
length(unique(VNHP$Plot))
length(unique(VAPLOTS_Shape$Plot)) # two more than the dataset
```

Finding Month of data collection

```{r}
VNHPMonth <- read_csv("/home/shares/neon-inv/raw_VegBank_data/VANHP_PlotMetadata_03_22_21.csv")
glimpse(VNHPMonth)

VNHPMonth <- VNHPMonth %>% select(Plot, Date) %>% 
  mutate(Date = as.Date(Date, format = "%m/%d/%y"),
         Year = year(Date),
         Month = lubridate::month(Date),
         Original.Plot = as.character(Plot)) %>% distinct() %>% 
  select(-Plot, -Date)
```


Data wrangling and column selection

```{r}
VNHP <- VNHP %>%
  left_join(VAPLOTS_Shape, by = "Plot") %>% 
  mutate(FuzzedCoord = "Y", 
         Site = str_sub(Plot, 1, 4),
         Original.Long = Long,
         Original.Lat = Lat,
         Long = round(Long, 1),
         Lat = round(Lat, 1),
         Original.Plot = as.character(Plot),
         Dataset = "VNHP") %>%
  rename(Original.TaxonName = VASpeciesName,
         AcceptedTaxonName = bestname,
         PlotArea.m2 = Plot.Size, 
         NativeStatus = ExoticStatus) %>%
  left_join(VNHPMonth, by = c("Original.Plot", "Year")) %>% 
  left_join(VNHPresample, by = "Original.Plot") %>% 
  mutate(Plot = ifelse(is.na(NewPlotID), Original.Plot, NewPlotID)) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(VNHP))
setdiff(names(VNHP), DesiredColumns)
glimpse(VNHP)
```

## NWCA

Imports the file

```{r}
NWCA <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/NWCA2011-2016_09122022.csv", 
                  na = c('', 'NA')) 
glimpse(NWCA)
```

Data wrangling and column selection

```{r}
NWCA <- NWCA %>%
  mutate(FuzzedCoord = "N",
         Dataset = "NWCA",
         Original.Plot = as.character(PLOT),
         Original.Lat = Lat,
         Original.Long = Long) %>%
  rename(Site = UniqueSiteID,
         Plot = UniquePlotID,
         Original.TaxonName = OriginalName,
         AcceptedTaxonName = bestname,
         PlotArea.m2 = PlotArea_m2,
         NativeStatus = inv_L48,
         SpCode = Accepted.Symbol,
         PctCov = COVER) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(NWCA))
setdiff(names(NWCA), DesiredColumns)
glimpse(NWCA)
```

## IL_CTAP

Imports the file

```{r}
IL_CTAP <- read.csv("/home/shares/neon-inv/data_paper/data_by_dataset/IL_CTAP_DataPaper09132022.csv", 
                 na = c('', 'NA')) 
glimpse(IL_CTAP)
```

Data wrangling and column selection

```{r}
IL_CTAP <- IL_CTAP %>%
  mutate(FuzzedCoord = "Y",
         Original.Lat = Lat,
         Original.Long = Long,
         Lat = round(Lat, 2),
         Long = round(Long, 2),
         Original.Plot = as.character(Transect)) %>%
  rename(Site = SiteID,
         AcceptedTaxonName = bestname,
         NativeStatus = inv_L48,
         SpCode = Accepted.Symbol,
         Year = PYear,
         Month = PMonth,
         Original.TaxonName = OriginalSpeciesName) %>%
  select(one_of(DesiredColumns))

setdiff(DesiredColumns, names(IL_CTAP))
setdiff(names(IL_CTAP), DesiredColumns)
glimpse(IL_CTAP)
```

# Join

```{r}
DataBase <- bind_rows(AIM, NPS, FIA, NEON, VEGBANK, VNHP, NWCA, IL_CTAP)
glimpse(DataBase)

DataBase %>% select(Plot) %>% distinct() %>% nrow()
DataBase %>% group_by(Dataset) %>% count()
nrow(DataBase)
```

# Update native status to be consistent

## Creating a "Zone" Column

```{r}
DataBase <- DataBase %>%
  mutate(Zone = case_when(Lat > 50 ~ "AK",
                          Lat < 50 & Lat > 19 & Long > -130 ~ "L48",
                          Long < -150 & Lat < 25 ~ "HI",
                          Lat < 20 & Long < -65 & Long > -70 ~ "PR",
                          TRUE ~ "MissingCoords"),
         #assigning Zone to missing coordinates. I think this will remove this category "MissingCoords"
         Zone = ifelse(Zone == "MissingCoords" & Dataset == "NWCA"|
                         Zone == "MissingCoords" & Dataset == "IL_CTAP"|
                         Zone == "MissingCoords" & Dataset == "CVS"| 
                       Zone == "MissingCoords" & Dataset == "NPS" & Site != "HALE", "L48",
                       ifelse(Zone == "MissingCoords" & Site == "HALE", "HI", Zone)))

DataBase %>%
  select(Dataset, Site, Plot, Zone) %>%
  distinct() %>%
  count(Zone) #number of plots per zone 

DataBase %>%
  filter(Zone == "MissingCoords",
         !is.na(Long),
         !is.na(Lat)) %>%
  nrow() # yes, all missing coords 
table(DataBase$Zone) #missing coordinates = 185102 records

DataBase %>%
  filter(Zone == "PR") %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset)

nrow(DataBase)
```

## Fix 'Original.Site' for all datasets [this column was added because of NWCA]
```{r}
table(DataBase$Original.Site) #check whether this column has information (it should for NWCA), all others should be NA

DataBase <- DataBase %>% 
    #fills the Original.Site column with Site for the cases where a new SiteID was not assigned
    mutate(Original.Site = ifelse(is.na(Original.Site), Site, Original.Site))

nrow(DataBase)
```

## Fix taxonomy errors and inconsistencies

-   get all the unique species codes by zone

```{r}
#distinct species codes with no NativeStatus by Zone
DataBaseCodes <- DataBase %>% 
  select(SpCode, Zone) %>% 
  distinct() %>% 
  filter(#spp codes that Kristen created to the unmatched species from CVS
         !str_detect(SpCode, "NOMATCH"))
glimpse(DataBaseCodes)

```

-   getting native status and needed columns *important:* SpCode will be changed to Accepted.Symbol from USDA for all datasets. This is because some datasets (for instance, AIM) kept its original SpCode, but others updated to the Accepted. Symbol from Ian's taxonomy table. As I cannot retrieve this info, I'm making it consistent *important2:* I'll use the Scientific.Name species column from USDA. In case there are synonyms, I will use the species from the Accepted.Symbol of that species.

```{r}
# only unique accepted symbols

tax <- tax %>% mutate(Accepted.Symbol2 = Accepted.Symbol)

tax_accep <- tax %>% 
  mutate_all(na_if,"") %>% 
  filter(is.na(Synonym.Symbol)) %>% 
  select(-Symbol, -Synonym.Symbol, -Native.Status, -genus, -epithet, -Family) 
  
DataBaseCodes <- DataBaseCodes %>% 
  left_join(tax_accep, by = c("SpCode" = "Accepted.Symbol")) %>% 
  mutate(NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, 
                                      ifelse(Zone == "PR", inv_PR, 
                                      ifelse(Zone == "HI", inv_HI, 
                                      ifelse(Zone == "MissingCoords", inv_L48, NA))))))

# sub-setting the fixed ones (19608)
DataBaseCodes_fixed <- DataBaseCodes %>% 
  filter(!is.na(Scientific.Name)) %>% 
  rename(AcceptedTaxonName = Scientific.Name) %>% 
  select(SpCode, Zone, NativeStatus, AcceptedTaxonName, Duration, Growth.Habit, Accepted.Symbol2)


# fixing the ones with Synonyms (2141)
DataBaseCodes2 <- DataBaseCodes %>% 
  filter(is.na(Scientific.Name)) %>% 
  select(SpCode, Zone) %>% 
  left_join(select(tax, c("Symbol", "Accepted.Symbol")), by = c("SpCode" = "Symbol")) %>% 
  distinct() %>% 
  left_join(tax_accep, by = c("Accepted.Symbol" = "Accepted.Symbol")) %>% 
  mutate(NativeStatus = ifelse(Zone == "L48", inv_L48,
                               ifelse(Zone == "AK", inv_AK, 
                                      ifelse(Zone == "PR", inv_PR, 
                                      ifelse(Zone == "HI", inv_HI, 
                                      ifelse(Zone == "MissingCoords", inv_L48, NA)))))) %>% 
  rename(AcceptedTaxonName = Scientific.Name) %>% 
  select(SpCode, Zone, NativeStatus, AcceptedTaxonName, Duration, Growth.Habit, Accepted.Symbol2)


# getting the entire list of missing codes again (21749 species codes)
nrow(DataBaseCodes_fixed) + nrow(DataBaseCodes2)
DataBaseALLCodes <- rbind(DataBaseCodes_fixed, DataBaseCodes2)

```

```{r}
# file with manually changed native status
status <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/multStatusSpL48LP.csv")
head(status)

status <- status %>%
  select(SpCode, L48status = `FINAL DECISION (L48)`) %>%
  filter(!is.na(SpCode))
anyDuplicated(status$SpCode)
```

*Option1*: Uses USDA PLANTS species code from Accepted.Symbol2 even if the original dataset have a particular code for that species

```{r}
DataBase <- DataBase %>%
  left_join(DataBaseALLCodes, by = c("SpCode", "Zone")) %>% 
  #removes SpCode that came with the datasets 
  select(-NativeStatus.x, -AcceptedTaxonName.x, -Duration.x, -Growth.Habit.x) %>% 
  rename(SpCode.Original = SpCode,
         SpCode = Accepted.Symbol2,
         NativeStatus = NativeStatus.y,
         AcceptedTaxonName = AcceptedTaxonName.y,
         Duration = Duration.y,
         Growth.Habit = Growth.Habit.y) %>% 
  left_join(status) %>%
  mutate(NativeStatus = ifelse(Zone == "L48" & !is.na(L48status), L48status, 
                        ifelse(Zone == "MissingCoords" & !is.na(L48status), L48status, NativeStatus))) %>%
  select(-L48status)

nrow(DataBase)
```

*Option2*: Uses SpCode from the original dataset and replaces the NA from Accepted.Symbol2 (PLANTS codes) LP: It seems to me that this is not the way to go. The "NOMATCH" codes are for both species that USDA PLANTS don't have but was identified by researchers at the source [mainly CVS, WVNHP, VNHP] or clearly stated as Unknown [in CVS it's {Unkown}]

```{r eval=FALSE, include=FALSE}
## SpCode from the original dataset and replaces the NA from Accepted.Symbol2 (PLANTS codes)
# DataBase <- DataBase %>%
#   left_join(DataBaseALLCodes, by = c("SpCode", "Zone")) %>% 
#   #line below gets the SpCode from the original dataset and replaces the NA from Accepted.Symbol2    
#   mutate(SpCode = ifelse(is.na(Accepted.Symbol2), SpCode, Accepted.Symbol2)) %>% 
#   select(-NativeStatus.x, -AcceptedSpeciesName.x, -Duration.x, -Growth.Habit.x) %>%
#   rename(NativeStatus = NativeStatus.y,
#          AcceptedSpeciesName = AcceptedSpeciesName.y,
#          Duration = Duration.y,
#          Growth.Habit = Growth.Habit.y) %>% 
#   left_join(status, by = "SpCode") %>%
#   mutate(NativeStatus = ifelse(Zone == "L48" & !is.na(L48status), L48status, 
#                         ifelse(Zone == "MissingCoords" & !is.na(L48status), L48status, NativeStatus))) %>%
#   select(-L48status, -Accepted.Symbol2)
```

Checking whether there are Species with multiple exotic status: NONE!

```{r}
DataBase %>%
  group_by(Zone, SpCode, AcceptedTaxonName) %>%
  summarize(nStatus = n_distinct(NativeStatus)) %>%
  filter(nStatus > 1)
```

```{r eval=FALSE, include=FALSE}
# old code to fix taxonomic errors, but I fixed above only using USDA tax table from Ian
# DataBase <- DataBase %>%
#   mutate(AcceptedSpeciesName = recode(AcceptedSpeciesName, 
#                            "Pyrrocoma uniflora var. uniflora" = "Pyrrocoma uniflora",
#                            "Antennaria rosea ssp. confinis" = "Antennaria rosea",
#                            "Notholithocarpus densiflorus" = "Lithocarpus densiflorus"))

# DataBase <- DataBase %>%
#   mutate(NativeStatus = ifelse(SpCode == "RHYNC3" & Zone == "L48",
#                                "NI",
#                                NativeStatus),
#          NativeStatus = ifelse(SpCode == "FIMBR" & Zone == "L48",
#                                "NI",
#                                NativeStatus),
#          # based on USDA plants:
#          NativeStatus = ifelse(SpCode == "ACMI2" & Zone == "AK",
#                                "N",
#                                NativeStatus))
# 
# 
# 
# ###  FIX species with multiple exotic status  ####
# # By zone
# DataBase.fill <- DataBase %>%
#   group_by(SpCode, AcceptedSpeciesName, Zone) %>%
#   fill(NativeStatus, .direction = "downup") 
# 
# # Creates a summarized table in which identifies whether a species code has 
# # more than a particular "bestname", "NativeStatus" attributed to it.
# # I see inconsistencies when adding the VEGBANK data. 
# countFilled <- DataBase.fill %>%
#   group_by(SpCode) %>%
#   # non-numeric variables:
#   summarise(across(one_of("AcceptedSpeciesName", "NativeStatus"), 
#                    ~ n_distinct(.x[!is.na(.x)]))) %>%
#   filter(AcceptedSpeciesName>1) # filter species codes with more than one matching bestname
# head(countFilled)
# 
# IanTaxonomy <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/taxonomy_temp10_revised.csv")
# 
# IanTaxonomy <- IanTaxonomy %>%
#   select(Accepted.Symbol, bestname) %>%
#   filter(Accepted.Symbol %in% countFilled$SpCode) %>%
#   distinct() %>%
#   group_by(Accepted.Symbol) %>%
#   add_tally() %>%
#   rename(SpCode = Accepted.Symbol)
# 
# #it seems that even Ian's taxonomy has multiple species bestname for a particular code. 
# #So here, I filtered the species codes that had a single match for bestname (and I couldn't figure out why
# #they were different across datasets) and redefined their bestname. The remaining species codes, that
# #have more than one bestname, I am going to manually modify based on the USDA accepted name on 08/20/2021 and 10/28/2021
# DataBase.fill <- DataBase.fill %>%
#   left_join(IanTaxonomy %>% filter(n == 1)) %>%
#   mutate(AcceptedSpeciesName = ifelse(!is.na(bestname), bestname, AcceptedSpeciesName)) %>%
#   select(-bestname, -n)
# glimpse(DataBase.fill)
# 
# #checking again
# #now it's better, only 49 species codes have multiple bestname
# countFilled <- DataBase.fill %>%
#   group_by(SpCode) %>%
#   # non-numeric variables:
#   summarise(across(one_of("AcceptedSpeciesName", "NativeStatus"), 
#                    ~ n_distinct(.x[!is.na(.x)]))) %>%
#   filter(AcceptedSpeciesName>1) # filter species codes with more than one matching bestname
# head(countFilled)
#  
# ## species codes with different bestname associated to them
# ## Not really using this dataframe for anything in the code, just to help me check the inconsistencies
# UnmatchData <- DataBase.fill %>% 
#   ungroup() %>%
#   filter(SpCode %in% countFilled$SpCode) %>%
#   select(Dataset, SpCode, AcceptedSpeciesName, NativeStatus) %>%
#   distinct()
# 
# #manually modify based on the USDA accepted name on 08/20/2021 and 10/28/2021
# DataBase.fill <- DataBase.fill %>%
#   mutate(SpCode = ifelse(SpCode == "7-Feb", "FEBR7", SpCode),
#     AcceptedSpeciesName = ifelse(SpCode == "ACFL", "Acer floridanum",
#                     ifelse(SpCode == "ANGLP", "Andropogon glomeratus var. pumilus",
#                     ifelse(SpCode == "ANGYS", "Andropogon gyrans var. stenophyllus",
#                     ifelse(SpCode == "ANMI3", "Antennaria microphylla",
#                     ifelse(SpCode == "ARLAB", "Arabis laevigata var. burkii",
#                     ifelse(SpCode == "ARLUI2", "Artemisia ludoviciana ssp. incompta",
#                     ifelse(SpCode == "ASTUR", "Asclepias tuberosa ssp. rolfsii",
#                     ifelse(SpCode == "BOON", "Botrychium oneidense",
#                     ifelse(SpCode == "BRAR5", "Bromus arvensis",
#                     ifelse(SpCode == "CACAD2", "Carex canescens ssp. disjuncta",
#                     ifelse(SpCode == "CEPU10", "Celtis pumila",
#                     ifelse(SpCode == "CLHA", "Cleome hassleriana",
#                     ifelse(SpCode == "CRMIE", "Croton michauxii var. ellipticus",
#                     ifelse(SpCode == "DRGO3", "Dryopteris goldieana",
#                            ifelse(SpCode == "ELMI2", "Eleocharis microcarpa",
#                            ifelse(SpCode == "ELPAP", "Eleocharis palustris var. palustris",
#                            ifelse(SpCode == "ERHIH2", "Erechtites hieraciifolius var. hieraciifolius",
#                            ifelse(SpCode == "EUATA2", "Euonymus atropurpureus var. atropurpureus",
#                            ifelse(SpCode == "EUMAM4", "Eutrochium maculatum var. maculatum",
#                            ifelse(SpCode == "EURE18", "Eubotrys recurvus",
#                            ifelse(SpCode == "FEBR7", "Festuca brevipila",
#                            ifelse(SpCode == "HASU3", "Hasteola suaveolens",
#                            ifelse(SpCode == "HEAMH2", "Heuchera americana var. hispida",
#                            ifelse(SpCode == "KYGR", "Kyllinga gracillima",
#                            ifelse(SpCode == "LEFR5", "Lespedeza frutescens",
#                            ifelse(SpCode == "LIPUM2", "Liatris punctata var. mucronata",
#                            ifelse(SpCode == "MEOF", "Melilotus officinalis",
#                            ifelse(SpCode == "MOFIB", "Monarda fistulosa var. brevis",
#                                   ifelse(SpCode == "NEAR5", "Nekemias arborea",
#                                   ifelse(SpCode == "OEFRT", "Oenothera fruticosa ssp. tetragona",
#                                   ifelse(SpCode == "OSAM", "Osmanthus americanus",
#                                   ifelse(SpCode == "PAPSP2", "Packera pseudaurea var. pseudaurea",
#                                   ifelse(SpCode == "PARI4", "Panicum rigidulum",
#                                   ifelse(SpCode == "PARIE2", "Panicum rigidulum var. elongatum",
#                                   ifelse(SpCode == "PHLA13", "Phlox latifolia",
#                                   ifelse(SpCode == "PIASA", "Pityopsis aspera var. adenolepis",
#                                   ifelse(SpCode == "PIGRT", "Pityopsis graminifolia var. tenuifolia",
#                                   ifelse(SpCode == "PIMI", "Piptatheropsis micrantha",
#                                   ifelse(SpCode == "PLAQ2", "Platanthera aquilonis",
#                                   ifelse(SpCode == "POAR21", "Poa arnowiae",
#                                   ifelse(SpCode == "RHMAV", "Rhexia mariana var. ventricosa",
#                                          ifelse(SpCode == "RUSAM", "Rumex salicifolius var. mexicanus",
#                                          ifelse(SpCode == "RUTRR", "Rudbeckia triloba var. rupestris",
#                                          ifelse(SpCode == "SACA19", "Saxifraga careyana",
#                                          ifelse(SpCode == "SOPUP", "Solidago puberula var. pulverulenta",
#                                          ifelse(SpCode == "VEHY", "Veratrum hybridum",
#                                          ifelse(SpCode == "VIBE5", "Viola Ãbernardii",
#                                          ifelse(SpCode == "VIES3", "Viola Ãesculenta",
#                                          ifelse(SpCode == "ZILE", "Zigadenus leimanthoides",
#                                          AcceptedSpeciesName))))))))))))))))))))))))))))))))))))))))))))))))))
# 
# ## it seems to have a limit on how many ifelse we can have in a mutate, that's why I broke it down here.
# DataBase.fill <- DataBase.fill %>%
#   mutate(AcceptedSpeciesName = ifelse(SpCode == "DIACA", "Dichanthelium acuminatum", AcceptedSpeciesName))
# 
# # checking if the code worked:
# countFilled <- DataBase.fill %>%
#   group_by(SpCode) %>%
#   # non-numeric variables:
#   summarise(across(one_of("AcceptedSpeciesName", "NativeStatus"), 
#                    ~ n_distinct(.x[!is.na(.x)])),
#             # round the numeric ones:
#             #across(SLA:StemSpecificDensity, ~ n_distinct(round(.x[!is.na(.x)], 4)))
#   ) %>%
#   filter(AcceptedSpeciesName>1) # filter species codes with more than one matching bestname
# head(countFilled)
# nrow(countFilled) # the issues were fixed!
# 
# ##fixing an error on code FEBR7 that came as 7-Feb before
# DataBase.fill <- DataBase.fill %>%
#   mutate(NativeStatus = ifelse(SpCode == "FEBR7" & is.na(NativeStatus), "I", NativeStatus))
# 
# ##  Update few species/genera following suggestion from Jeff Corbin:
# DataBase.fill %>%
#   filter(SpCode %in% c("CASTI", "POLYG4", "RUMEX", "PLANT", "ELMA7")) %>%
#   select(SpCode, AcceptedSpeciesName, NativeStatus, Zone) %>%
#   distinct() %>%
#   arrange(SpCode)
# 
# DataBase.fill <- DataBase.fill %>%
#   mutate(NativeStatus = ifelse(SpCode == "CASTI",
#                                "I",
#                                NativeStatus),
#          NativeStatus = ifelse(SpCode == "ELMA7", "N", NativeStatus),
#          NativeStatus = ifelse(SpCode == "PLANT", "NI", NativeStatus),
#          NativeStatus = ifelse(SpCode == "POLYG4" & Zone != "AK",
#                                "NI", NativeStatus),
#          NativeStatus = ifelse(SpCode == "RUMEX" & Zone != "AK", 
#                                "NI", NativeStatus))
# 
# 
# ## Modifying the Native Status for Puerto Rico species to NA
# 
# DataBase.fill <- DataBase.fill %>%
#   mutate(NativeStatus = ifelse(Zone == "PR",
#                                NA,
#                                NativeStatus))
# ```
# 
# ### Finding species with real missing status
# ```{r eval=FALSE, include=FALSE}
# 
# tax <- read_csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/taxonomy_temp10_revised.csv")
# tax <- tax %>%
#   select(Accepted.Symbol, Scientific.Name, bestname, inv_L48, inv_AK, inv_HI, FIA_Code) 
# glimpse(tax)
# taxcodes <- tax %>% select(Accepted.Symbol) %>% distinct()
# taxcodes <- taxcodes$Accepted.Symbol
# 
# "%ni%" <- Negate("%in%")
# 
# MissingStatusAll <- DataBase.fill %>% 
#   select(Dataset, SpCode, NativeStatus, AcceptedSpeciesName, OriginalSpeciesName, Zone) %>% 
#   filter(is.na(NativeStatus)) %>% 
#   distinct() %>% 
#   glimpse()
# 
# MissingStatusPR <- MissingStatusAll %>% 
#   filter(Zone == "PR") %>% 
#   glimpse()
# 
# MissingStatusl48HIAKknown <- MissingStatusAll %>% 
#   filter(Zone != "PR") %>% 
#   glimpse()
# 
# MissingStatusl48HIAK <- MissingStatusl48HIAKknown %>% 
#   filter(!SpCode %in% taxcodes,
#          Zone != "MissingCoords",
#          #spp codes that Kristen created to the unmatched species from CVS
#          !str_detect(SpCode, "NOMATCH")) %>% 
#   # select(-Dataset) %>% 
#   distinct() %>% 
#   glimpse()
# 
# sppcodes <- read_csv("/home/shares/neon-inv/output_files/USDA_Plants_ScientificNames.csv")
# head(sppcodes) 
# sppcodes <- sppcodes %>% filter(is.na(Synonym.Symbol)) %>% select(-Synonym.Symbol) %>% glimpse()
# 
# #checking whether the USDA list only has unique symbol for "Accepted.Symbol"
# sppcodes %>% 
#   select(Accepted.Symbol) %>% 
#   group_by(Accepted.Symbol) %>% 
#   add_tally() %>% 
#   arrange(desc(n))
# 
# sppcodes2 <- read_csv("/home/shares/neon-inv/output_files/USDA_Plants_ScientificNames.csv")
# head(sppcodes2) 
# sppcodes2 <- sppcodes2 %>% filter(!is.na(Synonym.Symbol)) %>% select(-Accepted.Symbol) %>% glimpse()
# 
# #checking whether the USDA list only has unique symbol for "Accepted.Symbol"
# sppcodes2 %>% 
#   select(Synonym.Symbol) %>% 
#   group_by(Synonym.Symbol) %>% 
#   add_tally() %>% 
#   arrange(desc(n))
# 
# #joins PR and all other missing status species
# RealMissing <- rbind(MissingStatusl48HIAK, MissingStatusPR)
# glimpse(RealMissing)
# 
# RealMissing <- RealMissing %>%  left_join(sppcodes, by = c("SpCode" = "Accepted.Symbol")) %>% 
#   mutate(AcceptedSpeciesName = ifelse(is.na(AcceptedSpeciesName), Scientific.Name, AcceptedSpeciesName)) %>% 
#   select(-Scientific.Name) %>% left_join(sppcodes2, by = c("SpCode" = "Synonym.Symbol")) %>%
#   mutate(AcceptedSpeciesName = ifelse(is.na(AcceptedSpeciesName), Scientific.Name, AcceptedSpeciesName)) %>%
#   select(-Scientific.Name) %>% 
#   filter(!is.na(AcceptedSpeciesName)) %>% 
#   select(-Dataset, -OriginalSpeciesName, -NativeStatus) %>% 
#   distinct() %>% 
#   group_by(SpCode) %>% 
#   add_tally() %>% 
#   arrange(desc(n)) %>% 
#   spread(Zone, n) %>% 
#   write.csv("/home/shares/neon-inv/data_paper/code_by_dataset/taxonomy/MissingNativeStatus.csv", row.names = F)
# 
# UniqueSpCodesRealMissing <- unique(RealMissing$SpCode)

```

#### Join column Pct_100 and NumberOfStrata by SpCode.Original and then remove SpCode.Original
##### IL_CTAP and NEON already carries this information from the data

```{r}
# imports NPS and WVNHP data with PctCov_100
WVNHP100 <- read.csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_WVNHP/WVNHPPct_100_Sept22.csv" )
NPS100 <- read.csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_NPS/NPSPct_100_Sep22.csv")

dim(DataBase)

DataBase <- DataBase %>%
  ## NPS
  left_join(NPS100, by = c("Plot", "SpCode.Original")) %>% # A LOT OF NAs
  mutate(PctCov_100.y=ifelse(Dataset=="NPS" & Site=="CAVE", PctCov, PctCov_100.y)) %>% 
  ##WVNHP
  left_join(WVNHP100, by = c("Original.Plot", "Original.TaxonName")) %>% 
  mutate(PctCov_100=ifelse(Dataset=="WVNHP" & RecordedStrata=="N", PctCov, PctCov_100))

dim(DataBase) # should be the same number of rows, two more columns

# if everything looks great above, fill in the blanks for PctCov_100
# cover for datasets that we did not aggregate cover across strata but were handed to us with final cover, PctCover_100==PctCov
DataBase <- DataBase %>% mutate(PctCov_100.x=ifelse(Dataset=="NPS", PctCov_100.y, 
                                                      ifelse(Dataset=="WVNHP", PctCov_100, 
                                                             ifelse(is.na(PctCov_100.x), PctCov, PctCov_100.x)))) %>% 
  select(-PctCov_100.y, -PctCov_100) %>% 
  rename(PctCov_100 = PctCov_100.x)

dim(DataBase)
```


# Checking missing data for Year column

```{r}
####checking missing data for Year column####
DataBase %>% 
  filter(is.na(Year)) %>% 
  nrow() # missing Year = 65368 records 

DataBase %>% 
  filter(is.na(Year)) %>% 
  group_by(Dataset) %>% 
  tally()# missing Year = all 65368 records are from NPS

table(DataBase$Year) # checks the range of years

DataBase%>%
  filter(Year == 1195) %>%
  select(Dataset, Plot) %>%
  distinct() # ASIS_2 --> FIXED!

DataBase%>%
  filter(Year == 2063) %>%
  select(Dataset, Plot) %>%
  distinct() # ROBI.XX = 10 plots --> FIXED!

DataBase%>%
  filter(Year == 2064) %>%
  select(Dataset, Plot) %>%
  distinct() # ROBI.XX = 24 plots --> FIXED!

# plots missing coordinates based on "Zone" column
DataBase %>%
  ungroup() %>%
  select(Plot, Zone) %>% 
  distinct() %>%
  count(Zone)

# plots missing coordinates based on "FuzzedCoord" column
DataBase %>%
  ungroup() %>%
  select(Plot, FuzzedCoord) %>% 
  distinct() %>%
  count(FuzzedCoord)

DataBase %>% filter(FuzzedCoord=="Missing") %>% nrow()
DataBase %>% filter(is.na(Lat)) %>% nrow()
DataBase %>% filter(is.na(Long)) %>% nrow()
DataBase %>% filter(is.na(Long)|is.na(Long)) %>% distinct(Dataset)

# it seems that for some datasets, missing coordinates were mistakenly classified as "Y" or "N" in the FuzzedCoord, instead of being "Missing"
DataBase <- DataBase %>% 
  mutate(FuzzedCoord = ifelse(Dataset == "NWCA" & is.na(Lat) |
                                Dataset == "IL_CTAP" & is.na(Lat), "Missing", FuzzedCoord))


DataBase %>% filter(FuzzedCoord=="Missing") %>% nrow()
DataBase %>% filter(is.na(Lat)) %>% nrow()
DataBase %>% filter(is.na(Long)) %>% nrow()
# all three have the same length now, it should be fixed

nrow(DataBase)
```

# Check that all datasets are percent cover, not proportion

```{r}

DataBase %>%
  group_by(Dataset) %>%
  summarize(min = min(PctCov, na.rm = TRUE),
            mean = mean(PctCov, na.rm = TRUE),
            max = max(PctCov, na.rm = TRUE)) 

# why are there any rows with NA cover
DataBase %>%
  ungroup() %>%
  filter(is.na(PctCov)) %>%
  select(Site, Plot) %>%
  distinct()

DataBase %>% 
  filter(Plot == "FIA_1976", #Original.Plot number == 24023611010478
         !is.na(PctCov)) # all NA for this plot

# drop this FIA plot with all NAs for cover
DataBase <- DataBase %>%
  filter(Original.Plot != "24023611010478")

DataBase %>%
  filter(is.na(PctCov)) %>%
  nrow()

## sampled area has some weird values (-40 (Fixed), and 0 (from NPS, substituting info for NA))
DataBase %>% 
  ungroup() %>% 
  select(Dataset, PlotArea.m2, Plot) %>% 
  distinct() %>% 
  filter(PlotArea.m2 == 0) %>%
  group_by(Dataset, PlotArea.m2) %>%
  count(Plot) %>%
  nrow()

range(DataBase$PlotArea.m2)
range(DataBase$PlotArea.m2, na.rm = T)
## 38 plots from NPS with zeros.

DataBase %>% 
  ungroup() %>% 
  select(Dataset, PlotArea.m2, Plot) %>% 
  distinct() %>% 
  filter(is.na(PlotArea.m2)) %>%
  group_by(Dataset) %>%
  count()

# substitutes SampledArea of zero per NA (38plots from NPS)
DataBase <- DataBase %>% 
  mutate(PlotArea.m2 = ifelse(PlotArea.m2 == 0, NA, PlotArea.m2))

nrow(DataBase)
```

# Quality checks done by Kristen

-   One spp per year per plot (via SpCode)

```{r}
duplicates <- DataBase %>% # time consuming
  group_by(Dataset, Plot, SpCode, Year) %>% 
  summarise(n_obs = n()) %>% 
  filter(n_obs > 1)
table(duplicates$Dataset)
## there are species codes with NA, let's filter that

duplicatesNA <- duplicates %>% filter(is.na(SpCode))
table(duplicatesNA$Dataset)

# Description of what was happening before I had fix some of the below issues
# for the following datasets, the issue is only with NAs:
## CVS, FIA, NPS, WVNHP; all others have some duplicated code as well

# NA issue --> the code above includes all NAs. NA in the SpCode column mean different morphotypes identified in the field but without respective plant id. Specificity by dataset with respect to NAs are as follows:
## AIM: had species codes that did not match PLANTS and no associated original species name was found
## CVS, WNHP, VNHP: the "NOMATCH" species code did not carry through. I will use code from Kristen and modified by Eve to fix this or fix my code above to keep them (maybe easier)
## FIA: the multiple NAs refer to species that there was no original species name, but they had a particular species code associated to them. [Maybe fix the code above and use the same structure to the entire dataset, so it doesn't get erased]

# after fixing the above, there are still instances were multiple NAs are found in IL_CTAP and NWCA
# IL_CTAP --> those are entries with unidentified species, so there is no associated SpCode
# NWCA --> those are entries with unidentified species, so there is no associated SpCode. BUT, I also noticed that I have a ton of species within plots with zero pct cover associated to them. 

duplicatesNoNA <- duplicates %>% filter(!is.na(SpCode))
## duplicate codes are still showing up in AIM, and IL_CTAP because different original species names got the same accepted species name and symbol --> this issue is fixed in the code below
table(duplicatesNoNA$Dataset)


# manually fix some inconsistencies I found in the datasets
DataBase <- DataBase %>% 
  mutate(#fixes error in VNHP
         AcceptedTaxonName = ifelse(Original.TaxonName == "Galium circaezans" & SpCode=="GABO2", 
                                      "Galium circaezans", AcceptedTaxonName),
         SpCode = ifelse(Original.TaxonName == "Galium circaezans" & SpCode=="GABO2", "GACI2", SpCode),
         
         #Fixes errors in NPS
         AcceptedTaxonName = ifelse(Original.TaxonName == "Galium circaezans" & SpCode=="GACIC", 
                                      "Galium circaezans var. circaezans", AcceptedTaxonName),
         
         AcceptedTaxonName = ifelse(Original.TaxonName == "Galium circaezans" & SpCode=="GACIH", 
                                      "Galium circaezans var. hypomalacum", AcceptedTaxonName),
         
         AcceptedTaxonName = ifelse(Original.TaxonName == "Euthamia graminifolia" & SpCode=="EUCA26", 
                                      "Euthamia graminifolia", AcceptedTaxonName),
         SpCode = ifelse(Original.TaxonName == "Euthamia graminifolia" & SpCode=="EUCA26", "EUGR5", SpCode),
         
         #fixes error in NEON
         AcceptedTaxonName = ifelse(Original.TaxonName == "Eupatorium capillifolium (Lam.) Small" & SpCode=="EUCA26", 
                                      "Eupatorium capillifolium", AcceptedTaxonName),
         SpCode = ifelse(Original.TaxonName == "Eupatorium capillifolium (Lam.) Small" & SpCode=="EUCA26", "EUCA5", SpCode)) 

# DataBase2 <- DataBase %>% # time consuming
#   # Fix issues of duplicate SpCode in AIM, IL_CTAP, NEON, VNHP 
#   group_by(Dataset, Site, Original.Site, 
#            Plot, Original.Plot, Long, Lat, Original.Long, Original.Lat,
#            Year, FuzzedCoord, RecordedStrata, PlotArea.m2, Zone, NativeStatus, AcceptedTaxonName, 
#            Duration, Growth.Habit, SpCode, SamplingMethod) %>% 
#   dplyr::summarize(PctCov = ifelse(!is.na(SpCode), sum(PctCov, na.rm=TRUE), PctCov), # this is the column I need to sum
#                    PctCov_100 = ifelse(!is.na(SpCode), sum(PctCov_100, na.rm=TRUE), PctCov_100), # this is the column I need to sum
#             Original.TaxonName = ifelse(!is.na(SpCode), dplyr::first(Original.TaxonName), Original.TaxonName)) %>% 
#   ungroup() %>% 
#   distinct()

# alternative try
# Fix issues of duplicate SpCode
DataBase <- DataBase %>% 
  group_by(Dataset, Plot, SpCode, Year) %>% 
  mutate(PctCovnew=ifelse(!is.na(SpCode), sum(PctCov, na.rm=TRUE), PctCov),
         PctCov_100new=ifelse(!is.na(SpCode), sum(PctCov_100, na.rm=TRUE), PctCov_100),
         Original.TaxonNamenew = ifelse(!is.na(SpCode), dplyr::first(Original.TaxonName), Original.TaxonName),
         SpCode.Originalnew = ifelse(!is.na(SpCode), dplyr::first(SpCode.Original), SpCode.Original)) %>% 
  ungroup() %>% 
  select(-PctCov_100, -PctCov, -Original.TaxonName, -SpCode.Original) %>% distinct() %>% 
  rename(PctCov_100=PctCov_100new, PctCov=PctCovnew, Original.TaxonName=Original.TaxonNamenew, SpCode.Original=SpCode.Originalnew)

nrow(DataBase)

DataBase %>%  # time consuming
  group_by(Dataset, Plot, SpCode, Year) %>% 
  dplyr::summarise(n_obs = n()) %>% 
  filter(!is.na(SpCode)) %>% 
  filter(n_obs > 1)
  
```

-   One spp per year per plot (via Original.TaxonName)

```{r}
duplicates <- DataBase %>% # time consuming
  group_by(Dataset, Plot, SpCode, Original.TaxonName, Year) %>% 
  filter(!is.na(Original.TaxonName)) %>% 
  summarise(n_obs = n()) %>% 
  filter(n_obs > 1)
table(duplicates$Dataset)

# these duplicates are already present in the original datasets, assuming the ones who identified them that each entry is a different morphotype, and potentially a distinct species
```

-   NA for Original.TaxonName

```{r}
MissingOrigName<-DataBase %>% 
  filter(is.na(Original.TaxonName)) %>% 
  select(Dataset, Original.TaxonName, SpCode) %>% 
  group_by(Dataset, Original.TaxonName, SpCode) %>% 
  summarise(n_obs = n())
table(MissingOrigName$Dataset)

## AIM, FIA and NPS ==> total of 14517 observations with no OriginalSpeciesName and SpCpde associated to them. My understand is that they represent unknown species (NEON, for instance had a written of "Unknown Plant" for those, that's why it's not showing up in this summary)

## CVS (15), FIA (510), NPS (793) ==> observations in which OriginalSpeciesName is missing(NA) but there is no associated OriginalSpeciesNames. For FIA, all the species codes don't have any associated OriginalSpeciesName from the data I got from Jeff Corbin. For NPS, most of the species codes have associated OriginalSpeciesName in other plots, but quite frequently associated to more than one. For CVS, is the same case as NPS, but more than one OriginalSpeciesName is frequently associated to a SpCode, so I won't fix.

## LP decision: not changing OriginalSpeciesName, but we're aware of the gaps.

```


- weird commas where they shouldn't be

```{r}
# Growth.Habit
## there is a "Shrub," category
unique(DataBase$Growth.Habit)

## fixing it:
DataBase$Growth.Habit <- gsub("\\Shrub\\,\\s$", "Shrub", DataBase$Growth.Habit, ignore.case = FALSE)
unique(DataBase$Growth.Habit)

# Duration
## there is AN instead of Annual
unique(DataBase$Duration)

## Fixing it
DataBase <- DataBase %>% 
  mutate(Duration = str_replace(Duration, "\\sAN$", " Annual"))
unique(DataBase$Duration)

nrow(DataBase)
```

- checking for multiple duration and/or growth forms for a particular AcceptedTaxonName [Helen]

```{r}
## unique species
no.syn <- DataBase %>%
  select(SpCode, AcceptedTaxonName, Duration, Growth.Habit) %>%
  distinct()
anyDuplicated(no.syn$AcceptedTaxonName)

haveDup <- no.syn %>%
  group_by(AcceptedTaxonName) %>%
  count() %>%
  filter(n > 1) #only one species

haveDup2 <- no.syn %>%
  group_by(SpCode) %>%
  count() %>%
  filter(n > 1) #same species

no.syn %>%
  filter(AcceptedTaxonName %in% haveDup$AcceptedTaxonName) %>%
  arrange(AcceptedTaxonName)

GCobs <- DataBase %>% 
  filter(AcceptedTaxonName %in% haveDup$AcceptedTaxonName,
         Growth.Habit == "Forb/herb, Subshrub")
table(GCobs$Growth.Habit) # Galium circaezans

# not sure why this is happening as tax file has a single associated growth habit for this spp. Fixing manually the issue
DataBase <- DataBase %>% 
  mutate(Growth.Habit = ifelse(SpCode == "GACI2", "Subshrub, Forb/herb", Growth.Habit),
         #also fixes the issue with a particular species code that always get switched to date
         SpCode = ifelse(SpCode == "7-Feb", "FEBR7", SpCode))

#checking if it worked
DataBase %>%
  select(SpCode, AcceptedTaxonName, Duration, Growth.Habit) %>%
  distinct() %>%
  filter(AcceptedTaxonName %in% haveDup$AcceptedTaxonName) %>%
  arrange(AcceptedTaxonName) # None! This was the species giving trouble, now there is a single obs
nrow(DataBase)

```

-   rechecking percent cover again

```{r}
range(DataBase$PctCov)
# why zeros?
DataBase %>% filter(PctCov==0) %>% nrow()
DataBase %>% filter(PctCov==0) %>% distinct(Dataset)
# write a file that contain those plots per dataset with zero percent cover
# DataBase %>% filter(PctCov==0) %>% group_by(Plot) %>% add_tally() %>% distinct(Dataset, Plot,n) %>% write_csv("ZeroPctCover.csv")
missing = DataBase %>% filter(PctCov==0) %>% group_by(Plot) %>% add_tally() %>% distinct(Dataset, Plot,n)

#removes observations with zero percent cover.
DataBase <- DataBase %>% 
  filter(PctCov!=0)

DataBase %>%
  group_by(Dataset) %>%
  summarize(min = min(PctCov, na.rm = TRUE),
            mean = mean(PctCov, na.rm = TRUE),
            max = max(PctCov, na.rm = TRUE),
            min100 = min(PctCov_100, na.rm = TRUE),
            mean100 = mean(PctCov_100, na.rm = TRUE),
            max100 = max(PctCov_100, na.rm = TRUE)) 

nrow(DataBase)
```

-  RecordedStrata terminology

```{r}
#checking which are the categories and by dataset
table(DataBase$RecordedStrata, exclude=NULL)
DataBase %>% group_by(Dataset, RecordedStrata) %>% summarise(nobs = n())

# fixing the NAs and changing them to N [No]
# this might not make sense
DataBase <- DataBase %>% mutate(RecordedStrata = ifelse(is.na(RecordedStrata), "IntegratedBySource", RecordedStrata))

DataBase %>% filter(RecordedStrata=="Y") %>% summarise(max = max(PctCov))
DataBase %>% filter(RecordedStrata=="N") %>% summarise(max = max(PctCov)) # does NOT exceeds 100% YAY!!!!!
DataBase %>% filter(RecordedStrata=="N", PctCov > 100) %>% nrow()
DataBase %>% filter(RecordedStrata=="N", PctCov > 100) %>% distinct(Dataset) 
DataBase %>% filter(RecordedStrata=="Y", PctCov > 100) %>% distinct(Dataset) 

#when combining strata & genus within plot, ids until genus only can have more than 100% because each genus can have up to 100% each
DataBase %>% filter(PctCov > 100) %>% nrow() # 460 observations in which PctCover for a taxon per plot is >100%

SppLargeCov <- DataBase %>% filter(PctCov > 100) %>% select(AcceptedTaxonName) %>% distinct() %>% arrange(AcceptedTaxonName)
# one observation is Genus (CRATA) --> WNHP
# other two are unknowns --> NPS

ObsLargeCov <- DataBase %>% filter(PctCov > 100)
# checked the observation with CRATA in MERI.5 in the source data. The genus was present in three strata, none of each exceeding 100%
# checked the NPS unknowns in the source data, and they are already recorded as more than 100% cover.

```

-   creating a Resampled column.

```{r}
#creates a list of plots there were resampled
ResampledList<-DataBase %>%
  ungroup() %>%
  select(Plot, Year) %>%
  distinct() %>%
  group_by(Plot) %>% 
  count(Plot, sort = T) %>% 
  filter(n>1) %>% 
  select(-n) %>% 
  mutate(Resampled = "Y") %>% 
  distinct()

#adds a column to the database with the resampled code
DataBase <- DataBase %>%
  ungroup() %>% 
  left_join(ResampledList, by = "Plot") %>% 
  mutate(Resampled = ifelse(is.na(Resampled), "N", Resampled))

DataBase %>% ungroup() %>% filter(Resampled=="Y") %>% distinct(Plot) %>% nrow()
nrow(ResampledList)
nrow(DataBase)
```

- creating a Sampling method column.

```{r}

DataBase %>% 
  select(Dataset, SamplingMethod) %>% 
  count(Dataset, SamplingMethod) 

DataBase %>% 
  select(Dataset, PlotArea.m2) %>% 
  count(Dataset, PlotArea.m2) %>% ##missing plot area for 64426 NPS observations and 2751 WVNHP observations
  filter(is.na(PlotArea.m2))

# fix SamplingMethod  
DataBase <- DataBase %>%
  mutate(SamplingMethod = ifelse(is.na(SamplingMethod) & Dataset == "AIM", "Circular plots",
                                 ifelse(is.na(SamplingMethod) & Dataset == "FIA", "Circular plots in a fixed pattern",
                                        ifelse(is.na(SamplingMethod) & Dataset == "IL_CTAP", "Transect",
                                               ifelse(is.na(SamplingMethod) & Dataset == "NPS", "Square or rectangle plot",
                                                      ifelse(is.na(SamplingMethod) & Dataset == "NWCA", "Square plot", 
                                                             ifelse(is.na(SamplingMethod) & Dataset == "NEON"|
                                                                     is.na(SamplingMethod) & Dataset == "CVS", "Nested plots", SamplingMethod)))))))

# check again
DataBase %>% 
  select(Dataset, SamplingMethod) %>% 
  count(Dataset, SamplingMethod) 

# another check min and max values of cover per dataset
DataBase %>%
  group_by(Dataset) %>%
  mutate(
    MaxPctCover = max(PctCov, na.rm = T),
    MinPctCover = min(PctCov, na.rm = T),
    ) %>%
  select(Dataset, MaxPctCover, MinPctCover) %>% 
  distinct() %>% 
  arrange(Dataset)


#summary of how many plots per dataset the original sampled area couldn't be retrieved.
DataBase %>% 
  filter(is.na(PlotArea.m2)) %>% 
  select(Dataset, Plot) %>% 
  distinct() %>% 
  count(Dataset)
```

Creates Relative cover column
```{r}
# check number of observations I start with
# dim(DataBase) 
# 
# DataBase<-DataBase %>% 
#   group_by(Dataset, Site, Plot, Long, Lat) %>%
#   mutate(TotalPctCover = sum(PctCov)) %>% 
#   ungroup() %>% 
#   mutate(RelCov = (PctCov/TotalPctCover)*100)
# 
# # is the final result the same?
# dim(DataBase) 
```

# Fixes reviewers comments Aug/Sep 2022
```{r}
# R1: Column "SamplingMethod" in the plot table has duplicate labels for 'Circular plot / Circular plots' and 'Nested plot / Nested plots'

DataBase <- DataBase %>% 
  mutate(SamplingMethod = ifelse(SamplingMethod=="Circular plots", "Circular plot",
                                 ifelse(SamplingMethod=="Nested plots", "Nested plot", SamplingMethod)))
```


# Creating the FULL Database

Full database with original Lat/Long info and rare species
```{r}
FULLDatabase <- DataBase %>%
  select(one_of(DesiredColumns))
glimpse(FULLDatabase)
```

## Exporting the FULL Database

```{r echo=TRUE}
write_rds(FULLDatabase, "/home/shares/neon-inv/data_paper/final_data/FULLDatabase_05272022.rds")
write_csv(FULLDatabase, "/home/shares/neon-inv/data_paper/final_data/FULLDatabase_05272022.csv")
```

# Creating Database

## Desired columns for SPCIS Database

Columns to carry forward in combined SPCIS dataset

```{r}
DesiredColumns2 <- c("Dataset", "Site", "Original.Site",
                    "Plot", "Original.Plot", "Long", "Lat","FuzzedCoord", "Zone",
                    "Year", "SpCode", "AcceptedTaxonName", "Original.TaxonName", 
                    "NativeStatus", "Duration", "GrowthHabit",
                    "PctCov", "PctCov_100", "RecordedStrata", "PlotArea.m2", "SamplingMethod", "Resampled"
                    )

```

### Selecting columns and dealing with plots with rare species

```{r}
# removes species names and codes but keep them in the plot

AIMALLrarespp <- read_excel("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_AIM/FINAL_National_SSS_List_November_21_2019.xlsx", sheet = "Update_2019_FINAL")
glimpse(AIMALLrarespp) 

# Select necessary columns for the filtering
AIMALLrarespp <- AIMALLrarespp %>% 
  select(Taxon, 
         ScientificName = `Scientific Name`, 
         ScientificNameSynonym = `Scientific Name Synonym`, 
         ListingStatus = `Listing Status`) 

AIMALLraresppSyn <- AIMALLrarespp %>% 
  select(ScientificNameSynonym) %>% 
  drop_na()

# How many rare species in AIM?
AIMrarespp <- DataBase %>%
  filter(Dataset == "AIM") %>%
  select(SpCode, AcceptedTaxonName, Original.TaxonName) %>%
  filter(AcceptedTaxonName %in% AIMALLrarespp$ScientificName) %>% 
  distinct()
glimpse(AIMrarespp)

AIMrarespp2 <- DataBase %>%
  filter(Dataset == "AIM") %>%
  select(SpCode, AcceptedTaxonName, Original.TaxonName) %>%
  filter(AcceptedTaxonName %in% AIMALLraresppSyn$ScientificNameSynonym) %>% 
  distinct()
glimpse(AIMrarespp2)

AIMrarespp3 <- DataBase %>%
  filter(Dataset == "AIM") %>%
  select(SpCode, AcceptedTaxonName, Original.TaxonName) %>%
  filter(Original.TaxonName %in% AIMALLraresppSyn$ScientificNameSynonym) %>% 
  distinct()
glimpse(AIMrarespp3)

AIMrarespp4 <- DataBase %>%
  filter(Dataset == "AIM") %>%
  select(SpCode, AcceptedTaxonName, Original.TaxonName) %>%
  filter(Original.TaxonName %in% AIMALLrarespp$ScientificName) %>% 
  distinct()
glimpse(AIMrarespp4)

finalsAIMrareSpp <- AIMrarespp %>% 
  rbind(AIMrarespp2, AIMrarespp3, AIMrarespp4) %>% 
  distinct() %>% 
  filter(!is.na(SpCode))
glimpse(finalsAIMrareSpp)
## total of 217 endangered/rare species in the AIM database

# so I get the number of plots with at least one of those rare species
AIMplotsrarespp <- DataBase %>%
    filter(Dataset == "AIM") %>%
    group_by(Plot) %>%
    filter(any(SpCode %in% finalsAIMrareSpp$SpCode)) 
length(table(AIMplotsrarespp$Plot)) #6293

## WVNHP rare species list
WVNHPRareSpecies <- read_excel("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_WVNHP/WVNHPRareSpecies.xlsx")
glimpse(WVNHPRareSpecies)
WVNHPRareSpecies<-WVNHPRareSpecies$Original.TaxonName

## VANHP rare species list
VNHPRareSpecies <- read_excel("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_VNHP/VAspeciestoexclude.xlsx")
glimpse(VNHPRareSpecies)

#Filtering out rare species
SPCISDatabase <- DataBase %>% 
  #replaces the species original and accepted names, and species codes for NAs
  mutate(Original.TaxonName1 = replace(Original.TaxonName, Dataset=="AIM" & Original.TaxonName %in% AIMALLrarespp$ScientificName |
                                          Dataset=="AIM" & AcceptedTaxonName %in% AIMALLrarespp$ScientificName, NA),
         SpCode = replace(SpCode, Dataset=="AIM" & Original.TaxonName %in% AIMALLrarespp$ScientificName |
                                          Dataset=="AIM" & AcceptedTaxonName %in% AIMALLrarespp$ScientificName, NA),
         AcceptedTaxonName1 = replace(AcceptedTaxonName, Dataset=="AIM" & Original.TaxonName %in% AIMALLrarespp$ScientificName |
                                          Dataset=="AIM" & AcceptedTaxonName %in% AIMALLrarespp$ScientificName, NA),
         Original.TaxonName1 = replace(Original.TaxonName1, Dataset=="AIM" & Original.TaxonName %in% AIMALLraresppSyn$ScientificNameSynonym |
                                          Dataset=="AIM" & AcceptedTaxonName %in% AIMALLraresppSyn$ScientificNameSynonym, NA),
         SpCode = replace(SpCode, Dataset=="AIM" & Original.TaxonName %in% AIMALLraresppSyn$ScientificNameSynonym |
                                          Dataset=="AIM" & AcceptedTaxonName %in% AIMALLraresppSyn$ScientificNameSynonym, NA),
         AcceptedTaxonName1 = replace(AcceptedTaxonName1, Dataset=="AIM" & Original.TaxonName %in% AIMALLraresppSyn$ScientificNameSynonym |
                                          Dataset=="AIM" & AcceptedTaxonName %in% AIMALLraresppSyn$ScientificNameSynonym, NA)) %>% 
  mutate(Original.TaxonName1 = replace(Original.TaxonName1, Dataset=="WVNHP" & Original.TaxonName %in% WVNHPRareSpecies |  Dataset=="WVNHP" & AcceptedTaxonName %in% WVNHPRareSpecies, NA),
         SpCode = replace(SpCode, Dataset=="WVNHP" & Original.TaxonName %in% WVNHPRareSpecies |  Dataset=="WVNHP" & AcceptedTaxonName %in% WVNHPRareSpecies, NA),
         AcceptedTaxonName1 = replace(AcceptedTaxonName1, Dataset=="WVNHP" & Original.TaxonName %in% WVNHPRareSpecies |  Dataset=="WVNHP" & AcceptedTaxonName %in% WVNHPRareSpecies, NA)) %>%
  mutate(Original.TaxonName1 = replace(Original.TaxonName1, Dataset=="VNHP" & Original.TaxonName %in% WVNHPRareSpecies |  
                                          Dataset=="VNHP" & AcceptedTaxonName %in% WVNHPRareSpecies, NA),
         SpCode = replace(SpCode, Dataset=="VNHP" & Original.TaxonName %in% WVNHPRareSpecies |  
                            Dataset=="VNHP" & AcceptedTaxonName %in% WVNHPRareSpecies, NA),
         AcceptedTaxonName1 = replace(AcceptedTaxonName1, Dataset=="VNHP" & Original.TaxonName %in% WVNHPRareSpecies | 
                                          Dataset=="VNHP" & AcceptedTaxonName %in% WVNHPRareSpecies, NA),
          Original.TaxonName1 = replace(Original.TaxonName1, Dataset=="VNHP" & Original.TaxonName %in% VNHPRareSpecies$SPECIES |  
                                          Dataset=="VNHP" & AcceptedTaxonName %in% VNHPRareSpecies$SPECIES, NA),
         SpCode = replace(SpCode, Dataset=="VNHP" & Original.TaxonName %in% VNHPRareSpecies$SPECIES |  
                            Dataset=="VNHP" & AcceptedTaxonName %in% VNHPRareSpecies$SPECIES, NA),
         AcceptedTaxonName1 = replace(AcceptedTaxonName1, Dataset=="VNHP" & Original.TaxonName %in% VNHPRareSpecies$SPECIES | 
                                          Dataset=="VNHP" & AcceptedTaxonName %in% VNHPRareSpecies$SPECIES, NA)) %>%
  
  select(-Original.TaxonName, -AcceptedTaxonName) %>%
  rename(Original.TaxonName = Original.TaxonName1,
  AcceptedTaxonName = AcceptedTaxonName1) %>%
  rename(GrowthHabit = Growth.Habit) %>% 
  #selects the columns for the final dataset
  dplyr::select(one_of(DesiredColumns2))

# checking if it worked
## AIM
SPCISDatabase %>% 
  filter(Dataset=="AIM" & AcceptedTaxonName %in% AIMALLrarespp$ScientificName) %>% 
  count(AcceptedTaxonName)
SPCISDatabase %>% 
  filter(Dataset=="AIM" & AcceptedTaxonName %in% AIMALLraresppSyn$ScientificNameSynonym) %>% 
count(AcceptedTaxonName)

SPCISDatabase %>% 
  filter(Dataset=="AIM" & Original.TaxonName %in% AIMALLraresppSyn$ScientificNameSynonym) %>% 
  count(Original.TaxonName) 

SPCISDatabase %>% 
  filter(Dataset=="AIM" & Original.TaxonName %in% AIMALLrarespp$ScientificName) %>% 
  count(Original.TaxonName)

## WVNHP
SPCISDatabase %>% 
  filter(Dataset=="WVNHP" & AcceptedTaxonName %in% WVNHPRareSpecies)
SPCISDatabase %>% 
  filter(Dataset=="WVNHP" & Original.TaxonName %in% WVNHPRareSpecies)

## VNHP
SPCISDatabase %>% 
  filter(Dataset=="VNHP" & AcceptedTaxonName %in% WVNHPRareSpecies) %>% 
count(AcceptedTaxonName)
SPCISDatabase %>% 
  filter(Dataset=="VNHP" & Original.TaxonName %in% WVNHPRareSpecies) %>% 
  count(Original.TaxonName) 
SPCISDatabase %>% 
  filter(Dataset=="VNHP" & AcceptedTaxonName %in% VNHPRareSpecies$SPECIES) %>% 
count(AcceptedTaxonName)
SPCISDatabase %>% 
  filter(Dataset=="VNHP" & Original.TaxonName %in% VNHPRareSpecies$SPECIES) %>% 
  count(Original.TaxonName) 

# All worked!!!
```

Creating a final list of Rare Species handled in the DataBase

```{r}
# creating a final list of species removed per dataset
## fixing VNHP
VNHPRareSpecies2 <- VNHPRareSpecies %>% 
  select(SPECIES) %>% 
  left_join(select(tax, Accepted.Symbol, Scientific.Name), by=c("SPECIES"="Scientific.Name")) %>% 
  mutate(Original.TaxonName = SPECIES,
         Dataset = "VNHP") %>% 
  rename(AcceptedTaxonName = SPECIES,
         SpCode = Accepted.Symbol) %>% 
  mutate(AcceptedTaxonName = ifelse(Original.TaxonName == "Boechera serotina", "Arabis serotina", AcceptedTaxonName),
         SpCode = ifelse(Original.TaxonName == "Boechera serotina", "ARSE9", SpCode),
         AcceptedTaxonName = ifelse(Original.TaxonName == "Phemeranthus piedmontanus", NA, AcceptedTaxonName))
## fixing WVNHP
WVNHPRareSpecies2 <- FULLDatabase %>% 
  filter(Dataset=="WVNHP" & AcceptedTaxonName %in% WVNHPRareSpecies, 
  Dataset=="WVNHP" & Original.TaxonName %in% WVNHPRareSpecies) %>% 
  select(Dataset, SpCode, AcceptedTaxonName, Original.TaxonName) %>% 
  distinct()
  
# FINAL
ListRareSpecies <- finalsAIMrareSpp %>% 
  mutate(Dataset = "AIM") %>% 
  rbind(VNHPRareSpecies2, WVNHPRareSpecies2) %>% 
  select(Dataset, everything()) 

# write.csv(ListRareSpecies, "/home/shares/neon-inv/data_paper/final_data/ListRareSpecies_04092022.csv", row.names = F)
```

```{r eval=FALSE, include=FALSE}
#Old code, leaving here in case we need
# SPCISDatabase <- DataBase.fill %>% 
  # group_by(Original.Plot) %>%
  # filter(is.na(OriginalSpeciesName)| # code to keep the plot with NA in the original species name column
  #          !any(OriginalSpeciesName == "Arabis serotina Steele" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Ptilimnium nodosumRose Mathias" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Scirpus ancistrochaetus Schuyler" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Trifolium stoloniferum Muhl. ex Eat." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Isotria medeoloidesPursh Raf." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Spiraea virginiana Britt." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Cypripedium parviflorum Salisb. var. pubescensWilld. Knight" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Cypripedium parviflorum Salisb." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Cypripedium reginae Walt." & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Panax quinquefolius" & Dataset == "WVNHP"),
  #        is.na(OriginalSpeciesName)|
  #          !any(OriginalSpeciesName == "Hydrastis canadensis" & Dataset == "WVNHP")) %>%
  # ungroup()
```

```{r echo=FALSE}
glimpse(SPCISDatabase)
```

- creates the two files as Bethany suggested
```{r}
SPCIS_plant_taxa <- SPCISDatabase %>% 
  select(Plot, Year, SpCode, AcceptedTaxonName, Original.TaxonName, 
         NativeStatus, Duration, GrowthHabit, PctCov, PctCov_100, RecordedStrata) %>% 
  as_tibble()

SPCIS_plots <- SPCISDatabase %>% 
  select(Dataset, Plot, Year, Original.Plot, Site, Original.Site, Long, Lat, FuzzedCoord, Zone, PlotArea.m2, SamplingMethod, Resampled) %>%
  mutate(Long = ifelse(Plot == "008-01-0003", -82.76464, Long),
         Lat = ifelse(Plot == "008-01-0003", 35.3971, Lat),
         PlotArea.m2 = ifelse(Plot == "FIA_2099", 673.3363, PlotArea.m2)) %>%
    distinct() %>% 
    as_tibble()

SPCIS_plots %>% group_by(Plot, Year) %>% add_tally() %>% filter(n>1) # no duplicated Plot&year combination

SPCISrecreated <- SPCIS_plant_taxa %>% 
  left_join(SPCIS_plots) 

glimpse(SPCIS_plots)
glimpse(SPCIS_plant_taxa)

dim(SPCISrecreated)

all_equal(SPCISDatabase, SPCISrecreated)

results1 = setdiff(SPCISDatabase, SPCISrecreated) # elements in SPCISDatabase NOT in SPCISrecreated
results2 = setdiff(SPCISrecreated, SPCISDatabase) # elements in SPCISDatabase NOT in SPCISrecreated

#both rows are exactly the same and showing in both dataframes when I search for them. I think it should be ok.

# code to find the differences
# x<-SPCIS_plots %>% 
#   filter(Plot == "FIA_2099")
# glimpse(x)
# # diff(x$PlotArea.m2) #to find which column has differences

nrow(SPCISDatabase) == nrow(SPCISrecreated)
```

## getting NWCA unique species names (Accepted and Original) and finding discrepancies ##
```{r eval=FALSE, include=FALSE}

NWCAspplist <- SPCISrecreated %>% filter(Dataset == "NWCA") %>% select(AcceptedTaxonName, Original.TaxonName) %>% distinct() %>% 
  # a little tweak to find differences
  mutate(Scientific.Name = str_to_lower(Original.TaxonName),
         Scientific.Name = str_to_sentence(Scientific.Name),
         Diff = ifelse(AcceptedTaxonName==Scientific.Name, 0, 1)) %>% 
  group_by(Diff) %>% add_tally() %>% filter(Diff>0 | is.na(Diff)) %>% select(-Scientific.Name) %>% arrange(Diff) %>% write.csv("/home/shares/neon-inv/data_paper/code_by_dataset/extra_csv_NWCA/NomenclatureDiscrepancies_NWCA.csv", row.names = F)


```



### Exporting the SPCIS Database

```{r echo=TRUE}
#plant data
write_rds(SPCIS_plant_taxa, "/home/shares/neon-inv/data_paper/final_data/SPCIS_plant_taxa_05272022.rds")
write_csv(SPCIS_plant_taxa, "/home/shares/neon-inv/data_paper/final_data/SPCIS_plant_taxa_05272022.csv")

#plot data
write_rds(SPCIS_plots, "/home/shares/neon-inv/data_paper/final_data/SPCIS_plots_05272022.rds")
write_csv(SPCIS_plots, "/home/shares/neon-inv/data_paper/final_data/SPCIS_plots_05272022.csv")
```


```{r eval=FALSE, include=FALSE}
# write_rds(SPCISDatabase, "/home/shares/neon-inv/data_paper/final_data/SPCISDatabase_0412022.rds")
# write_csv(SPCISDatabase, "/home/shares/neon-inv/data_paper/final_data/SPCISDatabase_04122022.csv")
```

#### Exporting the SPCIS Database but AIM data only

```{r eval=FALSE, include=FALSE}

SPCISDatabase_AIM <- SPCISDatabase %>% filter(Dataset == "AIM")

# write_rds(SPCISDatabase_AIM, "/home/shares/neon-inv/data_paper/final_data/SPCISDatabase_AIM_01252022.rds")
# write_csv(SPCISDatabase_AIM, "/home/shares/neon-inv/data_paper/final_data/SPCISDatabase_AIM_01252022.csv")
```

# **Summaries**

## Number of records

```{r}
# number of records #
dim(SPCISDatabase) 

SPCISDatabase %>%
  ungroup() %>%
  filter(Zone!="MissingCoords", # no coordinates
         !is.na(Year)) %>% # no year
  nrow() 

#number of records per database
SPCISDatabase %>%
  ungroup() %>%
  count(Dataset) %>%
  mutate(status = "All",
         pct = round((n/sum(n))*100,2))
```

## Plot summaries

```{r}
# number of plots #
SPCISDatabase %>%
  ungroup() %>%
  select(Plot) %>%
  distinct() %>%
  nrow() 

# number of plots with at least one introduced species#
SPCISDatabase %>%
  ungroup() %>%
  filter(NativeStatus=="I") %>%
  select(Plot) %>%
  distinct() %>%
  nrow() 

# number of plots  per Dataset#
SPCISDatabase %>%
  ungroup() %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  mutate(status = "All",
         pct = round((n/sum(n))*100,2))

# number of plots with Fuzzed coordinates
SPCISDatabase %>%
  ungroup() %>%
  select(Plot, FuzzedCoord) %>% 
  distinct() %>%
  count(FuzzedCoord) %>% 
  mutate(plotpct = round((n/sum(n))*100,2))

SPCISDatabase %>%
  ungroup() %>%
  select(Plot, Zone) %>% 
  distinct() %>%
  count(Zone)

# number of plots with no Original sampled Area 
#SPCISDatabase of how many plots per dataset the original sampled area couldn't be retrieved.
SPCISDatabase %>% 
  filter(is.na(PlotArea.m2)) %>% 
  select(Dataset, Plot) %>% 
  distinct() %>% 
  count(Plot)

## how many plots per dataset does not have information on area sampled?
SPCISDatabase %>% 
  filter(is.na(PlotArea.m2)) %>% 
  select(Dataset, Plot) %>% 
  distinct() %>% 
  count(Dataset)

```

```{r echo=FALSE}
x<-SPCISDatabase %>%
  ungroup() %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  mutate(status = "All",
         pct = round((n/sum(n))*100,2))
ggplot(x, aes(x=Dataset, y=n, fill=Dataset)) +
  geom_bar(stat="identity", width=1) +
 # coord_polar("y", start=0)+ 
  scale_fill_viridis_d(option="B") +
  theme_minimal() +
  ylab("number of plots per dataset") + 
  theme(axis.title.x = element_blank()) + 
  theme(legend.position = "none")
```

```{r}
# number of invaded plots per dataset#
SPCISDatabase %>%
  ungroup() %>%
  filter(NativeStatus=="I") %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  rename(invaded = n)
```

```{r echo=FALSE}

library(scales)
# showing pallete of color
show_col(viridis_pal(option = "plasma")(9)) 
inlmisc::GetColors(9, scheme = "muted") # map
inlmisc::GetColors(2, scheme = "light") # graphs

x<-SPCISDatabase %>%
  ungroup() %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  mutate(status = "All",
         pct = round((n/sum(n))*100,2))
# number of invaded plots per dataset#
y<-SPCISDatabase %>%
  ungroup() %>%
  filter(NativeStatus=="I") %>%
  select(Dataset, Plot) %>%
  distinct() %>%
  count(Dataset) %>%
  rename(`at least one introduced species` = n)
xx<-x %>%
  left_join(y) %>%
  mutate(`native only` = n-`at least one introduced species`) %>%
  select(-n, -status) %>%
  gather("status", "n", 3:4)

ggplot(data=xx, aes(x=Dataset, y=n, fill=status)) +
  geom_bar(stat="identity")+
  geom_col() +
  # geom_text(aes(label=n),vjust=-0.3, size=3.5) +
  theme_bw()+
  scale_x_discrete(expand = c(0,0)) +
  scale_y_continuous(breaks=seq(0,27000,5000)) +
  scale_colour_manual(values=c("#77AADD", "#EE8866")) + theme_minimal() +
  ylab("Number of plots") + theme(axis.title.x = element_blank(),
                                  legend.position = c(0.87, 0.87),
                                  legend.title = element_blank(),
                                  legend.background = element_rect(fill = "white", color = "black",
                                                                   size=0.25),
                                  legend.key.size = unit(0.4, "cm"),
                                  legend.text = element_text(size = 10),
                                  panel.grid = element_blank(),
                                  text=element_text(size=15, color="black"),
                                  legend.spacing.y = unit(0, 'pt'))
ggsave("/home/shares/neon-inv/data_paper/figures/GraphInvadedPlotsperDataset05272022.png", dpi=300)
```

```{r}
# number of plots outside L48 #
SPCISDatabase %>%
  ungroup() %>%
  filter(Zone!="L48",
         Zone!="MissingCoords") %>% 
  select(Plot) %>%
  distinct() %>%
  nrow() #530 plots (~0.70% of the total)

SPCISDatabase %>%
  ungroup() %>%
  filter(Zone!="L48",
         Zone!="MissingCoords") %>% # 
  select(Dataset,Plot) %>%
  distinct() %>%
  count(Dataset)
```

## Species and Native status summaries

```{r}
#number of species##
SPCISDatabase %>%
  ungroup() %>%
    select(SpCode) %>%
  distinct() %>%
  nrow()

#number of species per exotic status##
SPCISDatabase %>%
  ungroup() %>%
  select(SpCode, NativeStatus) %>%
  distinct() %>%
  count(NativeStatus) 

#species with NA exotic status per Dataset#
SPCISDatabase %>%
  ungroup() %>%
  select(Dataset, SpCode, NativeStatus) %>%
  filter(is.na(NativeStatus)) %>% # no year
  distinct() %>%
  count(Dataset, NativeStatus) %>%
  arrange(n) 
# number of distinct species with NA per dataset (so, the same species can show up in more than one dataset)

SPCISDatabase %>%
  ungroup() %>%
  select(Dataset, SpCode, NativeStatus) %>%
  distinct() %>%
  count(Dataset, NativeStatus) %>%
  group_by(Dataset) %>%
  mutate(pct = round((n/sum(n))*100,2),
         NativeStatus = ifelse(is.na(NativeStatus), "NA", NativeStatus))
#for VegBank, species with associated NAs for exotic status are around 88% of all species id for VegBank
```

```{r echo=FALSE}
##percent of species exotic status per dataset##
DatasetNA <- SPCISDatabase %>%
  ungroup() %>%
  select(Dataset, SpCode, NativeStatus) %>%
  distinct() %>%
  count(Dataset, NativeStatus) %>%
  group_by(Dataset) %>%
  mutate(pct = round((n/sum(n))*100,2),
         NativeStatus = ifelse(is.na(NativeStatus), "NA", NativeStatus))
#for VegBank, species with associated NAs for exotic status are around 88% of all species id for VegBank

ggplot(data=DatasetNA, aes(x=Dataset, y=pct, fill=NativeStatus)) +
       geom_bar(stat="identity")+
       geom_col() +
       scale_fill_viridis_d(option="B") + theme_minimal() +
  ylab("% of species nativeness status per dataset") + theme(axis.title.x = element_blank(),
                                                         legend.position="bottom")
```

```{r}
## Cover range per dataset
SPCISDatabase %>%
  group_by(Dataset) %>%
  mutate(
    MaxPctCover = max(PctCov, na.rm = T),
    MinPctCover = min(PctCov, na.rm = T),
    ) %>%
  select(Dataset, MaxPctCover, MinPctCover) %>% 
  distinct() %>% 
  arrange(Dataset)

## Cover of invasive species per dataset
rangecover<- SPCISDatabase %>%
  group_by(Dataset, NativeStatus) %>%
  summarize(min = min(PctCov, na.rm = TRUE),
            mean = mean(PctCov, na.rm = TRUE),
            max = max(PctCov, na.rm = TRUE))

## Years of data collection ##
table(SPCISDatabase$Year)
quantile(SPCISDatabase$Year, na.rm = T)

## number of resampled plots
SPCISDatabase %>%
  ungroup() %>%
  select(Plot, Year) %>%
  distinct() %>%
  group_by(Plot) %>% 
  count(Plot, sort = T) %>% 
  filter(n>1) %>% 
  nrow()

## number of per plot per data set
SPCISDatabase %>%
  ungroup() %>%
  select(Dataset,Plot, Year) %>%
  distinct() %>%
  group_by(Dataset, Plot) %>% 
  count(Plot, sort = T) %>% 
  ungroup() %>% 
  filter(n>1) %>% 
  group_by(Dataset) %>% 
  summarize(Max = max(n),
         Mean = mean(n),
         Min = min(n))
  

# why are there any rows with NA cover
SPCISDatabase %>%
  ungroup() %>%
  filter(is.na(PctCov)) %>%
  select(Site, Plot) %>%
  distinct()

```

# **Differences among Datasets**

Defining colors

```{r}
library(viridis)
#finding the color codes to add to the database
viridis_pal(option = "plasma")(9)
inlmisc::GetColors(9, scheme = "muted")

AIMc<-"#CC6677"
CVSc<-"#332288"
FIAc<-"#DDCC77"
IL_CTAPc<-"#117733"
NEONc<-"#88CCEE"
NPSc<-"#882255"
NWCAc<-"#44AA99"
VNHPc<-"#999933"
WNHPc<-"#AA4499"
```

Importing ecoregions level1 (<https://www.epa.gov/eco-research/ecoregions-north-america>)

```{r}
library(sf)
# import the vector into R as an sf object
ecoreg1 <- st_read("/home/shares/neon-inv/data_paper/env_code_data/gis_layers/ecoregionlevel1/NA_CEC_Eco_Level1.shp") %>% rename(Ecoregion = NA_L1NAME)
glimpse(ecoreg1)
```

Joining the ecoregion spatial information

```{r}

SPCIS_plotsMissing <- SPCIS_plots %>% filter(FuzzedCoord == "Missing") %>% mutate(NA_L1CODE=NA, Ecoregion=NA, NA_L1KEY=NA, Shape_Leng=NA, Shape_Area=NA)

SPCIS_plotsEco <- SPCIS_plots %>% 
  filter(FuzzedCoord != "Missing") %>% 
  # getting all data as a sf object
  st_as_sf(coords = c("Long", "Lat"), remove = FALSE, crs = 4326, agr = "constant") %>%
  #sets the same projections
  st_transform(crs = st_crs(ecoreg1)) %>%
  #adds the corresponding ecorregions to each entry
  st_join(ecoreg1) %>%
  #drops the coordinates
  st_drop_geometry() %>% 
  rbind(SPCIS_plotsMissing)

#Full database with ecoregion level 1
write_rds(SPCIS_plotsEco, "/home/shares/neon-inv/data_paper/final_data/SPCIS_plotsEco_05272022.rds")
write_csv(SPCIS_plotsEco, "/home/shares/neon-inv/data_paper/final_data/SPCIS_plotsEco_05272022.csv")
```


```{r}

FULLDatabaseMissing <- FULLDatabase %>% filter(FuzzedCoord == "Missing") %>% mutate(NA_L1CODE=NA, Ecoregion=NA, NA_L1KEY=NA, Shape_Leng=NA, Shape_Area=NA)

FULLDatabaseEco <- FULLDatabase %>% 
  filter(FuzzedCoord != "Missing") %>% 
  # getting all data as a sf object
  st_as_sf(coords = c("Long", "Lat"), remove = FALSE, crs = 4326, agr = "constant") %>%
  #sets the same projections
  st_transform(crs = st_crs(ecoreg1)) %>%
  #adds the corresponding ecorregions to each entry
  st_join(ecoreg1) %>%
  #drops the coordinates
  st_drop_geometry() %>% 
  rbind(FULLDatabaseMissing)

#Full database with ecoregion level 1
write_rds(FULLDatabaseEco, "/home/shares/neon-inv/data_paper/final_data/FULLDatabaseEco_05272022.rds")
write_csv(FULLDatabaseEco, "/home/shares/neon-inv/data_paper/final_data/FULLDatabaseEco_05272022.csv")
```


```{r}
SPCISDatabaseEco <- SPCISDatabase %>% 
  filter(FuzzedCoord != "Missing") %>% 
  group_by(Dataset, Lat, Long, Plot, Year, NativeStatus) %>% 
  summarize(PctCov=sum(PctCov),
            PctCov_100=sum(PctCov_100)) %>% 
  # getting all data as a sf object
  st_as_sf(coords = c("Long", "Lat"), remove = FALSE, crs = 4326, agr = "constant") %>%
  #sets the same projections
  st_transform(crs = st_crs(ecoreg1)) %>%
  #adds the corresponding ecorregions to each entry
  st_join(ecoreg1) %>%
  #drops the coordinates
  st_drop_geometry()

SPCISDatabaseEco %>% select(Ecoregion, Dataset) %>% distinct() %>% group_by(Ecoregion) %>% count() %>% filter(n>1)
```

## Graphs - Non-native cover

```{r}
status <- "I"
# cover <- "PctCov_100" #PctCov

# All Ecoregions at once
SPCISDatabaseEco %>% filter(NativeStatus == status,
                     !is.na(Ecoregion)) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram() + 
  scale_fill_manual(values=c(AIMc, CVSc, FIAc, IL_CTAPc, NEONc, NPSc, NWCAc, VNHPc, WNHPc)) +
  facet_grid(Ecoregion~Dataset, scales="free_y") + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") +
  ggsave('figures/AllEcoregionsNN.png', dpi = 300)

table(SPCISDatabaseEco$Ecoregion)

# EASTERN TEMPERATE FORESTS
graph1I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "EASTERN TEMPERATE FORESTS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(CVSc, FIAc, IL_CTAPc, NEONc, NPSc, NWCAc, VNHPc, WNHPc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Eastern Temperate Forests") +  
    theme(plot.title = element_text(size = 16, face = "bold")) + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/EasTemFor.png', width = 8, height = 4, dpi = 300)

# GREAT PLAINS
graph2I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "GREAT PLAINS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Great Plains") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/GrePla.png', width = 8, height = 4, dpi = 300)

# MARINE WEST COAST FOREST
graph3I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "MARINE WEST COAST FOREST"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(FIAc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Marine West Coast Forest") +  
    theme(plot.title = element_text(size = 16, face = "bold")) + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black"))
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/MarWesCoaFor.png', width = 8, height = 4, dpi = 300)

# MEDITERRANEAN CALIFORNIA
graph4I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "MEDITERRANEAN CALIFORNIA"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Mediterranean California") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/MedCal.png', width = 8, height = 4, dpi = 300)

# NORTH AMERICAN DESERTS
graph5I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTH AMERICAN DESERTS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("North American Deserts") +  
    theme(plot.title = element_text(size = 16, face = "bold")) + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/NorAmeDes.png', width = 8, height = 4, dpi = 300)

# NORTHERN FORESTS
graph6I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTHERN FORESTS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Northern Forests") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black"))  
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/NorFor.png', width = 8, height = 4, dpi = 300)


# NORTHWESTERN FORESTED MOUNTAINS
graph7I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTHWESTERN FORESTED MOUNTAINS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y")  + 
  ggtitle("Northwestern Forested Mountains") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12))  + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black"))
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/NorForMou.png', width = 8, height = 4, dpi = 300)

# SOUTHERN SEMIARID HIGHLANDS
graph8I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "SOUTHERN SEMIARID HIGHLANDS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Southern Semiarid Highlands")+  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/SouSemHig.png', width = 8, height = 4, dpi = 300)

# TAIGA --> only has NEON as dataset and no invasives - it doesn't work

# TEMPERATE SIERRAS
graph9I<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "TEMPERATE SIERRAS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  ggtitle("Temperate Sierras") +  
    theme(plot.title = element_text(size = 16, face = "bold")) +
  labs(y="Frequency", x = "Introduced Taxa Cover (%)") + 
  theme(legend.position = "none",
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
# ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/TemSie.png', width = 8, height = 4, dpi = 300)

# TROPICAL WET FORESTS --> only NWCA, no point of showing

# TUNDRA --> only has NEON as dataset and no invasives - it doesn't work
```




## Graphs - Native cover

```{r}
status <- "N"
# cover <- "PctCov_100" #PctCov

# All Ecoregions at once
SPCISDatabaseEco %>% filter(NativeStatus == status,
                     !is.na(Ecoregion)) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram() + 
  scale_fill_manual(values=c(AIMc, CVSc, FIAc, IL_CTAPc, NEONc, NPSc, NWCAc, VNHPc, WNHPc)) +
  facet_grid(Ecoregion~Dataset, scales="free_y") + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") +
  ggsave('figures/AllEcoregionsN.png', dpi = 300)

table(SPCISDatabaseEco$Ecoregion)

# EASTERN TEMPERATE FORESTS
graph1N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "EASTERN TEMPERATE FORESTS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(CVSc, FIAc, IL_CTAPc, NEONc, NPSc, NWCAc, VNHPc, WNHPc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("Eastern Temperate Forests") +
  ggtitle("") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/EasTemFor.png', width = 8, height = 4, dpi = 300)

# GREAT PLAINS
graph2N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "GREAT PLAINS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("Great Plains") +
  ggtitle("") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/GrePla.png', width = 8, height = 4, dpi = 300)

# MARINE WEST COAST FOREST
graph3N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "MARINE WEST COAST FOREST"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(FIAc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("Marine West Coast Forest") +
  ggtitle("") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black"))
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/MarWesCoaFor.png', width = 8, height = 4, dpi = 300)

# MEDITERRANEAN CALIFORNIA
graph4N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "MEDITERRANEAN CALIFORNIA"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("Mediterranean California") +
  ggtitle("") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/MedCal.png', width = 8, height = 4, dpi = 300)

# NORTH AMERICAN DESERTS
graph5N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTH AMERICAN DESERTS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("North American Deserts") +
  ggtitle("") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black"))
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/NorAmeDes.png', width = 8, height = 4, dpi = 300)

# NORTHERN FORESTS
graph6N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTHERN FORESTS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("Northern Forests") +
  ggtitle("") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/NorFor.png', width = 8, height = 4, dpi = 300)


# NORTHWESTERN FORESTED MOUNTAINS
graph7N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "NORTHWESTERN FORESTED MOUNTAINS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, FIAc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("Northwestern Forested Mountains") +
  ggtitle("") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title = element_blank(),
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black"))
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/NorForMou.png', width = 8, height = 4, dpi = 300)

# SOUTHERN SEMIARID HIGHLANDS
graph8N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "SOUTHERN SEMIARID HIGHLANDS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NEONc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("Southern Semiarid Highlands") +
 ggtitle("") +  
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black")) 
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/SouSemHig.png', width = 8, height = 4, dpi = 300)

# TAIGA --> only has NEON as dataset and no invasives - it doesn't work

# TEMPERATE SIERRAS
graph9N<-SPCISDatabaseEco %>% filter(NativeStatus == status,
                    Ecoregion == "TEMPERATE SIERRAS"
                     ) %>%  
  ggplot(aes(PctCov_100, fill=Dataset), alpha=0.5) + geom_histogram(binwidth = 10) + 
  scale_fill_manual(values=c(AIMc, NPSc, NWCAc)) +
  facet_wrap(~Dataset, scales="free_y") +
  # ggtitle("Temperate Sierras") +
  ggtitle("") +
    theme(plot.title = element_text(size = 16, face = "bold"),
          legend.text = element_text(size = 12)) + 
  labs(y="Frequency", x = "Native Taxa Cover (%)") + 
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        text=element_text(size=20, color="black"))
  # ggsave('/home/shares/neon-inv/data_paper/figures/ecoregionsN/TemSie.png', width = 8, height = 4, dpi = 300)

# TROPICAL WET FORESTS --> only NWCA, no point of showing

# TUNDRA --> only has NEON as dataset and no invasives - it doesn't work


# ##arranging the graphs
# library(cowplot)
# all<-plot_grid(graph1, graph2, graph3, graph4, graph5, graph6, graph7, graph8, graph9, 
#           ncol = 3, nrow = 3,  labels = "AUTO")
# 
# png('/home/shares/neon-inv/data_paper/figures/ecoregionsN/graphcombinedNat05232022.png', width = 1920,height = 1080)
# print(all)
# dev.off()

```


```{r}
##arranging the graphs
library(cowplot)
all1<-plot_grid(graph1I, graph1N, eco1,
                graph2I, graph2N, eco2,
          # labels = c("A", "B", "C", "D", "F"),
          ncol = 3, nrow = 2,  labels = NULL
          )


png('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/graphcombinedEco1_2-05272022.png', width = 1920,height = 1080)
print(all1)
dev.off()

all1<-plot_grid(graph3I, graph3N, eco3,
                graph4I, graph4N, eco4,
          # labels = c("A", "B", "C", "D", "F"),
          ncol = 3, nrow = 2,  labels = NULL
          )


png('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/graphcombinedEco3_4-05272022.png', width = 1920,height = 1080)
print(all1)
dev.off()

all1<-plot_grid(graph5I, graph5N, eco5,
                graph6I, graph6N, eco6,
          # labels = c("A", "B", "C", "D", "F"),
          ncol = 3, nrow = 2,  labels = NULL
          )


png('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/graphcombinedEco5_6-05272022.png', width = 1920,height = 1080)
print(all1)
dev.off()

all1<-plot_grid(graph7I, graph7N, eco7,
                graph8I, graph8N, eco8,
          # labels = c("A", "B", "C", "D", "F"),
          ncol = 3, nrow = 2,  labels = NULL
          )


png('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/graphcombinedEco7_8-05272022.png', width = 1920,height = 1080)
print(all1)
dev.off()

all1<-plot_grid(graph9I, graph9N, eco9,
                # graph8I, graph8N, eco8,
          # labels = c("A", "B", "C", "D", "F"),
          ncol = 3, nrow = 2,  labels = NULL
          )


png('/home/shares/neon-inv/data_paper/figures/ecoregionsNN/graphcombinedEco9-05272022.png', width = 1920,height = 1080)
print(all1)
dev.off()

```